<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Campeonato - Completo</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen p-4">
    <div class="max-w-6xl mx-auto">
        <h1 class="text-3xl font-bold text-center mb-6">Sistema de Campeonato üèÜ</h1>

        <!-- Navega√ß√£o -->
        <div class="flex flex-wrap justify-center gap-2 mb-6">
            <button id="inscricaoBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
                üìù Inscri√ß√µes
            </button>
            <button id="publicoBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg">
                üë• Lista P√∫blica
            </button>
            <button id="adminBtn" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg">
                ‚öôÔ∏è Admin
            </button>
            <button id="acompanharBtn" class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-lg">
                üìä Acompanhar Jogos
            </button>
        </div>

        <!-- Se√ß√£o de Inscri√ß√µes -->
        <section id="inscricaoSection" class="bg-white p-6 rounded-lg shadow mb-6">
            <h2 class="text-xl font-bold mb-4">Nova Inscri√ß√£o</h2>
            <form id="inscricaoForm" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input type="text" id="matricula" placeholder="Matr√≠cula" class="p-2 border rounded-lg" required>
                    <input type="text" id="nome" placeholder="Nome completo" class="p-2 border rounded-lg" required>
                    <input type="text" id="setor" placeholder="Setor" class="p-2 border rounded-lg" required>
                    <input type="tel" id="telefone" placeholder="Telefone" class="p-2 border rounded-lg" required>
                </div>
                <div>
                    <p class="font-semibold mb-2">Escolha suas modalidades:</p>
                    <div id="modalidadesList" class="grid grid-cols-2 md:grid-cols-3 gap-2"></div>
                    <p id="modalidadeInfo" class="text-sm text-gray-500 mt-2"></p>
                </div>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg">
                    Enviar Inscri√ß√£o
                </button>
            </form>
        </section>

        <!-- Lista P√∫blica -->
        <section id="publicoSection" class="bg-white p-6 rounded-lg shadow mb-6 hidden">
            <h2 class="text-xl font-bold mb-4">Participantes Inscritos</h2>
            <div id="participantesList"></div>
        </section>

        <!-- Acompanhar Jogos -->
        <section id="acompanharSection" class="bg-white p-6 rounded-lg shadow mb-6 hidden">
            <h2 class="text-xl font-bold mb-4">Acompanhar Campeonato</h2>
            <div id="modalidadesAcompanhar" class="space-y-6"></div>
        </section>

        <!-- √Årea Administrativa -->
        <section id="adminSection" class="bg-white p-6 rounded-lg shadow mb-6 hidden">
            <h2 class="text-xl font-bold mb-4">√Årea Administrativa</h2>
            
            <!-- Tabs do Admin -->
            <div class="flex flex-wrap gap-2 mb-4">
                <button id="configTab" class="bg-gray-600 text-white px-3 py-1 rounded">Configura√ß√µes</button>
                <button id="faseTab" class="bg-gray-400 text-white px-3 py-1 rounded">Gerenciar Fases</button>
                <button id="placarTab" class="bg-gray-400 text-white px-3 py-1 rounded">Placares</button>
                <button id="resetTab" class="bg-gray-400 text-white px-3 py-1 rounded">Reset Campeonato</button>
            </div>

            <!-- Configura√ß√µes -->
            <div id="configContent" class="space-y-4">
                <div>
                    <h3 class="font-semibold mb-2">Gerenciar Modalidades</h3>
                    <div id="adminModalidadesList" class="space-y-2 mb-3"></div>
                    <div class="flex gap-2">
                        <input type="text" id="novaModalidade" placeholder="Nova modalidade" class="flex-1 p-2 border rounded">
                        <button id="addModalidade" class="bg-green-600 text-white px-3 py-2 rounded">Adicionar</button>
                    </div>
                </div>

                <div>
                    <h3 class="font-semibold mb-2">Limite de Modalidades por Participante</h3>
                    <div class="flex gap-2">
                        <input type="number" id="limiteModalidades" min="1" class="p-2 border rounded w-20">
                        <button id="salvarLimite" class="bg-blue-600 text-white px-3 py-2 rounded">Salvar</button>
                    </div>
                </div>

                <div>
                    <h3 class="font-semibold mb-2">Lista Completa de Inscritos</h3>
                    <button id="exportCSV" class="bg-indigo-600 text-white px-4 py-2 rounded mb-3">üì• Exportar CSV</button>
                    <div class="overflow-x-auto">
                        <table class="w-full border text-sm">
                            <thead class="bg-gray-200">
                                <tr>
                                    <th class="border p-2">Matr√≠cula</th>
                                    <th class="border p-2">Nome</th>
                                    <th class="border p-2">Setor</th>
                                    <th class="border p-2">Telefone</th>
                                    <th class="border p-2">Modalidades</th>
                                    <th class="border p-2">A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="adminTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Gerenciar Fases -->
            <div id="faseContent" class="hidden space-y-4">
                <div class="flex gap-2 mb-4">
                    <select id="modalidadeSelect" class="p-2 border rounded flex-1">
                        <option value="">Selecione uma modalidade</option>
                    </select>
                    <button id="criarFase" class="bg-green-600 text-white px-4 py-2 rounded">Criar Nova Fase</button>
                </div>
                <div id="faseAtual"></div>
            </div>

            <!-- Placares -->
            <div id="placarContent" class="hidden space-y-4">
                <div class="flex gap-2 mb-4">
                    <select id="modalidadePlacarSelect" class="p-2 border rounded flex-1">
                        <option value="">Selecione uma modalidade</option>
                    </select>
                </div>
                <div id="jogosPendentes"></div>
            </div>

            <!-- Reset Campeonato -->
            <div id="resetContent" class="hidden space-y-4">
                <div class="bg-red-50 p-4 rounded border border-red-200">
                    <h3 class="font-semibold text-red-800 mb-2">‚ö†Ô∏è Reset do Campeonato</h3>
                    <p class="text-red-700 mb-4">Esta a√ß√£o apagar√° todas as fases, confrontos e placares salvos. Os participantes inscritos ser√£o mantidos.</p>
                    <button id="resetCampeonato" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded">
                        üóëÔ∏è Reset Completo
                    </button>
                </div>
            </div>
        </section>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, deleteDoc, doc, getDoc, setDoc, getDocs, where, writeBatch } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBo8G3ZcWk4EepN0cHdVBtXc7tGOfcw-yg",
            authDomain: "inscricaosinuca.firebaseapp.com",
            projectId: "inscricaosinuca",
            storageBucket: "inscricaosinuca.firebasestorage.app",
            messagingSenderId: "338241576305",
            appId: "1:338241576305:web:288b6124384c6be4f76ad0",
            measurementId: "G-PEDG30FS2R"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Estado da aplica√ß√£o
        let inscritosCache = [];
        let modalidadesCache = [];
        let limiteEscolha = 2;
        let currentSection = 'inscricao';

        // Elementos DOM
        const inscricaoBtn = document.getElementById("inscricaoBtn");
        const publicoBtn = document.getElementById("publicoBtn");
        const adminBtn = document.getElementById("adminBtn");
        const acompanharBtn = document.getElementById("acompanharBtn");

        const inscricaoSection = document.getElementById("inscricaoSection");
        const publicoSection = document.getElementById("publicoSection");
        const adminSection = document.getElementById("adminSection");
        const acompanharSection = document.getElementById("acompanharSection");

        // Navega√ß√£o entre se√ß√µes
        function showSection(section) {
            // Esconder todas as se√ß√µes
            [inscricaoSection, publicoSection, adminSection, acompanharSection].forEach(s => s.classList.add('hidden'));
            
            // Resetar cores dos bot√µes
            [inscricaoBtn, publicoBtn, adminBtn, acompanharBtn].forEach(btn => {
                btn.className = btn.className.replace('bg-gray-800', 'bg-blue-600').replace('bg-gray-800', 'bg-green-600').replace('bg-gray-800', 'bg-purple-600').replace('bg-gray-800', 'bg-orange-600');
            });

            // Mostrar se√ß√£o selecionada
            switch(section) {
                case 'inscricao':
                    inscricaoSection.classList.remove('hidden');
                    inscricaoBtn.className = inscricaoBtn.className.replace('bg-blue-600', 'bg-gray-800');
                    break;
                case 'publico':
                    publicoSection.classList.remove('hidden');
                    publicoBtn.className = publicoBtn.className.replace('bg-green-600', 'bg-gray-800');
                    carregarListaPublica();
                    break;
                case 'admin':
                    adminSection.classList.remove('hidden');
                    adminBtn.className = adminBtn.className.replace('bg-purple-600', 'bg-gray-800');
                    break;
                case 'acompanhar':
                    acompanharSection.classList.remove('hidden');
                    acompanharBtn.className = acompanharBtn.className.replace('bg-orange-600', 'bg-gray-800');
                    carregarAcompanhamento();
                    break;
            }
            currentSection = section;
        }

        // Event listeners para navega√ß√£o
        inscricaoBtn.addEventListener('click', () => showSection('inscricao'));
        publicoBtn.addEventListener('click', () => showSection('publico'));
        acompanharBtn.addEventListener('click', () => showSection('acompanhar'));
        adminBtn.addEventListener('click', async () => {
            const senha = prompt("Digite a senha do administrador:");
            if (senha === "dpsp123") {
                showSection('admin');
            } else if (senha !== null) {
                alert("Senha incorreta.");
            }
        });

        // Tabs do Admin
        const configTab = document.getElementById("configTab");
        const faseTab = document.getElementById("faseTab");
        const placarTab = document.getElementById("placarTab");
        const resetTab = document.getElementById("resetTab");

        const configContent = document.getElementById("configContent");
        const faseContent = document.getElementById("faseContent");
        const placarContent = document.getElementById("placarContent");
        const resetContent = document.getElementById("resetContent");

        function showAdminTab(tab) {
            // Resetar tabs
            [configTab, faseTab, placarTab, resetTab].forEach(t => {
                t.className = "bg-gray-400 text-white px-3 py-1 rounded";
            });
            [configContent, faseContent, placarContent, resetContent].forEach(c => c.classList.add('hidden'));

            // Mostrar tab selecionada
            switch(tab) {
                case 'config':
                    configTab.className = "bg-gray-600 text-white px-3 py-1 rounded";
                    configContent.classList.remove('hidden');
                    break;
                case 'fase':
                    faseTab.className = "bg-gray-600 text-white px-3 py-1 rounded";
                    faseContent.classList.remove('hidden');
                    carregarModalidadesSelect();
                    break;
                case 'placar':
                    placarTab.className = "bg-gray-600 text-white px-3 py-1 rounded";
                    placarContent.classList.remove('hidden');
                    carregarModalidadesPlacarSelect();
                    break;
                case 'reset':
                    resetTab.className = "bg-gray-600 text-white px-3 py-1 rounded";
                    resetContent.classList.remove('hidden');
                    break;
            }
        }

        configTab.addEventListener('click', () => showAdminTab('config'));
        faseTab.addEventListener('click', () => showAdminTab('fase'));
        placarTab.addEventListener('click', () => showAdminTab('placar'));
        resetTab.addEventListener('click', () => showAdminTab('reset'));

        // Fun√ß√µes de modalidades
        async function carregarModalidades() {
            const snapshot = await getDocs(collection(db, "modalidades"));
            modalidadesCache = [];
            const modalidadesList = document.getElementById("modalidadesList");
            const adminModalidadesList = document.getElementById("adminModalidadesList");
            
            modalidadesList.innerHTML = "";
            adminModalidadesList.innerHTML = "";
            
            snapshot.forEach(docSnap => {
                const modalidade = docSnap.id;
                modalidadesCache.push(modalidade);
                
                // Para inscri√ß√µes
                const label = document.createElement("label");
                label.className = "flex items-center gap-2 p-2 border rounded cursor-pointer hover:bg-gray-50";
                label.innerHTML = `<input type="checkbox" value="${modalidade}" class="rounded"> ${modalidade}`;
                modalidadesList.appendChild(label);
                
                // Para admin
                const div = document.createElement("div");
                div.className = "flex justify-between items-center p-2 border rounded";
                div.innerHTML = `
                    <span>${modalidade}</span>
                    <button class="text-red-600 hover:text-red-800 px-2 py-1" data-modalidade="${modalidade}">üóëÔ∏è</button>
                `;
                div.querySelector("button").addEventListener("click", async (e) => {
                    const modalidade = e.target.getAttribute('data-modalidade');
                    if (confirm(`Tem certeza que deseja excluir a modalidade "${modalidade}"?`)) {
                        await deleteDoc(doc(db, "modalidades", modalidade));
                        carregarModalidades();
                    }
                });
                adminModalidadesList.appendChild(div);
            });
            atualizarInfoModalidades();
        }

        // Adicionar modalidade
        document.getElementById("addModalidade").addEventListener("click", async () => {
            const nome = document.getElementById("novaModalidade").value.trim();
            if (!nome) {
                alert("Digite o nome da modalidade!");
                return;
            }
            
            try {
                await setDoc(doc(db, "modalidades", nome), { criado_em: new Date().toISOString() });
                document.getElementById("novaModalidade").value = "";
                carregarModalidades();
                alert("Modalidade adicionada com sucesso!");
            } catch (error) {
                alert("Erro ao adicionar modalidade!");
            }
        });

        // Limite de modalidades
        async function carregarLimite() {
            const snap = await getDoc(doc(db, "config", "limite"));
            if (snap.exists()) {
                limiteEscolha = snap.data().valor;
                document.getElementById("limiteModalidades").value = limiteEscolha;
            }
            atualizarInfoModalidades();
        }

        document.getElementById("salvarLimite").addEventListener("click", async () => {
            const valor = parseInt(document.getElementById("limiteModalidades").value);
            if (valor > 0) {
                limiteEscolha = valor;
                await setDoc(doc(db, "config", "limite"), { valor });
                atualizarInfoModalidades();
                alert("Limite atualizado com sucesso!");
            } else {
                alert("Digite um valor v√°lido!");
            }
        });

        function atualizarInfoModalidades() {
            document.getElementById("modalidadeInfo").textContent = `Voc√™ pode escolher at√© ${limiteEscolha} modalidade(s).`;
        }

        // Inscri√ß√µes
        document.getElementById("inscricaoForm").addEventListener("submit", async (e) => {
            e.preventDefault();
            
            const matricula = document.getElementById("matricula").value.trim();
            const nome = document.getElementById("nome").value.trim();
            const setor = document.getElementById("setor").value.trim();
            const telefone = document.getElementById("telefone").value.trim();
            
            const escolhidas = Array.from(document.querySelectorAll("#modalidadesList input:checked")).map(c => c.value);
            
            if (!matricula || !nome || !setor || !telefone) {
                alert("Preencha todos os campos obrigat√≥rios!");
                return;
            }
            
            if (escolhidas.length === 0 || escolhidas.length > limiteEscolha) {
                alert(`Escolha entre 1 e ${limiteEscolha} modalidades.`);
                return;
            }
            
            // Verificar se matr√≠cula j√° existe
            const qMatricula = query(collection(db, "inscritos"), where("matricula", "==", matricula));
            const snapshot = await getDocs(qMatricula);
            if (!snapshot.empty) {
                alert("Essa matr√≠cula j√° est√° inscrita!");
                return;
            }
            
            try {
                await addDoc(collection(db, "inscritos"), {
                    matricula,
                    nome,
                    setor,
                    telefone,
                    modalidades: escolhidas,
                    criado_em: new Date().toISOString()
                });
                
                alert("Inscri√ß√£o realizada com sucesso!");
                document.getElementById("inscricaoForm").reset();
                carregarModalidades(); // Recarregar para limpar checkboxes
            } catch (error) {
                alert("Erro ao realizar inscri√ß√£o!");
            }
        });

        // Carregar lista p√∫blica
        function carregarListaPublica() {
            const participantesList = document.getElementById("participantesList");
            participantesList.innerHTML = '<div class="text-center text-gray-500">Carregando...</div>';
            
            const q = query(collection(db, "inscritos"), orderBy("criado_em", "desc"));
            onSnapshot(q, (snapshot) => {
                participantesList.innerHTML = "";
                inscritosCache = [];
                
                if (snapshot.empty) {
                    participantesList.innerHTML = '<div class="text-center text-gray-500">Nenhum participante inscrito ainda.</div>';
                    return;
                }
                
                snapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    inscritosCache.push({ id: docSnap.id, ...data });
                    
                    const div = document.createElement("div");
                    div.className = "p-3 border rounded-lg shadow-sm hover:shadow-md transition-shadow";
                    div.innerHTML = `
                        <h3 class="font-semibold text-lg">${data.nome}</h3>
                        <p class="text-gray-600">${data.setor}</p>
                        <p class="text-sm text-blue-600 mt-1">
                            <span class="font-medium">Modalidades:</span> ${data.modalidades.join(", ")}
                        </p>
                    `;
                    participantesList.appendChild(div);
                });
                
                // Atualizar tabela admin se estiver na se√ß√£o admin
                if (currentSection === 'admin') {
                    atualizarTabelaAdmin();
                }
            });
        }

        // Atualizar tabela admin
        function atualizarTabelaAdmin() {
            const tbody = document.getElementById("adminTableBody");
            tbody.innerHTML = "";
            
            inscritosCache.forEach(inscrito => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td class="border p-2">${inscrito.matricula}</td>
                    <td class="border p-2">${inscrito.nome}</td>
                    <td class="border p-2">${inscrito.setor}</td>
                    <td class="border p-2">${inscrito.telefone}</td>
                    <td class="border p-2">${inscrito.modalidades.join(", ")}</td>
                    <td class="border p-2 text-center">
                        <button class="text-red-600 hover:text-red-800 px-2 py-1" data-id="${inscrito.id}">üóëÔ∏è</button>
                    </td>
                `;
                
                tr.querySelector("button").addEventListener("click", async (e) => {
                    const id = e.target.getAttribute('data-id');
                    const inscrito = inscritosCache.find(i => i.id === id);
                    
                    if (confirm(`Tem certeza que deseja excluir ${inscrito.nome}?`)) {
                        const senha = prompt("Digite a senha para confirmar:");
                        if (senha === "dpsp123") {
                            await deleteDoc(doc(db, "inscritos", id));
                        } else if (senha !== null) {
                            alert("Senha incorreta!");
                        }
                    }
                });
                
                tbody.appendChild(tr);
            });
        }

        // Exportar CSV
        document.getElementById("exportCSV").addEventListener("click", () => {
            if (inscritosCache.length === 0) {
                alert("Nenhum inscrito para exportar!");
                return;
            }
            
            let csv = "Matr√≠cula,Nome,Setor,Telefone,Modalidades\n";
            inscritosCache.forEach(inscrito => {
                csv += `"${inscrito.matricula}","${inscrito.nome}","${inscrito.setor}","${inscrito.telefone}","${inscrito.modalidades.join(" | ")}"\n`;
            });
            
            const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "inscritos_campeonato.csv";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });

        // Carregar modalidades para selects
        function carregarModalidadesSelect() {
            const select = document.getElementById("modalidadeSelect");
            select.innerHTML = '<option value="">Selecione uma modalidade</option>';
            
            modalidadesCache.forEach(modalidade => {
                const option = document.createElement("option");
                option.value = modalidade;
                option.textContent = modalidade;
                select.appendChild(option);
            });
        }

        function carregarModalidadesPlacarSelect() {
            const select = document.getElementById("modalidadePlacarSelect");
            select.innerHTML = '<option value="">Selecione uma modalidade</option>';
            
            modalidadesCache.forEach(modalidade => {
                const option = document.createElement("option");
                option.value = modalidade;
                option.textContent = modalidade;
                select.appendChild(option);
            });
        }

        // Gerenciamento de fases
        document.getElementById("criarFase").addEventListener("click", async () => {
            const modalidade = document.getElementById("modalidadeSelect").value;
            if (!modalidade) {
                alert("Selecione uma modalidade!");
                return;
            }
            
            if (confirm(`Criar nova fase para ${modalidade}?`)) {
                await criarNovaFase(modalidade);
            }
        });

        async function criarNovaFase(modalidade) {
            try {
                // Buscar participantes da modalidade
                const participantes = inscritosCache.filter(i => i.modalidades.includes(modalidade));
                
                if (participantes.length < 2) {
                    alert("√â necess√°rio pelo menos 2 participantes para criar uma fase!");
                    return;
                }
                
                // Verificar se j√° existe uma fase ativa
                const fasesQuery = query(
                    collection(db, "fases"), 
                    where("modalidade", "==", modalidade),
                    where("ativa", "==", true)
                );
                const fasesSnapshot = await getDocs(fasesQuery);
                
                let numeroFase = 1;
                let participantesFase = [...participantes];
                
                if (!fasesSnapshot.empty) {
                    // Existe fase ativa, buscar vencedores da fase anterior
                    const faseAtual = fasesSnapshot.docs[0].data();
                    numeroFase = faseAtual.numero + 1;
                    
                    // Buscar vencedores da fase anterior
                    const vencedoresQuery = query(
                        collection(db, "jogos"),
                        where("modalidade", "==", modalidade),
                        where("fase", "==", faseAtual.numero),
                        where("finalizado", "==", true)
                    );
                    const vencedoresSnapshot = await getDocs(vencedoresQuery);
                    
                    const vencedores = [];
                    vencedoresSnapshot.forEach(doc => {
                        const jogo = doc.data();
                        const vencedor = jogo.placar_p1 > jogo.placar_p2 ? jogo.participante1 : jogo.participante2;
                        const dadosVencedor = inscritosCache.find(p => p.id === vencedor.id);
                        if (dadosVencedor) vencedores.push(dadosVencedor);
                    });
                    
                    if (vencedores.length === 0) {
                        alert("N√£o h√° vencedores da fase anterior!");
                        return;
                    }
                    
                    if (vencedores.length === 1) {
                        alert(`Parab√©ns! ${vencedores[0].nome} √© o campe√£o de ${modalidade}!`);
                        // Finalizar campeonato desta modalidade
                        await finalizarCampeonato(modalidade, vencedores[0]);
                        return;
                    }
                    
                    participantesFase = vencedores;
                    
                    // Se n√∫mero √≠mpar, adicionar um perdedor
                    if (participantesFase.length % 2 === 1) {
                        const perdedoresQuery = query(
                            collection(db, "jogos"),
                            where("modalidade", "==", modalidade),
                            where("fase", "==", faseAtual.numero),
                            where("finalizado", "==", true)
                        );
                        const perdedoresSnapshot = await getDocs(perdedoresQuery);
                        
                        const perdedores = [];
                        perdedoresSnapshot.forEach(doc => {
                            const jogo = doc.data();
                            const perdedor = jogo.placar_p1 < jogo.placar_p2 ? jogo
