<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inscri√ß√µes - Campeonato</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center justify-center p-4">
    <div class="bg-white p-6 rounded-2xl shadow-lg w-full max-w-3xl">
        <h1 class="text-2xl font-bold text-center mb-4 text-purple-700">Campeonato üéÆ</h1>

        <div class="flex flex-col sm:flex-row justify-between mb-4 space-y-2 sm:space-y-0 sm:space-x-2">
            <button id="toggleButton" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors">
                Nova Inscri√ß√£o
            </button>
            <button id="adminButton" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition-colors">
                √Årea do ADM
            </button>
        </div>

        <section id="formSection" class="hidden transition-all duration-300">
            <h2 class="text-xl font-bold mb-4 text-center text-gray-700">Formul√°rio de Inscri√ß√£o</h2>
            <form id="registrationForm" class="space-y-4">
                <input type="text" id="matricula" placeholder="Matr√≠cula" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                <input type="text" id="nome" placeholder="Nome completo" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                <input type="text" id="setor" placeholder="Setor" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                <input type="tel" id="telefone" placeholder="Telefone (somente ADM ver√°)" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>

                <div>
                    <p class="font-semibold mb-2 text-gray-700">Escolha suas modalidades:</p>
                    <div id="modalidadesList" class="grid grid-cols-1 sm:grid-cols-2 gap-2"></div>
                    <p id="modalidadeInfo" class="text-xs text-gray-500 mt-1"></p>
                </div>

                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 px-4 rounded-lg font-semibold transition-colors">
                    Enviar Inscri√ß√£o
                </button>
            </form>
        </section>

        <section id="listSection">
            <h2 class="text-xl font-semibold mb-2 text-center text-gray-700">Participantes inscritos</h2>
            <div id="loadingMessage" class="text-gray-500 text-sm text-center">Carregando participantes...</div>
            <div id="participantList" class="space-y-2"></div>
        </section>

        <section id="adminSection" class="hidden transition-all duration-300">
            <h2 class="text-2xl font-bold mb-4 text-center text-gray-700">√Årea do Administrador</h2>
            <div class="space-y-6">
                <!-- Gerenciar Modalidades e Limite -->
                <div class="bg-gray-50 p-4 rounded-lg shadow-sm">
                    <h3 class="font-bold text-lg mb-2 text-gray-700">Gerenciar Configura√ß√µes</h3>
                    <div class="space-y-4">
                        <div>
                            <h4 class="font-semibold text-gray-600 mb-1">Modalidades</h4>
                            <div id="adminModalidadesList" class="space-y-1 mb-2"></div>
                            <div class="flex gap-2">
                                <input type="text" id="novaModalidade" placeholder="Nova modalidade" class="flex-1 p-2 border rounded-lg">
                                <button id="addModalidade" class="bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded-lg">Adicionar</button>
                            </div>
                        </div>

                        <div>
                            <h4 class="font-semibold text-gray-600 mb-1">Limite de Modalidades</h4>
                            <div class="flex gap-2 items-center">
                                <input type="number" id="limiteModalidades" min="1" class="p-2 border rounded-lg w-20">
                                <button id="salvarLimite" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-lg">Salvar</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Gest√£o de Partidas -->
                <div class="bg-gray-50 p-4 rounded-lg shadow-sm">
                    <h3 class="font-bold text-lg mb-2 text-gray-700">Gerenciar Partidas</h3>
                    <div class="space-y-4">
                        <div>
                            <h4 class="font-semibold text-gray-600 mb-1">Criar Nova Fase</h4>
                            <select id="selectModalidade" class="w-full p-2 border rounded-lg">
                                <option value="">Selecione a modalidade</option>
                            </select>
                            <button id="gerarConfrontosButton" class="mt-2 w-full bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-semibold transition-colors">
                                üé≤ Sortear Confrontos
                            </button>
                            <button id="limparTudoButton" class="mt-2 w-full bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded-lg font-semibold transition-colors">
                                ‚ùå Limpar Fases
                            </button>
                        </div>
                        
                        <div>
                            <h4 class="font-semibold text-gray-600 mb-2">Partidas Pendentes</h4>
                            <div id="partidasPendentesList" class="space-y-2"></div>
                        </div>
                    </div>
                </div>

                <!-- Tabela de Inscritos -->
                <div class="bg-gray-50 p-4 rounded-lg shadow-sm">
                    <h3 class="font-bold text-lg mb-2 text-gray-700">Lista Completa de Inscritos</h3>
                    <table class="w-full border text-sm rounded-lg overflow-hidden" id="adminTable">
                        <thead class="bg-gray-200">
                            <tr>
                                <th class="border p-2 text-left">Matr√≠cula</th>
                                <th class="border p-2 text-left">Nome</th>
                                <th class="border p-2 text-left">Setor</th>
                                <th class="border p-2 text-left">Telefone</th>
                                <th class="border p-2 text-left">Modalidades</th>
                                <th class="border p-2 text-center">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="adminTableBody"></tbody>
                    </table>
                    <button id="exportCSV" class="mt-3 bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg font-semibold transition-colors w-full sm:w-auto">
                        üì• Exportar CSV
                    </button>
                </div>
            </div>
        </section>

        <!-- Se√ß√£o de Placar para o P√∫blico -->
        <section id="placarPublico" class="hidden">
            <h2 class="text-xl font-bold mb-2 text-center text-gray-700">Placar do Campeonato</h2>
            <div id="placarList" class="space-y-4"></div>
        </section>

        <!-- Modal de Confirma√ß√£o customizada -->
        <div id="customModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden">
            <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm text-center">
                <p id="modalMessage" class="mb-4 text-gray-800"></p>
                <div class="flex justify-center gap-4">
                    <button id="modalConfirmBtn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg">Confirmar</button>
                    <button id="modalCancelBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-lg">Cancelar</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, deleteDoc, doc, getDoc, setDoc, getDocs, where, writeBatch, updateDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";

        // Enable Firestore debug logging
        setLogLevel('debug');

        // Vari√°veis globais de ambiente
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // UI Elements
        const toggleButton = document.getElementById("toggleButton");
        const adminButton = document.getElementById("adminButton");
        const formSection = document.getElementById("formSection");
        const listSection = document.getElementById("listSection");
        const adminSection = document.getElementById("adminSection");
        const registrationForm = document.getElementById("registrationForm");
        const participantList = document.getElementById("participantList");
        const loadingMessage = document.getElementById("loadingMessage");
        const modalidadesList = document.getElementById("modalidadesList");
        const adminModalidadesList = document.getElementById("adminModalidadesList");
        const novaModalidade = document.getElementById("novaModalidade");
        const addModalidadeBtn = document.getElementById("addModalidade");
        const limiteInput = document.getElementById("limiteModalidades");
        const salvarLimiteBtn = document.getElementById("salvarLimite");
        const modalidadeInfo = document.getElementById("modalidadeInfo");
        const adminTableBody = document.getElementById("adminTableBody");
        const exportCSVBtn = document.getElementById("exportCSV");
        const selectModalidade = document.getElementById("selectModalidade");
        const gerarConfrontosButton = document.getElementById("gerarConfrontosButton");
        const partidasPendentesList = document.getElementById("partidasPendentesList");
        const placarPublico = document.getElementById("placarPublico");
        const placarList = document.getElementById("placarList");
        const limparTudoButton = document.getElementById("limparTudoButton");

        const customModal = document.getElementById("customModal");
        const modalMessage = document.getElementById("modalMessage");
        const modalConfirmBtn = document.getElementById("modalConfirmBtn");
        const modalCancelBtn = document.getElementById("modalCancelBtn");

        let showForm = false;
        let showAdmin = false;
        let limiteEscolha = 2;
        let inscritosCache = [];
        let modalidadesCache = [];

        // Authentication
        if (initialAuthToken) {
            signInWithCustomToken(auth, initialAuthToken).catch(console.error);
        } else {
            signInAnonymously(auth).catch(console.error);
        }

        // Wait for authentication state to be ready before initializing Firestore listeners
        onAuthStateChanged(auth, (user) => {
            if (user) {
                console.log("Usu√°rio autenticado:", user.uid);
                // Inicie os listeners do Firestore aqui
                carregarModalidades();
                carregarLimite();
                setupFirestoreListeners();
            } else {
                console.log("Nenhum usu√°rio autenticado.");
            }
        });


        // Custom Modal Function
        function showCustomModal(message) {
            return new Promise((resolve) => {
                modalMessage.textContent = message;
                customModal.classList.remove("hidden");
                
                const handleConfirm = () => {
                    customModal.classList.add("hidden");
                    resolve(true);
                };

                const handleCancel = () => {
                    customModal.classList.add("hidden");
                    resolve(false);
                };

                modalConfirmBtn.addEventListener("click", handleConfirm, { once: true });
                modalCancelBtn.addEventListener("click", handleCancel, { once: true });
            });
        }

        // Custom password modal
        function showPasswordModal() {
            return new Promise((resolve) => {
                const input = document.createElement('input');
                input.type = 'password';
                input.placeholder = 'Senha do administrador';
                input.className = 'w-full p-2 border rounded-lg mb-4';
                
                modalMessage.textContent = 'Digite a senha do administrador:';
                modalMessage.parentNode.insertBefore(input, modalMessage.nextSibling);

                customModal.classList.remove("hidden");
                
                const handleConfirm = () => {
                    customModal.classList.add("hidden");
                    input.remove();
                    resolve(input.value);
                };

                const handleCancel = () => {
                    customModal.classList.add("hidden");
                    input.remove();
                    resolve(null);
                };

                modalConfirmBtn.addEventListener("click", handleConfirm, { once: true });
                modalCancelBtn.addEventListener("click", handleCancel, { once: true });
            });
        }
        
        // --- Event Listeners ---
        toggleButton.addEventListener("click", () => {
            showForm = !showForm;
            formSection.classList.toggle("hidden", !showForm);
            listSection.classList.toggle("hidden", showForm);
            adminSection.classList.add("hidden");
            placarPublico.classList.add("hidden");
            showAdmin = false;
            toggleButton.textContent = showForm ? "Ver Participantes" : "Nova Inscri√ß√£o";
        });

        adminButton.addEventListener("click", async () => {
            const senha = await showPasswordModal();
            if (senha === "dpsp123") {
                showAdmin = !showAdmin;
                adminSection.classList.toggle("hidden", !showAdmin);
                listSection.classList.toggle("hidden", showAdmin);
                formSection.classList.add("hidden");
                placarPublico.classList.add("hidden");
                showForm = false;
                carregarAdminTable();
                carregarPartidasPendentes();
            } else if (senha !== null) {
                showCustomModal("Senha incorreta.");
            }
        });

        // Adicionar modalidade
        addModalidadeBtn.addEventListener("click", async () => {
            const nome = novaModalidade.value.trim();
            if (!nome) return;
            try {
                const modalidadeDocRef = doc(db, `/artifacts/${appId}/public/data/modalidades`, nome);
                await setDoc(modalidadeDocRef, { criado_em: new Date().toISOString() });
                novaModalidade.value = "";
                showCustomModal("Modalidade adicionada!");
                carregarModalidades();
            } catch (e) {
                console.error("Error adding document: ", e);
                showCustomModal("Erro ao adicionar modalidade.");
            }
        });

        // Salvar limite
        salvarLimiteBtn.addEventListener("click", async () => {
            const valor = parseInt(limiteInput.value);
            if (valor > 0) {
                limiteEscolha = valor;
                try {
                    const configDocRef = doc(db, `/artifacts/${appId}/public/data/config`, "limite");
                    await setDoc(configDocRef, { valor });
                    atualizarInfo();
                    showCustomModal("Limite atualizado!");
                } catch (e) {
                    console.error("Error saving limit: ", e);
                    showCustomModal("Erro ao salvar limite.");
                }
            }
        });

        // Formul√°rio de inscri√ß√£o
        registrationForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            const matricula = document.getElementById("matricula").value.trim();
            const nome = document.getElementById("nome").value.trim();
            const setor = document.getElementById("setor").value.trim();
            const telefone = document.getElementById("telefone").value.trim();

            const escolhidas = Array.from(modalidadesList.querySelectorAll("input:checked")).map(c => c.value);

            if (!matricula || !nome || !setor || !telefone) {
                showCustomModal("Preencha todos os campos!");
                return;
            }

            if (escolhidas.length === 0 || escolhidas.length > limiteEscolha) {
                showCustomModal(`Escolha entre 1 e ${limiteEscolha} modalidades.`);
                return;
            }

            const qMatricula = query(collection(db, `/artifacts/${appId}/public/data/inscritos`), where("matricula", "==", matricula));
            const snapshot = await getDocs(qMatricula);
            if (!snapshot.empty) {
                showCustomModal("Essa matr√≠cula j√° est√° inscrita!");
                return;
            }

            try {
                await addDoc(collection(db, `/artifacts/${appId}/public/data/inscritos`), {
                    matricula,
                    nome,
                    setor,
                    telefone,
                    modalidades: escolhidas,
                    criado_em: new Date().toISOString()
                });
                showCustomModal("Inscri√ß√£o realizada com sucesso!");
                registrationForm.reset();
                carregarModalidades();
                formSection.classList.add("hidden");
                listSection.classList.remove("hidden");
                toggleButton.textContent = "Nova Inscri√ß√£o";
            } catch (err) {
                console.error("Erro:", err);
                showCustomModal("Erro ao salvar.");
            }
        });

        // Exportar CSV
        exportCSVBtn.addEventListener("click", () => {
            if (inscritosCache.length === 0) {
                showCustomModal("Nenhum inscrito para exportar!");
                return;
            }
            let csv = "Matr√≠cula,Nome,Setor,Telefone,Modalidades\n";
            inscritosCache.forEach(e => {
                csv += `"${e.matricula}","${e.nome}","${e.setor}","${e.telefone}","${e.modalidades.join(" | ")}"\n`;
            });
            const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "inscritos.csv";
            a.click();
        });

        // Gerar Confrontos
        gerarConfrontosButton.addEventListener("click", async () => {
            const modalidadeSelecionada = selectModalidade.value;
            if (!modalidadeSelecionada) {
                showCustomModal("Por favor, selecione uma modalidade.");
                return;
            }

            const confirmar = await showCustomModal(`Deseja gerar confrontos para a modalidade "${modalidadeSelecionada}"? Isso ir√° apagar confrontos anteriores.`);
            if (!confirmar) return;

            try {
                // Fetch participants for the selected modality
                const inscritosRef = collection(db, `/artifacts/${appId}/public/data/inscritos`);
                const q = query(inscritosRef, where("modalidades", "array-contains", modalidadeSelecionada));
                const snapshot = await getDocs(q);
                const participantes = [];
                snapshot.forEach(doc => participantes.push(doc.data()));

                if (participantes.length < 2) {
                    showCustomModal("√â necess√°rio no m√≠nimo 2 participantes para gerar confrontos.");
                    return;
                }

                // Shuffle participants
                for (let i = participantes.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [participantes[i], participantes[j]] = [participantes[j], participantes[i]];
                }

                const batch = writeBatch(db);
                const partidasRef = collection(db, `/artifacts/${appId}/public/data/partidas`);

                // Clear existing matches for this modality before adding new ones
                const oldMatchesQuery = query(partidasRef, where("modalidade", "==", modalidadeSelecionada));
                const oldMatchesSnapshot = await getDocs(oldMatchesQuery);
                oldMatchesSnapshot.forEach(doc => {
                    batch.delete(doc.ref);
                });

                // Create new matches
                for (let i = 0; i < participantes.length; i += 2) {
                    const p1 = participantes[i];
                    const p2 = participantes[i + 1] || null;
                    const partidaDocRef = doc(partidasRef);
                    batch.set(partidaDocRef, {
                        modalidade: modalidadeSelecionada,
                        participante1: { nome: p1.nome, id: p1.matricula },
                        participante2: p2 ? { nome: p2.nome, id: p2.matricula } : null,
                        placar1: null,
                        placar2: null,
                        vencedor: null,
                        status: 'pendente',
                        criado_em: new Date().toISOString()
                    });
                }
                await batch.commit();
                showCustomModal("Confrontos gerados com sucesso!");
            } catch (e) {
                console.error("Error generating matches: ", e);
                showCustomModal("Erro ao gerar confrontos.");
            }
        });

        // Limpar tudo
        limparTudoButton.addEventListener("click", async () => {
            const confirmar = await showCustomModal("Deseja realmente apagar todas as fases e placares? Esta a√ß√£o n√£o pode ser desfeita.");
            if (!confirmar) return;

            try {
                const partidasRef = collection(db, `/artifacts/${appId}/public/data/partidas`);
                const inscritosRef = collection(db, `/artifacts/${appId}/public/data/inscritos`);
                
                const batch = writeBatch(db);
                
                // Excluir todas as partidas
                const partidasSnapshot = await getDocs(partidasRef);
                partidasSnapshot.forEach(doc => {
                    batch.delete(doc.ref);
                });

                // Excluir todos os inscritos
                const inscritosSnapshot = await getDocs(inscritosRef);
                inscritosSnapshot.forEach(doc => {
                    batch.delete(doc.ref);
                });

                await batch.commit();
                showCustomModal("Todos os dados de partidas e inscritos foram apagados.");
            } catch (e) {
                console.error("Error cleaning up data: ", e);
                showCustomModal("Erro ao limpar dados.");
            }
        });


        // --- Firestore Listeners & UI Updates ---

        // Fun√ß√£o para configurar todos os listeners do Firestore
        function setupFirestoreListeners() {
            // Lista p√∫blica de inscritos
            const inscritosRef = collection(db, `/artifacts/${appId}/public/data/inscritos`);
            const qInscritos = query(inscritosRef); // Removed orderBy
            onSnapshot(qInscritos, (snapshot) => {
                loadingMessage.classList.add("hidden");
                participantList.innerHTML = "";
                inscritosCache = [];
                if (snapshot.empty) {
                    participantList.innerHTML = `<p class="text-sm text-gray-500 text-center">Nenhum participante ainda.</p>`;
                    return;
                }
                
                // Get documents and sort in-memory
                snapshot.forEach(docSnap => {
                    inscritosCache.push({ id: docSnap.id, ...docSnap.data() });
                });
                inscritosCache.sort((a, b) => new Date(b.criado_em) - new Date(a.criado_em));

                inscritosCache.forEach(entry => {
                    const div = document.createElement("div");
                    div.className = "flex items-center justify-between p-3 border border-gray-200 rounded-lg shadow-sm bg-white";
                    div.innerHTML = `
                        <div>
                            <p class="font-medium text-gray-800">${entry.nome}</p>
                            <p class="text-sm text-gray-500">${entry.setor}</p>
                            <p class="text-xs text-blue-600 font-semibold mt-1">Modalidades: ${entry.modalidades.join(", ")}</p>
                        </div>
                    `;
                    participantList.appendChild(div);
                });
                carregarAdminTable();
            });

            // Carregar Partidas Pendentes
            const partidasRef = collection(db, `/artifacts/${appId}/public/data/partidas`);
            const qPendentes = query(partidasRef, where("status", "==", "pendente"));
            onSnapshot(qPendentes, (snapshot) => {
                partidasPendentesList.innerHTML = "";
                if (snapshot.empty) {
                    partidasPendentesList.innerHTML = `<p class="text-sm text-gray-500 text-center">Nenhuma partida pendente.</p>`;
                    return;
                }
                snapshot.forEach(docSnap => {
                    const partida = docSnap.data();
                    const partidaId = docSnap.id;
                    const div = document.createElement("div");
                    div.className = "p-4 border border-gray-200 rounded-lg shadow-sm bg-white";
                    
                    if (partida.participante2) {
                        div.innerHTML = `
                            <p class="font-bold text-lg mb-2">${partida.modalidade}</p>
                            <div class="flex items-center justify-between mb-2">
                                <span class="font-semibold text-gray-800">${partida.participante1.nome}</span>
                                <span class="text-gray-500 mx-2">VS</span>
                                <span class="font-semibold text-gray-800">${partida.participante2.nome}</span>
                            </div>
                            <div class="flex gap-2">
                                <input type="number" placeholder="Placar ${partida.participante1.nome}" id="placar1-${partidaId}" class="w-1/2 p-2 border rounded-lg">
                                <input type="number" placeholder="Placar ${partida.participante2.nome}" id="placar2-${partidaId}" class="w-1/2 p-2 border rounded-lg">
                            </div>
                            <button id="salvarPlacar-${partidaId}" class="mt-2 w-full bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg font-semibold transition-colors">Salvar Placar</button>
                        `;
                    } else {
                         div.innerHTML = `
                            <p class="font-bold text-lg mb-2">${partida.modalidade}</p>
                            <div class="flex items-center justify-between mb-2">
                                <span class="font-semibold text-gray-800">${partida.participante1.nome}</span>
                                <span class="text-gray-500 mx-2">BYE</span>
                                <span class="font-semibold text-gray-800"></span>
                            </div>
                            <button id="salvarPlacar-${partidaId}" class="mt-2 w-full bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg font-semibold transition-colors">Avan√ßar Jogador</button>
                         `;
                    }

                    partidasPendentesList.appendChild(div);
                    
                    const salvarPlacarBtn = document.getElementById(`salvarPlacar-${partidaId}`);
                    if(salvarPlacarBtn) {
                        salvarPlacarBtn.addEventListener("click", async () => {
                            if (!partida.participante2) {
                                // Caso de BYE, o jogador avan√ßa automaticamente
                                await updateDoc(doc(db, `/artifacts/${appId}/public/data/partidas`, partidaId), {
                                    status: 'conclu√≠da',
                                    vencedor: partida.participante1.nome
                                });
                                showCustomModal(`Participante ${partida.participante1.nome} avan√ßou para a pr√≥xima fase!`);
                                return;
                            }

                            const placar1Input = document.getElementById(`placar1-${partidaId}`);
                            const placar2Input = document.getElementById(`placar2-${partidaId}`);
                            const placar1 = parseInt(placar1Input.value);
                            const placar2 = parseInt(placar2Input.value);

                            if (isNaN(placar1) || isNaN(placar2)) {
                                showCustomModal("Por favor, insira os placares.");
                                return;
                            }
                            
                            let vencedor = null;
                            if (placar1 > placar2) {
                                vencedor = partida.participante1.nome;
                            } else if (placar2 > placar1) {
                                vencedor = partida.participante2.nome;
                            } else {
                                showCustomModal("Placar n√£o pode ser um empate.");
                                return;
                            }
                            
                            await updateDoc(doc(db, `/artifacts/${appId}/public/data/partidas`, partidaId), {
                                placar1: placar1,
                                placar2: placar2,
                                vencedor: vencedor,
                                status: 'conclu√≠da'
                            });
                            showCustomModal(`Placar salvo! Vencedor: ${vencedor}`);
                        });
                    }
                });
            });

            // Listener para placar p√∫blico (partidas conclu√≠das)
            const partidasConcluidasRef = collection(db, `/artifacts/${appId}/public/data/partidas`);
            const qPlacar = query(partidasConcluidasRef, where("status", "==", "conclu√≠da")); // Removed orderBy
            onSnapshot(qPlacar, (snapshot) => {
                placarList.innerHTML = "";
                if (snapshot.empty) {
                    placarList.innerHTML = `<p class="text-sm text-gray-500 text-center">Nenhum placar registrado ainda.</p>`;
                    return;
                }
                
                // Get documents and sort in-memory
                const sortedPartidas = [];
                snapshot.forEach(docSnap => sortedPartidas.push(docSnap.data()));
                sortedPartidas.sort((a, b) => new Date(b.criado_em) - new Date(a.criado_em));

                sortedPartidas.forEach(partida => {
                    const div = document.createElement("div");
                    div.className = "p-4 border border-green-200 rounded-lg shadow-sm bg-green-50";
                    div.innerHTML = `
                        <p class="text-sm font-semibold text-green-700 mb-1">Partida Conclu√≠da - ${partida.modalidade}</p>
                        <div class="flex justify-between items-center text-gray-800">
                            <span class="font-bold">${partida.participante1.nome}</span>
                            <span class="font-bold text-xl mx-4">${partida.placar1 !== null ? partida.placar1 : "BYE"} - ${partida.placar2 !== null ? partida.placar2 : "BYE"}</span>
                            <span class="font-bold">${partida.participante2 ? partida.participante2.nome : ""}</span>
                        </div>
                        <p class="text-center font-bold text-purple-700 mt-2">Vencedor: ${partida.vencedor}</p>
                    `;
                    placarList.appendChild(div);
                });
            });
        }
        
        // Carregar modalidades
        async function carregarModalidades() {
            const q = query(collection(db, `/artifacts/${appId}/public/data/modalidades`)); // Removed orderBy
            onSnapshot(q, (snapshot) => {
                modalidadesCache = [];
                modalidadesList.innerHTML = "";
                adminModalidadesList.innerHTML = "";
                selectModalidade.innerHTML = `<option value="">Selecione a modalidade</option>`;
                snapshot.forEach(docSnap => {
                    const modalidade = docSnap.id;
                    modalidadesCache.push(modalidade);

                    // Para participantes
                    const label = document.createElement("label");
                    label.className = "flex items-center gap-2 text-gray-700";
                    label.innerHTML = `<input type="checkbox" value="${modalidade}" class="form-checkbox h-4 w-4 text-blue-600 rounded-md"> <span class="text-sm">${modalidade}</span>`;
                    modalidadesList.appendChild(label);
                    
                    // Para administrador
                    const div = document.createElement("div");
                    div.className = "flex justify-between items-center border p-2 rounded-lg bg-white shadow-sm";
                    div.innerHTML = `<span>${modalidade}</span>
                        <button class="text-red-600 hover:text-red-800" data-id="${modalidade}">üóëÔ∏è</button>`;
                    div.querySelector("button").addEventListener("click", async () => {
                        const confirmar = await showCustomModal(`Deseja realmente apagar a modalidade "${modalidade}"?`);
                        if(confirmar){
                            await deleteDoc(doc(db, `/artifacts/${appId}/public/data/modalidades`, modalidade));
                            carregarModalidades();
                        }
                    });
                    adminModalidadesList.appendChild(div);

                    // Para o select
                    const option = document.createElement("option");
                    option.value = modalidade;
                    option.textContent = modalidade;
                    selectModalidade.appendChild(option);
                });
                atualizarInfo();
            });
        }

        // Carregar limite
        async function carregarLimite() {
            const snap = await getDoc(doc(db, `/artifacts/${appId}/public/data/config`, "limite"));
            if (snap.exists()) {
                limiteEscolha = snap.data().valor;
                limiteInput.value = limiteEscolha;
            }
            atualizarInfo();
        }

        function atualizarInfo() {
            modalidadeInfo.textContent = `Voc√™ pode escolher at√© ${limiteEscolha} modalidade(s).`;
        }

        // Tabela do ADM
        function carregarAdminTable() {
            adminTableBody.innerHTML = "";
            inscritosCache.forEach(entry => {
                const tr = document.createElement("tr");
                tr.className = "hover:bg-gray-50";
                tr.innerHTML = `
                    <td class="border p-2">${entry.matricula}</td>
                    <td class="border p-2">${entry.nome}</td>
                    <td class="border p-2">${entry.setor}</td>
                    <td class="border p-2">${entry.telefone}</td>
                    <td class="border p-2">${entry.modalidades.join(", ")}</td>
                    <td class="border p-2 text-center">
                        <button class="text-red-600 hover:text-red-800" data-id="${entry.id}">üóëÔ∏è</button>
                    </td>
                `;
                tr.querySelector("button").addEventListener("click", async () => {
                    const confirmar = await showCustomModal(`Deseja realmente apagar a inscri√ß√£o de "${entry.nome}"?`);
                    if(confirmar) {
                        await deleteDoc(doc(db, `/artifacts/${appId}/public/data/inscritos`, entry.id));
                    }
                });
                adminTableBody.appendChild(tr);
            });
        }
    </script>
</body>
</html>
