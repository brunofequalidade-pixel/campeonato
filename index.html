<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inscrições - Campeonato</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, orderBy, where, getDocs, doc, deleteDoc, runTransaction } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // CONFIGURAÇÕES DO FIREBASE
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // VARIÁVEIS DO DOM
        const formSection = document.getElementById("formSection");
        const adminSection = document.getElementById("adminSection");
        const toggleButton = document.getElementById("toggleButton");
        const adminButton = document.getElementById("adminButton");
        const registrationForm = document.getElementById("registrationForm");
        const inscritosList = document.getElementById("inscritosList");
        const modalidadeSelect = document.getElementById("modalidadeSelect");
        const modalidadeAdminSelect = document.getElementById("modalidadeAdminSelect");
        const addModalidadeBtn = document.getElementById("addModalidadeBtn");
        const novaModalidadeInput = document.getElementById("novaModalidade");
        const modalidadesListAdmin = document.getElementById("modalidadesListAdmin");
        const adminLoginForm = document.getElementById("adminLoginForm");
        const adminPasswordInput = document.getElementById("adminPassword");
        const maxModalidadesInput = document.getElementById("maxModalidades");
        const saveMaxModalidadesBtn = document.getElementById("saveMaxModalidadesBtn");
        const inscritosTableBody = document.getElementById("inscritosTableBody");
        const exportCSVBtn = document.getElementById("exportCSVBtn");
        const confrontosAdminList = document.getElementById("confrontosAdminList");
        const sortearBtn = document.getElementById("sortearBtn");
        const confrontosList = document.getElementById("confrontosList");
        const inscritosInModalidadeList = document.getElementById("inscritosInModalidadeList");

        let inscritosCache = [];
        let modalidadesCache = [];
        let maxModalidadesPermitidas = 2;

        const adminPassword = "dpsp123";

        // --- EXIBIÇÃO DE SEÇÕES ---
        toggleButton.addEventListener("click", () => {
            formSection.classList.toggle("hidden");
            toggleButton.textContent = formSection.classList.contains("hidden") ? "Nova Inscrição" : "Esconder Formulário";
        });

        adminButton.addEventListener("click", () => {
            adminSection.classList.toggle("hidden");
            adminSection.scrollIntoView({ behavior: 'smooth' });
        });

        adminLoginForm.addEventListener("submit", (e) => {
            e.preventDefault();
            if (adminPasswordInput.value === adminPassword) {
                adminSection.classList.remove("hidden");
                adminLoginForm.classList.add("hidden");
                loadModalidades();
            } else {
                alert("Senha incorreta!");
                adminPasswordInput.value = "";
            }
        });

        // --- REGISTRO DE PARTICIPANTES (Existente) ---
        registrationForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            const matricula = registrationForm.matricula.value.trim();
            const nome = registrationForm.nome.value.trim();
            const setor = registrationForm.setor.value.trim();
            const telefone = registrationForm.telefone.value.trim();
            const modalidadesSelecionadas = Array.from(registrationForm.querySelectorAll("input[name='modalidade']:checked")).map(cb => cb.value);

            if (modalidadesSelecionadas.length > maxModalidadesPermitidas) {
                alert(`Você só pode selecionar no máximo ${maxModalidadesPermitidas} modalidades.`);
                return;
            }

            const q = query(collection(db, "inscritos"), where("matricula", "==", matricula));
            const querySnapshot = await getDocs(q);

            if (!querySnapshot.empty) {
                alert("Esta matrícula já foi utilizada para uma inscrição.");
                return;
            }

            try {
                await addDoc(collection(db, "inscritos"), {
                    matricula,
                    nome,
                    setor,
                    telefone,
                    modalidades: modalidadesSelecionadas,
                    timestamp: new Date()
                });
                alert("Inscrição realizada com sucesso!");
                registrationForm.reset();
            } catch (e) {
                console.error("Erro ao adicionar documento: ", e);
                alert("Erro ao realizar a inscrição. Tente novamente.");
            }
        });

        function renderInscritos(inscritos) {
            inscritosList.innerHTML = '';
            inscritos.forEach(doc => {
                const data = doc.data();
                const li = document.createElement('li');
                li.className = 'bg-gray-50 p-3 rounded-lg shadow-sm';
                li.innerHTML = `
                    <p class="font-semibold">${data.nome}</p>
                    <p class="text-sm text-gray-600">Setor: ${data.setor}</p>
                    <p class="text-sm text-gray-600">Modalidades: ${data.modalidades.join(' | ')}</p>
                `;
                inscritosList.appendChild(li);
            });
        }

        function loadInscritos() {
            const q = query(collection(db, "inscritos"), orderBy("timestamp", "desc"));
            onSnapshot(q, (snapshot) => {
                inscritosCache = snapshot.docs;
                renderInscritos(inscritosCache);
                renderInscritosAdmin(inscritosCache);
            });
        }

        // --- CONFIGURAÇÕES DE MODALIDADES & REGRAS (Existente) ---
        function renderModalidades(modalidades) {
            modalidadeSelect.innerHTML = '';
            modalidadeAdminSelect.innerHTML = '';
            modalidadesListAdmin.innerHTML = '';

            if (modalidades.length === 0) {
                modalidadeSelect.innerHTML = '<option disabled selected>Nenhuma modalidade disponível</option>';
            }

            modalidades.forEach(doc => {
                const data = doc.data();
                const option = document.createElement('option');
                option.value = doc.id;
                option.textContent = data.nome;
                modalidadeSelect.appendChild(option);

                const adminOption = option.cloneNode(true);
                modalidadeAdminSelect.appendChild(adminOption);

                const li = document.createElement('li');
                li.className = 'flex justify-between items-center p-2 border-b last:border-b-0';
                li.innerHTML = `
                    <span>${data.nome}</span>
                    <button data-id="${doc.id}" class="delete-modalidade-btn bg-red-500 hover:bg-red-600 text-white p-1 rounded-full text-xs">Excluir</button>
                `;
                modalidadesListAdmin.appendChild(li);
            });

            document.querySelectorAll(".delete-modalidade-btn").forEach(btn => {
                btn.addEventListener("click", async (e) => {
                    const id = e.target.getAttribute("data-id");
                    if (confirm("Tem certeza que deseja excluir esta modalidade?")) {
                        await deleteDoc(doc(db, "modalidades", id));
                        alert("Modalidade excluída!");
                    }
                });
            });
        }

        async function loadModalidades() {
            const q = query(collection(db, "modalidades"));
            onSnapshot(q, (snapshot) => {
                modalidadesCache = snapshot.docs;
                renderModalidades(modalidadesCache);
                loadConfig();
            });
        }

        addModalidadeBtn.addEventListener("click", async () => {
            const nomeModalidade = novaModalidadeInput.value.trim();
            if (nomeModalidade) {
                await addDoc(collection(db, "modalidades"), { nome: nomeModalidade });
                novaModalidadeInput.value = "";
                alert("Modalidade adicionada!");
            } else {
                alert("O nome da modalidade não pode ser vazio.");
            }
        });

        saveMaxModalidadesBtn.addEventListener("click", async () => {
            const max = parseInt(maxModalidadesInput.value);
            if (!isNaN(max) && max > 0) {
                try {
                    const configRef = doc(db, "config", "limiteModalidades");
                    await runTransaction(db, async (transaction) => {
                        transaction.set(configRef, { max: max });
                    });
                    maxModalidadesPermitidas = max;
                    alert("Limite de modalidades atualizado!");
                } catch (e) {
                    console.error("Erro ao salvar configuração: ", e);
                    alert("Erro ao salvar a configuração.");
                }
            } else {
                alert("O limite deve ser um número positivo.");
            }
        });

        async function loadConfig() {
            const configRef = doc(db, "config", "limiteModalidades");
            const configDoc = await getDocs(configRef);
            if (configDoc.exists()) {
                maxModalidadesPermitidas = configDoc.data().max;
                maxModalidadesInput.value = maxModalidadesPermitidas;
            }
        }

        // --- ADMIN LISTA DE INSCRITOS (Existente) ---
        function renderInscritosAdmin(inscritos) {
            inscritosTableBody.innerHTML = '';
            inscritos.forEach(doc => {
                const data = doc.data();
                const tr = document.createElement('tr');
                tr.className = 'border-b';
                tr.innerHTML = `
                    <td class="p-2">${data.matricula}</td>
                    <td class="p-2">${data.nome}</td>
                    <td class="p-2">${data.setor}</td>
                    <td class="p-2">${data.telefone}</td>
                    <td class="p-2">${data.modalidades.join(' | ')}</td>
                    <td class="p-2"><button data-id="${doc.id}" class="delete-inscrito-btn bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded-lg">Excluir</button></td>
                `;
                inscritosTableBody.appendChild(tr);
            });

            document.querySelectorAll(".delete-inscrito-btn").forEach(btn => {
                btn.addEventListener("click", async (e) => {
                    const id = e.target.getAttribute("data-id");
                    if (confirm("Tem certeza que deseja excluir este inscrito?")) {
                        await deleteDoc(doc(db, "inscritos", id));
                        alert("Inscrito excluído!");
                    }
                });
            });
        }

        // --- GERENCIAMENTO DE TORNEIO ---
        // Funções para adicionar e renderizar as fases
        modalidadeAdminSelect.addEventListener("change", handleTournamentSelection);

        async function handleTournamentSelection() {
            const modalidadeId = modalidadeAdminSelect.value;
            const modalidadeDoc = modalidadesCache.find(d => d.id === modalidadeId);
            if (!modalidadeDoc) return;

            // Carrega as fases e confrontos
            await loadFases(modalidadeId);
            await loadConfrontosAdmin(modalidadeId);
        }

        // Funções de sorteio (existentes)

        async function renderConfrontos(confrontos, modalidadeId) {
            confrontosAdminList.innerHTML = '';
            const faseMap = new Map();

            // Agrupa confrontos por fase
            confrontos.forEach(c => {
                const data = c.data();
                if (!faseMap.has(data.fase)) {
                    faseMap.set(data.fase, []);
                }
                faseMap.get(data.fase).push(c);
            });

            // Cria o HTML para cada fase
            faseMap.forEach((confrontosDaFase, faseNome) => {
                const faseDiv = document.createElement('div');
                faseDiv.className = 'space-y-2 mt-4';
                faseDiv.innerHTML = `<h3 class="text-xl font-semibold">${faseNome}</h3>`;

                confrontosDaFase.forEach(c => {
                    const data = c.data();
                    const confrontoDiv = document.createElement('div');
                    confrontoDiv.className = 'bg-gray-100 p-4 rounded-lg flex flex-col md:flex-row items-center justify-between space-y-2 md:space-y-0';
                    
                    let player1Name = 'BYE';
                    let player2Name = 'BYE';
                    if (data.jogador1Id && data.jogador2Id) {
                        const jogador1 = inscritosCache.find(j => j.id === data.jogador1Id);
                        const jogador2 = inscritosCache.find(j => j.id === data.jogador2Id);
                        player1Name = jogador1 ? jogador1.data().nome : 'Jogador 1';
                        player2Name = jogador2 ? jogador2.data().nome : 'Jogador 2';
                    } else if (data.jogador1Id) {
                         const jogador1 = inscritosCache.find(j => j.id === data.jogador1Id);
                         player1Name = jogador1 ? jogador1.data().nome : 'Jogador 1';
                    }

                    // --- ESTA É A PARTE QUE CORRIGE O PLACAR ---
                    confrontoDiv.innerHTML = `
                        <div class="flex-1 w-full md:w-auto">
                            <span class="font-semibold">${player1Name}</span>
                            <span class="mx-2">vs</span>
                            <span class="font-semibold">${player2Name}</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <input type="number" id="placar1-${c.id}" value="${data.placar1}" class="w-16 p-1 border rounded text-center">
                            <span>x</span>
                            <input type="number" id="placar2-${c.id}" value="${data.placar2}" class="w-16 p-1 border rounded text-center">
                            <button id="save-${c.id}" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">Salvar</button>
                        </div>
                    `;

                    faseDiv.appendChild(confrontoDiv);
                });
                confrontosAdminList.appendChild(faseDiv);
            });
            
            // Adiciona os event listeners após o HTML ser renderizado
            faseMap.forEach((confrontosDaFase) => {
                confrontosDaFase.forEach(c => {
                    const saveBtn = document.getElementById(`save-${c.id}`);
                    if (saveBtn) {
                        saveBtn.addEventListener("click", () => {
                            const placar1Input = document.getElementById(`placar1-${c.id}`);
                            const placar2Input = document.getElementById(`placar2-${c.id}`);
                            savePlacar(modalidadeId, c.id, parseInt(placar1Input.value), parseInt(placar2Input.value));
                        });
                    }
                });
            });
        }

        async function savePlacar(modalidadeId, confrontoId, placar1, placar2) {
            if (placar1 === placar2) {
                alert("Não é permitido empate. Insira um placar com vencedor.");
                return;
            }

            try {
                const confrontoRef = doc(db, "modalidades", modalidadeId, "confrontos", confrontoId);
                await runTransaction(db, async (transaction) => {
                    const confrontoDoc = await transaction.get(confrontoRef);
                    if (!confrontoDoc.exists()) {
                        throw "Documento de confronto não existe!";
                    }

                    const vencedorId = placar1 > placar2 ? confrontoDoc.data().jogador1Id : confrontoDoc.data().jogador2Id;

                    transaction.update(confrontoRef, {
                        placar1: placar1,
                        placar2: placar2,
                        vencedorId: vencedorId,
                        status: 'finalizado' // Atualiza o status
                    });
                });
                alert("Placar salvo com sucesso!");
            } catch (e) {
                console.error("Erro ao salvar o placar: ", e);
                alert("Erro ao salvar o placar. Tente novamente.");
            }
        }

        // Funções para carregar e renderizar os confrontos
        async function loadConfrontosAdmin(modalidadeId) {
            const q = query(collection(db, "modalidades", modalidadeId, "confrontos"));
            onSnapshot(q, (snapshot) => {
                renderConfrontos(snapshot.docs, modalidadeId);
            });
        }

        async function renderConfrontosPublico(confrontos) {
            // ... (código existente)
        }

        async function loadConfrontosPublico(modalidadeId) {
            const q = query(collection(db, "modalidades", modalidadeId, "confrontos"), where("status", "==", "finalizado"));
             onSnapshot(q, (snapshot) => {
                 renderConfrontosPublico(snapshot.docs);
             });
        }

        // Funções para Fases
        async function loadFases(modalidadeId) {
            const q = query(collection(db, "modalidades", modalidadeId, "fases"), orderBy("ordem"));
            onSnapshot(q, (snapshot) => {
                // ... (código existente)
            });
        }

        // --- Exportar CSV (Existente) ---
        exportCSVBtn.addEventListener("click", () => {
            if (inscritosCache.length === 0) return alert("Nenhum inscrito para exportar!");
            let csv = "Matrícula,Nome,Setor,Telefone,Modalidades\n";
            inscritosCache.forEach(e => {
                csv += `"${e.matricula}","${e.nome}","${e.setor}","${e.telefone}","${e.modalidades.join(" | ")}"\n`;
            });
            const blob = new Blob([`\uFEFF${csv}`], { type: "text/csv;charset=utf-8;" }); // Adiciona BOM para Excel
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "inscritos.csv";
            a.click();
            URL.revokeObjectURL(url);
        });

        // --- Inicialização ---
        async function init() {
            await loadInscritos();
            await loadModalidades();
            loadConfrontosPublico('YOUR_MODALIDADE_ID'); // Troque pela modalidade que deseja exibir por padrão
        }

        init();
    </script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center justify-center p-4">
    <script>
        // ... (seu código JavaScript) ...
    </script>
</body>
</html>
