<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sistema de Campeonato (Firestore)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-app-compat.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-firestore-compat.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen p-4">
  <div class="max-w-6xl mx-auto">
    <h1 class="text-3xl font-bold text-center mb-6">Sistema de Campeonato üèÜ</h1>

    <div class="flex flex-wrap justify-center gap-2 mb-6">
      <button id="inscricaoBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">üìù Inscri√ß√µes</button>
      <button id="publicoBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg">üë• Lista P√∫blica</button>
      <button id="adminBtn" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg">‚öôÔ∏è Admin</button>
      <button id="acompanharBtn" class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-lg">üìä Acompanhar</button>
    </div>

    <!-- Inscri√ß√£o -->
    <section id="inscricaoSection" class="bg-white p-6 rounded-lg shadow mb-6 hidden">
      <h2 class="text-xl font-bold mb-4">Nova Inscri√ß√£o</h2>
      <form id="inscricaoForm" class="space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <input type="text" id="matricula" placeholder="Matr√≠cula" class="p-2 border rounded-lg" required>
          <input type="text" id="nome" placeholder="Nome completo" class="p-2 border rounded-lg" required>
          <input type="text" id="setor" placeholder="Setor" class="p-2 border rounded-lg" required>
          <input type="tel" id="telefone" placeholder="Telefone" class="p-2 border rounded-lg" required>
        </div>
        <div>
          <p class="font-semibold mb-2">Escolha suas modalidades:</p>
          <div id="modalidadesList" class="grid grid-cols-2 gap-2"></div>
          <p id="modalidadeInfo" class="text-sm text-gray-500 mt-2"></p>
        </div>
        <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg">Enviar Inscri√ß√£o</button>
      </form>
    </section>

    <!-- Lista P√∫blica -->
    <section id="publicoSection" class="bg-white p-6 rounded-lg shadow mb-6 hidden">
      <h2 class="text-xl font-bold mb-4">Participantes Inscritos</h2>
      <div id="participantesList" class="space-y-3"></div>
    </section>

    <!-- Acompanhar -->
    <section id="acompanharSection" class="bg-white p-6 rounded-lg shadow mb-6 hidden">
      <h2 class="text-xl font-bold mb-4">Acompanhar Jogos</h2>
      <div id="jogosAcompanhar" class="space-y-4"></div>
    </section>

    <!-- Admin -->
    <section id="adminSection" class="bg-white p-6 rounded-lg shadow mb-6 hidden">
      <h2 class="text-xl font-bold mb-4">√Årea Administrativa</h2>

      <div class="flex flex-wrap gap-2 mb-4">
        <button id="configTab" class="bg-gray-600 text-white px-3 py-1 rounded">Config</button>
        <button id="fasesTab" class="bg-gray-400 text-white px-3 py-1 rounded">Fases</button>
        <button id="placaresTab" class="bg-gray-400 text-white px-3 py-1 rounded">Placares</button>
        <button id="resetTab" class="bg-gray-400 text-white px-3 py-1 rounded">Reset</button>
      </div>

      <div id="configDiv" class="space-y-4">
        <div>
          <h3 class="font-semibold mb-2">Modalidades</h3>
          <div id="adminModalidadesList" class="space-y-2 mb-3"></div>
          <div class="flex gap-2">
            <input type="text" id="novaModalidade" placeholder="Nova modalidade" class="flex-1 p-2 border rounded">
            <button id="addModalidade" class="bg-green-600 text-white px-3 py-2 rounded">Add</button>
          </div>
        </div>

        <div>
          <h3 class="font-semibold mb-2">Limite por Participante</h3>
          <div class="flex gap-2">
            <input type="number" id="limiteInput" min="1" class="p-2 border rounded w-20">
            <button id="salvarLimite" class="bg-blue-600 text-white px-3 py-2 rounded">Salvar</button>
          </div>
        </div>

        <div>
          <button id="exportBtn" class="bg-indigo-600 text-white px-4 py-2 rounded mr-2">Exportar CSV</button>
        </div>

        <div class="overflow-x-auto">
          <table class="w-full border text-sm">
            <thead class="bg-gray-200">
              <tr>
                <th class="border p-2">Nome</th>
                <th class="border p-2">Setor</th>
                <th class="border p-2">Telefone</th>
                <th class="border p-2">Modalidades</th>
                <th class="border p-2">A√ß√µes</th>
              </tr>
            </thead>
            <tbody id="tabelaInscritos"></tbody>
          </table>
        </div>
      </div>

      <div id="fasesDiv" class="hidden space-y-4">
        <div class="flex gap-2">
          <select id="modalidadeSelect" class="flex-1 p-2 border rounded">
            <option value="">Selecione modalidade</option>
          </select>
          <button id="criarFaseBtn" class="bg-green-600 text-white px-4 py-2 rounded">Criar Fase</button>
        </div>
        <div id="faseAtual" class="mt-4"></div>
      </div>

      <div id="placaresDiv" class="hidden space-y-4">
        <select id="modalidadePlacar" class="w-full p-2 border rounded mb-4">
          <option value="">Selecione modalidade para ver jogos</option>
        </select>
        <div id="jogosPendentes"></div>
      </div>

      <div id="resetDiv" class="hidden">
        <div class="bg-red-50 p-4 rounded border border-red-200">
          <h3 class="font-semibold text-red-800 mb-2">‚ö†Ô∏è Reset Campeonato</h3>
          <p class="text-red-700 mb-4">Apaga todas as fases e placares. Mant√©m participantes.</p>
          <button id="resetBtn" class="bg-red-600 text-white px-4 py-2 rounded">Reset Completo</button>
        </div>
      </div>
    </section>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // ===== Config Firebase =====
      const firebaseConfig = {
        apiKey: "AIzaSyBo8G3ZcWk4EepN0cHdVBtXc7tGOfcw-yg",
        authDomain: "inscricaosinuca.firebaseapp.com",
        projectId: "inscricaosinuca",
        storageBucket: "inscricaosinuca.firebasestorage.app",
        messagingSenderId: "338241576305",
        appId: "1:338241576305:web:288b6124384c6be4f76ad0",
        measurementId: "G-PEDG30FS2R"
      };
      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();

      // ===== Estado =====
      let inscritos = [];
      let modalidades = [];
      let limite = 2;

      // ===== Fun√ß√µes de leitura/escrita =====
      async function carregarDados() {
        try {
          // inscritos
          const inscritosSnap = await db.collection('inscritos').get();
          inscritos = inscritosSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

          // modalidades
          const modalidadesSnap = await db.collection('config').doc('modalidades').get();
          if (modalidadesSnap.exists) {
            modalidades = modalidadesSnap.data().lista || ["Sinuca", "Domin√≥", "Dama"];
          } else {
            modalidades = ["Sinuca", "Domin√≥", "Dama"];
            await db.collection('config').doc('modalidades').set({ lista: modalidades });
          }

          // config geral
          const configSnap = await db.collection('config').doc('geral').get();
          if (configSnap.exists) {
            limite = configSnap.data().limite || 2;
          } else {
            limite = 2;
            await db.collection('config').doc('geral').set({ limite });
          }

          carregarModalidades();
          carregarModalidadesSelect();
          carregarPlacarSelect();
          carregarAdmin(); // atualiza tabela admin
        } catch (error) {
          console.error('Erro ao carregar dados:', error);
          alert('Erro ao carregar dados do Firebase (veja console).');
        }
      }

      async function salvarModalidades() {
        try {
          await db.collection('config').doc('modalidades').set({ lista: modalidades });
        } catch (error) {
          console.error('Erro ao salvar modalidades:', error);
        }
      }

      async function salvarConfig() {
        try {
          await db.collection('config').doc('geral').set({ limite });
        } catch (error) {
          console.error('Erro ao salvar config:', error);
        }
      }

      async function carregarFases() {
        try {
          const fasesSnap = await db.collection('fases').get();
          const fases = {};
          fasesSnap.docs.forEach(doc => fases[doc.id] = doc.data());
          return fases;
        } catch (error) {
          console.error('Erro ao carregar fases:', error);
          return {};
        }
      }

      // salvarFase: grava em doc fases e em jogos/modalidade/fases/N (merge true)
      async function salvarFase(modalidade, numeroFase, confrontos) {
        try {
          const faseKey = `${modalidade}_fase`;
          await db.collection('fases').doc(faseKey).set({
            numero: numeroFase,
            confrontos: confrontos
          });
          await db.collection('jogos')
            .doc(modalidade)
            .collection('fases')
            .doc(numeroFase.toString())
            .set({ jogos: confrontos }, { merge: true }); // <-- merge para seguran√ßa
        } catch (error) {
          console.error('Erro ao salvar fase:', error);
        }
      }

      // carregarJogos: garante arrays
      async function carregarJogos() {
        try {
          const jogos = {};
          const modalidadesJogos = await db.collection('jogos').get();
          for (const modalidadeDoc of modalidadesJogos.docs) {
            const modalidade = modalidadeDoc.id;
            const fasesSnap = await db.collection('jogos').doc(modalidade).collection('fases').get();
            jogos[modalidade] = {};
            fasesSnap.docs.forEach(faseDoc => {
              const data = faseDoc.data() || {};
              jogos[modalidade][faseDoc.id] = Array.isArray(data.jogos) ? data.jogos : [];
            });
          }
          return jogos;
        } catch (error) {
          console.error('Erro ao carregar jogos:', error);
          return {};
        }
      }

      async function atualizarJogo(modalidade, numeroFase, jogoId, placar1, placar2) {
        try {
          const jogosRef = db.collection('jogos').doc(modalidade).collection('fases').doc(numeroFase.toString());
          const jogosSnap = await jogosRef.get();
          if (jogosSnap.exists) {
            const jogos = jogosSnap.data().jogos || [];
            const jogoIndex = jogos.findIndex(j => j.id === jogoId);
            if (jogoIndex !== -1) {
              jogos[jogoIndex].placar1 = placar1;
              jogos[jogoIndex].placar2 = placar2;
              jogos[jogoIndex].finalizado = true;
              await jogosRef.set({ jogos }, { merge: true });

              // Atualizar tamb√©m em 'fases' (confrontos)
              const faseKey = `${modalidade}_fase`;
              const faseSnap = await db.collection('fases').doc(faseKey).get();
              if (faseSnap.exists) {
                const faseData = faseSnap.data();
                const confrontoIndex = (faseData.confrontos || []).findIndex(c => c.id === jogoId);
                if (confrontoIndex !== -1) {
                  faseData.confrontos[confrontoIndex].placar1 = placar1;
                  faseData.confrontos[confrontoIndex].placar2 = placar2;
                  faseData.confrontos[confrontoIndex].finalizado = true;
                  await db.collection('fases').doc(faseKey).set(faseData, { merge: true });
                }
              }
            }
          }
        } catch (error) {
          console.error('Erro ao atualizar jogo:', error);
        }
      }

      async function resetCampeonato() {
        try {
          const fasesSnap = await db.collection('fases').get();
          const batch = db.batch();
          fasesSnap.docs.forEach(doc => batch.delete(doc.ref));

          const jogosSnap = await db.collection('jogos').get();
          for (const modalidadeDoc of jogosSnap.docs) {
            const fasesSnap2 = await db.collection('jogos').doc(modalidadeDoc.id).collection('fases').get();
            fasesSnap2.docs.forEach(fd => batch.delete(fd.ref));
            batch.delete(modalidadeDoc.ref);
          }
          await batch.commit();
        } catch (error) {
          console.error('Erro ao resetar campeonato:', error);
        }
      }

      // ===== UI: navega√ß√£o / tabs =====
      function showSection(section) {
        document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
        const target = document.getElementById(section + 'Section');
        if (target) target.classList.remove('hidden');

        // reset colors do menu superior
        document.querySelectorAll('div.flex.flex-wrap.justify-center.gap-2.mb-6 button').forEach(btn => {
          const id = btn.id;
          if (id === 'inscricaoBtn') btn.className = btn.className.replace(/bg-[a-z]+-800|bg-[a-z]+-600/g, 'bg-blue-600').replace('bg-blue-600', 'bg-blue-600');
          if (id === 'publicoBtn') btn.className = btn.className.replace(/bg-[a-z]+-800|bg-[a-z]+-600/g, 'bg-green-600');
          if (id === 'adminBtn') btn.className = btn.className.replace(/bg-[a-z]+-800|bg-[a-z]+-600/g, 'bg-purple-600');
          if (id === 'acompanharBtn') btn.className = btn.className.replace(/bg-[a-z]+-800|bg-[a-z]+-600/g, 'bg-orange-600');
        });

        const activeBtn = document.getElementById(section + 'Btn');
        if (activeBtn) {
          // colocar o bot√£o ativo em destaque cinza escuro
          activeBtn.className = activeBtn.className.replace(/bg-[a-z]+-600/, 'bg-gray-800');
        }
      }

      document.getElementById('inscricaoBtn').onclick = () => showSection('inscricao');
      document.getElementById('publicoBtn').onclick = () => {
        showSection('publico');
        carregarListaPublica();
      };
      document.getElementById('acompanharBtn').onclick = () => {
        showSection('acompanhar');
        carregarAcompanhamento();
      };
      document.getElementById('adminBtn').onclick = () => {
        const senha = prompt("Senha do administrador:");
        if (senha === "dpsp123") {
          showSection('admin');
          carregarAdmin();
          showAdminTab('config');
        } else if (senha) {
          alert("Senha incorreta!");
        }
      };

      function showAdminTab(tab) {
        ['configTab', 'fasesTab', 'placaresTab', 'resetTab'].forEach(t => {
          const el = document.getElementById(t);
          if (el) el.className = "bg-gray-400 text-white px-3 py-1 rounded";
        });
        ['configDiv', 'fasesDiv', 'placaresDiv', 'resetDiv'].forEach(d => {
          const el = document.getElementById(d);
          if (el) el.classList.add('hidden');
        });
        const tabBtn = document.getElementById(tab + 'Tab');
        const tabDiv = document.getElementById(tab + 'Div');
        if (tabBtn) tabBtn.className = "bg-gray-600 text-white px-3 py-1 rounded";
        if (tabDiv) tabDiv.classList.remove('hidden');
      }

      document.getElementById('configTab').onclick = () => showAdminTab('config');
      document.getElementById('fasesTab').onclick = () => {
        showAdminTab('fases');
        carregarModalidadesSelect();
      };
      document.getElementById('placaresTab').onclick = () => {
        showAdminTab('placares');
        carregarPlacarSelect();
      };
      document.getElementById('resetTab').onclick = () => showAdminTab('reset');

      // ===== Modalidades UI =====
      function carregarModalidades() {
        // inscri√ß√£o list
        const lista = document.getElementById('modalidadesList');
        lista.innerHTML = '';
        modalidades.forEach(m => {
          const label = document.createElement('label');
          label.className = 'flex items-center gap-2 p-2 border rounded cursor-pointer';
          label.innerHTML = `<input type="checkbox" value="${m}"> ${m}`;
          lista.appendChild(label);
        });

        // admin list
        const adminLista = document.getElementById('adminModalidadesList');
        adminLista.innerHTML = '';
        modalidades.forEach(m => {
          const div = document.createElement('div');
          div.className = 'flex justify-between items-center p-2 border rounded';
          div.innerHTML = `<span>${m}</span><button class="text-red-600 px-2">üóëÔ∏è</button>`;
          // adicionar listener para remover modalidade
          div.querySelector('button').addEventListener('click', async () => {
            if (confirm(`Remover ${m}?`)) {
              modalidades = modalidades.filter(x => x !== m);
              await salvarModalidades();
              carregarModalidades();
              carregarModalidadesSelect();
              carregarPlacarSelect();
            }
          });
          adminLista.appendChild(div);
        });

        const info = document.getElementById('modalidadeInfo');
        if (info) info.textContent = `Escolha at√© ${limite} modalidade(s)`;
        const limInput = document.getElementById('limiteInput');
        if (limInput) limInput.value = limite;
      }

      // Adicionar modalidade
      document.getElementById('addModalidade').onclick = async (e) => {
        e.preventDefault();
        const nome = document.getElementById('novaModalidade').value.trim();
        if (nome && !modalidades.includes(nome)) {
          modalidades.push(nome);
          await salvarModalidades();
          document.getElementById('novaModalidade').value = '';
          carregarModalidades();
          carregarModalidadesSelect();
          carregarPlacarSelect();
          alert('Modalidade adicionada!');
        } else {
          alert('Nome inv√°lido ou j√° existe!');
        }
      };

      // salvar limite
      document.getElementById('salvarLimite').onclick = async (e) => {
        e.preventDefault();
        const novoLimite = parseInt(document.getElementById('limiteInput').value);
        if (novoLimite > 0) {
          limite = novoLimite;
          await salvarConfig();
          carregarModalidades();
          alert('Limite salvo!');
        }
      };

      // ===== Inscri√ß√µes =====
      document.getElementById('inscricaoForm').onsubmit = async (e) => {
        e.preventDefault();
        const matricula = document.getElementById('matricula').value.trim();
        const nome = document.getElementById('nome').value.trim();
        const setor = document.getElementById('setor').value.trim();
        const telefone = document.getElementById('telefone').value.trim();
        const escolhidas = Array.from(document.querySelectorAll('#modalidadesList input:checked')).map(c => c.value);

        if (!matricula || !nome || !setor || !telefone) {
          alert('Preencha todos os campos!');
          return;
        }
        if (escolhidas.length === 0 || escolhidas.length > limite) {
          alert(`Escolha entre 1 e ${limite} modalidades!`);
          return;
        }
        if (inscritos.find(i => i.matricula === matricula)) {
          alert('Matr√≠cula j√° inscrita!');
          return;
        }

        try {
          const novoInscrito = { matricula, nome, setor, telefone, modalidades: escolhidas, criado: new Date().toISOString() };
          const docRef = await db.collection('inscritos').add(novoInscrito);
          inscritos.push({ id: docRef.id, ...novoInscrito });
          alert('Inscri√ß√£o realizada!');
          document.getElementById('inscricaoForm').reset();
          carregarModalidades();
          carregarAdmin();
        } catch (error) {
          console.error('Erro ao salvar inscri√ß√£o:', error);
          alert('Erro ao salvar inscri√ß√£o (ver console).');
        }
      };

      // Lista p√∫blica
      function carregarListaPublica() {
        const lista = document.getElementById('participantesList');
        lista.innerHTML = '';
        if (inscritos.length === 0) {
          lista.innerHTML = '<p class="text-gray-500">Nenhum participante ainda.</p>';
          return;
        }
        inscritos.forEach(p => {
          const div = document.createElement('div');
          div.className = 'p-3 border rounded-lg';
          div.innerHTML = `
            <h3 class="font-semibold">${p.nome}</h3>
            <p class="text-gray-600">${p.setor}</p>
            <p class="text-sm text-blue-600">Modalidades: ${p.modalidades.join(', ')}</p>
          `;
          lista.appendChild(div);
        });
      }

      // ===== Admin UI =====
      function carregarAdmin() {
        const tabela = document.getElementById('tabelaInscritos');
        tabela.innerHTML = '';
        inscritos.forEach(p => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td class="border p-2">${p.nome}</td>
            <td class="border p-2">${p.setor}</td>
            <td class="border p-2">${p.telefone}</td>
            <td class="border p-2">${p.modalidades.join(', ')}</td>
            <td class="border p-2"><button class="text-red-600 px-2">üóëÔ∏è</button></td>
          `;
          // bot√£o remover
          tr.querySelector('button').addEventListener('click', async () => {
            if (confirm('Remover participante?')) {
              const senha = prompt('Confirme a senha:');
              if (senha === 'dpsp123') {
                try {
                  await db.collection('inscritos').doc(p.id).delete();
                  inscritos = inscritos.filter(i => i.id !== p.id);
                  carregarAdmin();
                } catch (error) {
                  console.error('Erro ao remover inscrito:', error);
                  alert('Erro ao remover inscrito (ver console).');
                }
              }
            }
          });
          tabela.appendChild(tr);
        });
      }

      // export CSV
      document.getElementById('exportBtn').onclick = () => {
        if (inscritos.length === 0) {
          alert('Nenhum inscrito!');
          return;
        }
        let csv = 'Nome,Setor,Telefone,Modalidades\n';
        inscritos.forEach(p => {
          csv += `"${p.nome}","${p.setor}","${p.telefone}","${p.modalidades.join(' | ')}"\n`;
        });
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'inscritos.csv';
        a.click();
      };

      // selects de modalidades
      function carregarModalidadesSelect() {
        const select = document.getElementById('modalidadeSelect');
        if (!select) return;
        select.innerHTML = '<option value="">Selecione modalidade</option>';
        modalidades.forEach(m => select.innerHTML += `<option value="${m}">${m}</option>`);
      }
      function carregarPlacarSelect() {
        const select = document.getElementById('modalidadePlacar');
        if (!select) return;
        select.innerHTML = '<option value="">Selecione modalidade</option>';
        modalidades.forEach(m => select.innerHTML += `<option value="${m}">${m}</option>`);
      }

      // criar fase
      document.getElementById('criarFaseBtn').onclick = () => {
        const modalidade = document.getElementById('modalidadeSelect').value;
        if (!modalidade) { alert('Selecione uma modalidade!'); return; }
        criarFase(modalidade);
      };

      async function criarFase(modalidade) {
        const participantes = inscritos.filter(p => p.modalidades.includes(modalidade));
        if (participantes.length < 2) { alert('M√≠nimo 2 participantes!'); return; }

        try {
          const fases = await carregarFases();
          const faseKey = `${modalidade}_fase`;
          let numeroFase = 1;
          let jogadores = [...participantes];

          if (fases[faseKey]) {
            const jogos = await carregarJogos();
            const vencedores = getVencedoresFase(modalidade, fases[faseKey].numero, jogos);
            if (vencedores.length === 1) {
              alert(`${vencedores[0].nome} √© o campe√£o!`);
              return;
            }
            numeroFase = fases[faseKey].numero + 1;
            jogadores = vencedores;

            if (jogadores.length % 2 === 1) {
              const perdedores = getPerdedoresFase(modalidade, fases[faseKey].numero, jogos);
              if (perdedores.length > 0) {
                const sorteado = perdedores[Math.floor(Math.random() * perdedores.length)];
                jogadores.push(sorteado);
                alert(`${sorteado.nome} foi sorteado para completar a fase!`);
              }
            }
          }

          // embaralhar
          for (let i = jogadores.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [jogadores[i], jogadores[j]] = [jogadores[j], jogadores[i]];
          }

          // confrontos
          const confrontos = [];
          for (let i = 0; i < jogadores.length; i += 2) {
            if (jogadores[i + 1]) {
              confrontos.push({
                id: `${modalidade}_${numeroFase}_${Date.now()}_${i}`,
                jogador1: jogadores[i],
                jogador2: jogadores[i + 1],
                placar1: 0,
                placar2: 0,
                finalizado: false
              });
            }
          }

          await salvarFase(modalidade, numeroFase, confrontos);
          mostrarFaseAtual(modalidade);
          carregarPlacarSelect();
          alert(`Fase ${numeroFase} criada com ${confrontos.length} confrontos!`);
        } catch (error) {
          console.error('Erro ao criar fase:', error);
          alert('Erro ao criar fase (ver console).');
        }
      }

      async function mostrarFaseAtual(modalidade) {
        try {
          const fases = await carregarFases();
          const div = document.getElementById('faseAtual');
          const faseKey = `${modalidade}_fase`;
          if (!fases[faseKey]) {
            div.innerHTML = '<p class="text-gray-500">Nenhuma fase criada ainda.</p>';
            return;
          }
          const fase = fases[faseKey];
          let html = `<h3 class="font-bold mb-3">Fase ${fase.numero} - ${modalidade}</h3>`;
          (fase.confrontos || []).forEach(c => {
            html += `
              <div class="flex justify-between items-center p-3 border rounded mb-2 ${c.finalizado ? 'bg-green-50' : 'bg-yellow-50'}">
                <span>${c.jogador1.nome} vs ${c.jogador2.nome}</span>
                <span class="${c.finalizado ? 'text-green-600' : 'text-orange-600'}">
                  ${c.finalizado ? `${c.placar1} x ${c.placar2}` : 'Pendente'}
                </span>
              </div>
            `;
          });
          div.innerHTML = html;
        } catch (error) {
          console.error('Erro ao mostrar fase atual:', error);
        }
      }

      // quando muda select nas fases
      document.getElementById('modalidadeSelect').onchange = (e) => {
        if (e.target.value) mostrarFaseAtual(e.target.value);
      };

      // ===== Placares =====
      document.getElementById('modalidadePlacar').onchange = (e) => mostrarJogosPendentes(e.target.value);

      async function mostrarJogosPendentes(modalidade) {
        const div = document.getElementById('jogosPendentes');
        div.innerHTML = '';
        if (!modalidade) {
          div.innerHTML = '<p class="text-gray-500">Nenhum jogo encontrado.</p>';
          return;
        }
        try {
          const jogos = await carregarJogos();
          if (!jogos[modalidade]) {
            div.innerHTML = '<p class="text-gray-500">Nenhum jogo encontrado.</p>';
            return;
          }

          const fases = Object.keys(jogos[modalidade] || []);
          // filtrar chaves num√©ricas
          const numericFases = fases.map(f => parseInt(f)).filter(n => !isNaN(n));
          if (numericFases.length === 0) {
            div.innerHTML = '<p class="text-gray-500">Nenhuma fase criada para esta modalidade.</p>';
            return;
          }
          const ultimaFase = Math.max(...numericFases);
          const ultimaFaseKey = ultimaFase.toString(); // usar string para acessar
          const jogosUltimaFase = jogos[modalidade][ultimaFaseKey] || [];
          const pendentes = (jogosUltimaFase || []).filter(j => !j.finalizado);

          if (pendentes.length === 0) {
            div.innerHTML = '<p class="text-green-600">Todos os jogos da fase atual foram finalizados!</p>';
            return;
          }

          pendentes.forEach(jogo => {
            const jogoDiv = document.createElement('div');
            jogoDiv.className = 'p-4 border rounded bg-gray-50 mb-3';
            jogoDiv.innerHTML = `
              <h4 class="font-semibold mb-3">${jogo.jogador1.nome} vs ${jogo.jogador2.nome}</h4>
              <div class="grid grid-cols-2 gap-4 mb-3">
                <div>
                  <label class="block text-sm font-medium">${jogo.jogador1.nome}</label>
                  <input type="number" min="0" max="2" value="${jogo.placar1}" class="w-full p-2 border rounded" data-jogador="1" data-jogo="${jogo.id}">
                </div>
                <div>
                  <label class="block text-sm font-medium">${jogo.jogador2.nome}</label>
                  <input type="number" min="0" max="2" value="${jogo.placar2}" class="w-full p-2 border rounded" data-jogador="2" data-jogo="${jogo.id}">
                </div>
              </div>
              <button class="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700 salvar-placar-btn" data-jogo="${jogo.id}" data-modalidade="${modalidade}" data-fase="${ultimaFaseKey}">
                Salvar Placar
              </button>
            `;
            div.appendChild(jogoDiv);
          });

          // Delegation: adicionar listeners para os bot√µes Salvar Placar rec√©m-criados
          div.querySelectorAll('.salvar-placar-btn').forEach(btn => {
            btn.addEventListener('click', async (ev) => {
              const jogoId = btn.getAttribute('data-jogo');
              const modalidadeSel = btn.getAttribute('data-modalidade');
              const faseNum = parseInt(btn.getAttribute('data-fase'));
              const placar1Input = document.querySelector(`input[data-jogo="${jogoId}"][data-jogador="1"]`);
              const placar2Input = document.querySelector(`input[data-jogo="${jogoId}"][data-jogador="2"]`);
              const placar1 = parseInt(placar1Input.value || '0');
              const placar2 = parseInt(placar2Input.value || '0');

              if (placar1 < 0 || placar1 > 2 || placar2 < 0 || placar2 > 2) {
                alert('Placar deve ser entre 0 e 2!');
                return;
              }
              if (placar1 === placar2) {
                alert('Deve haver um vencedor!');
                return;
              }
              if (placar1 < 2 && placar2 < 2) {
                alert('Algu√©m deve fazer 2 pontos para vencer!');
                return;
              }

              try {
                await atualizarJogo(modalidadeSel, faseNum, jogoId, placar1, placar2);
                alert('Placar salvo!');
                mostrarJogosPendentes(modalidadeSel);
                // checar se todos finalizaram
                const jogosAtualizados = await carregarJogos();
                const jfase = jogosAtualizados[modalidadeSel] && jogosAtualizados[modalidadeSel][faseNum.toString()] ? jogosAtualizados[modalidadeSel][faseNum.toString()] : [];
                if (jfase.length > 0 && jfase.every(j => j.finalizado)) {
                  alert('Todos os jogos da fase foram finalizados! Crie a pr√≥xima fase.');
                }
              } catch (error) {
                console.error('Erro ao salvar placar:', error);
                alert('Erro ao salvar placar (ver console).');
              }
            });
          });

        } catch (error) {
          console.error('Erro ao mostrar jogos pendentes:', error);
          div.innerHTML = '<p class="text-red-600">Erro ao carregar jogos. Veja console.</p>';
        }
      }

      // helpers de fase
      function getVencedoresFase(modalidade, numeroFase, jogos) {
        const jogosData = jogos[modalidade] && jogos[modalidade][numeroFase.toString()] ? jogos[modalidade][numeroFase.toString()] : [];
        return (jogosData || []).map(j => (j.placar1 > j.placar2 ? j.jogador1 : j.jogador2));
      }
      function getPerdedoresFase(modalidade, numeroFase, jogos) {
        const jogosData = jogos[modalidade] && jogos[modalidade][numeroFase.toString()] ? jogos[modalidade][numeroFase.toString()] : [];
        return (jogosData || []).map(j => (j.placar1 < j.placar2 ? j.jogador1 : j.jogador2));
      }

      // acompanhar jogos (todas as fases)
      async function carregarAcompanhamento() {
        const div = document.getElementById('jogosAcompanhar');
        div.innerHTML = '';
        try {
          const jogos = await carregarJogos();
          if (!jogos || Object.keys(jogos).length === 0) {
            div.innerHTML = '<p class="text-gray-500">Nenhum jogo ainda. Crie uma fase na √°rea de Admin.</p>';
            return;
          }
          Object.keys(jogos).forEach(modalidade => {
            const modalidadeDiv = document.createElement('div');
            modalidadeDiv.className = 'p-4 border rounded-lg bg-white mb-4';
            let html = `<h3 class="font-bold text-lg mb-2">üèÜ ${modalidade}</h3>`;
            const fases = Object.keys(jogos[modalidade]).map(f => parseInt(f)).filter(n => !isNaN(n)).sort((a, b) => b - a);
            fases.forEach(faseNumero => {
              const jogosData = jogos[modalidade][faseNumero.toString()] || [];
              html += `<h4 class="font-semibold text-base mt-4 mb-2">Fase ${faseNumero}</h4>`;
              jogosData.forEach(jogo => {
                if (jogo.finalizado) {
                  html += `
                    <div class="flex items-center justify-between p-2 rounded bg-green-50 text-sm mb-1">
                      <span>${jogo.jogador1.nome} vs ${jogo.jogador2.nome}</span>
                      <span class="text-green-700 font-semibold">${jogo.placar1} x ${jogo.placar2}</span>
                    </div>
                  `;
                } else {
                  html += `
                    <div class="flex items-center justify-between p-2 rounded bg-yellow-50 text-sm mb-1">
                      <span>${jogo.jogador1.nome} vs ${jogo.jogador2.nome}</span>
                      <span class="text-orange-600 text-sm">Aguardando resultado</span>
                    </div>
                  `;
                }
              });
            });
            modalidadeDiv.innerHTML = html;
            div.appendChild(modalidadeDiv);
          });
        } catch (error) {
          console.error('Erro ao carregar acompanhamento:', error);
        }
      }

      // reset campeonato
      document.getElementById('resetBtn').onclick = async () => {
        if (confirm('‚ö†Ô∏è ATEN√á√ÉO: Isto apagar√° todas as fases, confrontos e placares!\n\nOs participantes inscritos ser√£o mantidos.\n\nDeseja continuar?')) {
          const senha = prompt('Digite a senha para confirmar:');
          if (senha === 'dpsp123') {
            try {
              await resetCampeonato();
              alert('‚úÖ Campeonato resetado com sucesso!');
              document.getElementById('faseAtual').innerHTML = '';
              document.getElementById('jogosPendentes').innerHTML = '';
              document.getElementById('jogosAcompanhar').innerHTML = '';
            } catch (error) {
              console.error('Erro ao resetar campeonato:', error);
              alert('Erro ao resetar campeonato (ver console).');
            }
          } else if (senha) {
            alert('Senha incorreta!');
          }
        }
      };

      // ===== Inicializa√ß√£o =====
      (async () => {
        await carregarDados();
        // mostrar tela de inscri√ß√£o ao abrir app
        showSection('inscricao');
      })();
    });
  </script>
</body>
</html>
