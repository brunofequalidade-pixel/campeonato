<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Sistema de Campeonato (Firestore)</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen p-4">
  <div class="max-w-6xl mx-auto">
    <h1 class="text-3xl font-bold text-center mb-6">Sistema de Campeonato üèÜ</h1>

    <div class="flex flex-wrap justify-center gap-2 mb-6">
      <button id="inscricaoBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">üìù Inscri√ß√µes</button>
      <button id="publicoBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg">üë• Lista P√∫blica</button>
      <button id="acompanharBtn" class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-lg">üìä Acompanhar</button>
      <button id="adminBtn" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg">‚öôÔ∏è Admin</button>
    </div>

    <section id="inscricaoSection" class="bg-white p-6 rounded-lg shadow mb-6">
      <h2 class="text-xl font-bold mb-4">Nova Inscri√ß√£o</h2>
      <form id="inscricaoForm" class="space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <input type="text" id="matricula" placeholder="Matr√≠cula" class="p-2 border rounded-lg" required>
          <input type="text" id="nome" placeholder="Nome completo" class="p-2 border rounded-lg" required>
          <input type="text" id="setor" placeholder="Setor" class="p-2 border rounded-lg" required>
          <input type="tel" id="telefone" placeholder="Telefone" class="p-2 border rounded-lg" required>
        </div>
        <div>
          <p class="font-semibold mb-2">Escolha suas modalidades:</p>
          <div id="modalidadesList" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2"></div>
        </div>
        <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg">Enviar Inscri√ß√£o</button>
      </form>
    </section>

    <section id="publicoSection" class="bg-white p-6 rounded-lg shadow mb-6 hidden">
      <h2 class="text-xl font-bold mb-4">Participantes Inscritos</h2>
      <div id="participantesList" class="space-y-3"></div>
    </section>

    <section id="acompanharSection" class="bg-white p-6 rounded-lg shadow mb-6 hidden">
      <h2 class="text-xl font-bold mb-4">Acompanhar Jogos</h2>
      <div id="jogosAcompanhar" class="space-y-4"></div>
    </section>

    <section id="adminSection" class="bg-white p-6 rounded-lg shadow mb-6 hidden">
      <h2 class="text-xl font-bold mb-4">√Årea Administrativa</h2>
      <div class="flex flex-wrap gap-2 mb-4">
        <button id="configTab" class="bg-gray-600 text-white px-3 py-1 rounded">Config</button>
        <button id="fasesTab" class="bg-gray-400 text-white px-3 py-1 rounded">Fases</button>
        <button id="placaresTab" class="bg-gray-400 text-white px-3 py-1 rounded">Placares</button>
        <button id="resetTab" class="bg-gray-400 text-white px-3 py-1 rounded">Reset</button>
      </div>

      <div id="configDiv" class="space-y-4">
        <div>
          <h3 class="font-semibold mb-2">Modalidades</h3>
          <div id="adminModalidadesList" class="space-y-2 mb-3"></div>
          <div class="flex gap-2">
            <input type="text" id="novaModalidade" placeholder="Nova modalidade" class="flex-1 p-2 border rounded">
            <button id="addModalidade" class="bg-green-600 text-white px-3 py-2 rounded">Add</button>
          </div>
        </div>
        <div>
          <h3 class="font-semibold mb-2">Limite por Participante</h3>
          <div class="flex gap-2">
            <input type="number" id="limiteInput" min="1" value="2" class="p-2 border rounded w-20">
            <button id="salvarLimite" class="bg-blue-600 text-white px-3 py-2 rounded">Salvar</button>
          </div>
        </div>
        <div>
          <button id="exportBtn" class="bg-indigo-600 text-white px-4 py-2 rounded mr-2">Exportar CSV</button>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full border text-sm">
            <thead class="bg-gray-200">
              <tr>
                <th class="border p-2">Nome</th>
                <th class="border p-2">Setor</th>
                <th class="border p-2">Modalidades</th>
                <th class="border p-2">A√ß√µes</th>
              </tr>
            </thead>
            <tbody id="tabelaInscritos"></tbody>
          </table>
        </div>
      </div>

      <div id="fasesDiv" class="hidden">
        <h3 class="font-semibold mb-2">Gerenciar Fases</h3>
        <select id="faseModalidade" class="p-2 border rounded mb-2 w-full md:w-auto"></select>
        <button id="criarFaseBtn" class="bg-green-600 text-white px-3 py-2 rounded">Criar Fase</button>
        <div id="listaFases" class="mt-4 space-y-2"></div>
      </div>

      <div id="placaresDiv" class="hidden">
        <h3 class="font-semibold mb-2">Atualizar Placares</h3>
        <select id="placarModalidade" class="p-2 border rounded mb-2 w-full md:w-auto"></select>
        <div id="listaJogos" class="space-y-2"></div>
      </div>

      <div id="resetDiv" class="hidden">
        <div class="bg-red-50 p-4 rounded border border-red-200">
          <h3 class="font-semibold text-red-800 mb-2">‚ö†Ô∏è Reset Campeonato</h3>
          <p class="text-red-700 mb-4">Apaga todos os inscritos, modalidades, fases e jogos.</p>
          <button id="resetBtn" class="bg-red-600 text-white px-4 py-2 rounded">Reset Completo</button>
        </div>
      </div>
    </section>
  </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
import { getFirestore, collection, doc, addDoc, getDocs, deleteDoc, setDoc, updateDoc, onSnapshot, query, where, getDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBo8G3ZcWk4EepN0cHdVBtXc7tGOfcw-yg",
  authDomain: "inscricaosinuca.firebaseapp.com",
  projectId: "inscricaosinuca",
  storageBucket: "inscricaosinuca.firebasestorage.app",
  messagingSenderId: "338241576305",
  appId: "1:338241576305:web:288b6124384c6be4f76ad0",
  measurementId: "G-PEDG30FS2R"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const inscritosCol = collection(db, "inscritos");
const modalidadesCol = collection(db, "modalidades");
const fasesCol = collection(db, "fases");
const jogosCol = collection(db, "jogos");
const configDocRef = doc(db, "config", "geral");

// --- NAVEGA√á√ÉO ---
function showSection(name){
  document.querySelectorAll('section').forEach(s=>s.classList.add('hidden'));
  document.getElementById(name+'Section').classList.remove('hidden');
}

document.getElementById('inscricaoBtn').addEventListener('click', ()=>showSection('inscricao'));
document.getElementById('publicoBtn').addEventListener('click', carregarListaPublica);
document.getElementById('acompanharBtn').addEventListener('click', carregarAcompanhar);
document.getElementById('adminBtn').addEventListener('click', async ()=>{
  const senha = prompt("Senha do administrador:");
  if(senha === 'dpsp123'){ 
    showSection('admin'); 
    carregarAdmin();
  } else if(senha){ 
    alert('Senha incorreta'); 
  }
});

function showAdminTab(tab){
  ['config','fases','placares','reset'].forEach(t=>{
    document.getElementById(t+'Div').classList.add('hidden');
    document.getElementById(t+'Tab').classList.replace('bg-gray-600','bg-gray-400');
  });
  document.getElementById(tab+'Div').classList.remove('hidden');
  document.getElementById(tab+'Tab').classList.replace('bg-gray-400','bg-gray-600');

  // Carrega dados da aba espec√≠fica ao ser aberta
  if(tab==='fases') carregarFasesAdmin();
  if(tab==='placares') carregarJogosAdmin();
}

document.getElementById('configTab').addEventListener('click', ()=>showAdminTab('config'));
document.getElementById('fasesTab').addEventListener('click', ()=>showAdminTab('fases'));
document.getElementById('placaresTab').addEventListener('click', ()=>showAdminTab('placares'));
document.getElementById('resetTab').addEventListener('click', ()=>showAdminTab('reset'));


// --- CONFIG GERAL (MODALIDADES E LIMITE) ---
let limite = 2;
async function carregarConfigGeral(){
  try{
    const snap = await getDoc(configDocRef);
    if(snap.exists()){
      const data = snap.data();
      limite = data?.limite||2;
    } else {
      await setDoc(configDocRef,{limite:2});
      limite=2;
    }
    document.getElementById('limiteInput').value = limite;
  }catch(e){ console.error("Erro ao carregar config:", e); }
}

async function carregarModalidades(){
  const snap = await getDocs(modalidadesCol);
  const arr = snap.docs.map(d=>({id:d.id,...d.data()})).sort((a,b)=>a.nome.localeCompare(b.nome));
  
  const listaInscricao = document.getElementById('modalidadesList');
  const listaAdmin = document.getElementById('adminModalidadesList');
  const selectFase = document.getElementById('faseModalidade');
  const selectPlacar = document.getElementById('placarModalidade');
  
  listaInscricao.innerHTML=''; 
  listaAdmin.innerHTML=''; 
  selectFase.innerHTML='<option value="">Todas as Modalidades</option>'; 
  selectPlacar.innerHTML='<option value="">Selecione a Modalidade</option>';
  
  arr.forEach(m=>{
    listaInscricao.insertAdjacentHTML('beforeend', `<label class="flex items-center gap-2 p-2 border rounded cursor-pointer"><input type="checkbox" value="${m.nome}"> ${m.nome}</label>`);
    listaAdmin.insertAdjacentHTML('beforeend', `<div class="flex justify-between items-center p-2 border rounded"><span>${m.nome}</span><button class="text-red-600 px-2" data-id="${m.id}">üóëÔ∏è</button></div>`);
    selectFase.insertAdjacentHTML('beforeend', `<option value="${m.nome}">${m.nome}</option>`);
    selectPlacar.insertAdjacentHTML('beforeend', `<option value="${m.nome}">${m.nome}</option>`);
  });

  listaAdmin.querySelectorAll('button[data-id]').forEach(btn=>{
    btn.onclick = async ()=>{
      if(!confirm('Remover esta modalidade?')) return;
      await deleteDoc(doc(db,'modalidades',btn.dataset.id));
      carregarModalidades(); // Recarrega a lista
    }
  });
}

document.getElementById('addModalidade').addEventListener('click', async ()=>{
  const nomeInput = document.getElementById('novaModalidade');
  const nome = nomeInput.value.trim();
  if(!nome) return alert('Digite o nome da modalidade.');
  const snap = await getDocs(query(modalidadesCol, where("nome", "==", nome)));
  if(!snap.empty) return alert('Essa modalidade j√° existe.');
  await addDoc(modalidadesCol,{nome});
  nomeInput.value='';
  carregarModalidades();
});

document.getElementById('salvarLimite').addEventListener('click', async ()=>{
  const novoLimite = parseInt(document.getElementById('limiteInput').value) || 2;
  await setDoc(configDocRef,{limite: novoLimite},{merge:true});
  limite = novoLimite;
  alert('Limite salvo com sucesso!');
});


// --- INSCRI√á√ïES ---
document.getElementById('inscricaoForm').addEventListener('submit', async e=>{
  e.preventDefault();
  try{
    const matricula = document.getElementById('matricula').value.trim();
    const nome = document.getElementById('nome').value.trim();
    const setor = document.getElementById('setor').value.trim();
    const telefone = document.getElementById('telefone').value.trim();
    const escolhidas = Array.from(document.querySelectorAll('#modalidadesList input:checked')).map(i=>i.value);
    
    if(!matricula||!nome||!setor||!telefone) return alert('Por favor, preencha todos os campos.');
    if(escolhidas.length === 0 || escolhidas.length > limite) return alert(`Escolha entre 1 e ${limite} modalidades.`);
    
    const q = query(inscritosCol, where("matricula", "==", matricula));
    const userSnap = await getDocs(q);
    if(!userSnap.empty) return alert('Esta matr√≠cula j√° est√° inscrita.');

    await addDoc(inscritosCol, {matricula, nome, setor, telefone, modalidades: escolhidas, criado: new Date().toISOString()});
    alert('Inscri√ß√£o realizada com sucesso!');
    e.target.reset();
  }catch(err){ 
    console.error("Erro ao salvar inscri√ß√£o:", err); 
    alert('Ocorreu um erro ao salvar a inscri√ß√£o.'); 
  }
});


// --- LISTA P√öBLICA & ACOMPANHAMENTO ---
async function carregarListaPublica(){
  showSection('publico');
  const snap = await getDocs(inscritosCol);
  const div = document.getElementById('participantesList');
  div.innerHTML='';
  if(snap.empty){ 
    div.innerHTML='<p class="text-gray-500">Nenhum participante inscrito ainda.</p>'; 
    return; 
  }
  const arr = snap.docs.map(d=>({id:d.id, ...d.data()})).sort((a,b)=>a.nome.localeCompare(b.nome));
  arr.forEach(p=>{
    div.insertAdjacentHTML('beforeend', `<div class="p-3 border rounded-lg bg-white"><h3 class="font-semibold">${p.nome}</h3><p class="text-gray-600 text-sm">${p.setor}</p><p class="text-sm text-blue-600 mt-1">Modalidades: ${(p.modalidades||[]).join(', ')}</p></div>`);
  });
}

// ‚úÖ FUN√á√ÉO CRIADA
async function carregarAcompanhar() {
    showSection('acompanhar');
    const jogosDiv = document.getElementById('jogosAcompanhar');
    jogosDiv.innerHTML = '<p class="text-gray-500">Carregando jogos...</p>';
    
    try {
        const snap = await getDocs(jogosCol);
        if (snap.empty) {
            jogosDiv.innerHTML = '<p class="text-gray-500">Ainda n√£o h√° jogos definidos.</p>';
            return;
        }

        const jogosPorModalidade = {};
        snap.forEach(doc => {
            const jogo = doc.data();
            if (!jogosPorModalidade[jogo.modalidade]) {
                jogosPorModalidade[jogo.modalidade] = [];
            }
            jogosPorModalidade[jogo.modalidade].push(jogo);
        });

        let html = '';
        for (const modalidade in jogosPorModalidade) {
            html += `<h3 class="text-lg font-bold mt-4 border-b pb-1">${modalidade}</h3>`;
            jogosPorModalidade[modalidade].forEach(j => {
                html += `<div class="p-3 border rounded-lg flex justify-between items-center">
                    <span>${j.jogador1} vs ${j.jogador2}</span>
                    <span class="font-bold text-lg">${j.placar1 || 0} x ${j.placar2 || 0}</span>
                </div>`;
            });
        }
        jogosDiv.innerHTML = html;
    } catch (e) {
        console.error("Erro ao carregar jogos para acompanhamento:", e);
        jogosDiv.innerHTML = '<p class="text-red-500">Erro ao carregar os jogos.</p>';
    }
}


// --- ADMIN ---
function carregarAdmin(){
  showAdminTab('config');
  // Aqui voc√™ pode carregar outras coisas que a √°rea admin precisa
}

/* ---------- ADMIN: FASES ---------- */
// ‚úÖ CORRIGIDO: Agora filtra dinamicamente
async function carregarFasesAdmin(){
  const modalidadeSelecionada = document.getElementById('faseModalidade').value;
  const listaFases = document.getElementById('listaFases');
  listaFases.innerHTML = '<p>Carregando...</p>';

  const snap = await getDocs(fasesCol);
  
  const fasesFiltradas = snap.docs
    .map(doc => ({id: doc.id, ...doc.data()}))
    .filter(f => !modalidadeSelecionada || f.modalidade === modalidadeSelecionada)
    .sort((a,b) => `${a.modalidade}-${a.numero}`.localeCompare(`${b.modalidade}-${b.numero}`));

  if (fasesFiltradas.length === 0) {
    listaFases.innerHTML = '<p class="text-gray-500">Nenhuma fase criada para esta modalidade.</p>';
    return;
  }

  listaFases.innerHTML = '';
  fasesFiltradas.forEach(f=>{
    listaFases.insertAdjacentHTML('beforeend', `<div class="p-2 border rounded">Modalidade: <strong>${f.modalidade}</strong> ‚Äî Fase: <strong>${f.numero}</strong> ‚Äî Jogadores: <strong>${f.players.length}</strong></div>`);
  });
}

document.getElementById('criarFaseBtn').addEventListener('click', async ()=>{
  const modalidade = document.getElementById('faseModalidade').value;
  if(!modalidade) return alert('Selecione uma modalidade para criar a fase.');
  
  const inscritosSnap = await getDocs(query(inscritosCol, where("modalidades", "array-contains", modalidade)));
  let players = inscritosSnap.docs.map(d=>({id:d.id, nome: d.data().nome}));
  
  if(players.length < 2) return alert('N√£o h√° participantes suficientes nesta modalidade para criar uma fase.');

  const fasesSnap = await getDocs(query(fasesCol, where("modalidade", "==", modalidade)));
  const numero = fasesSnap.docs.length + 1;

  // Embaralhar jogadores para confrontos aleat√≥rios
  players.sort(() => Math.random() - 0.5);

  // Criar confrontos
  const batch = writeBatch(db);
  for (let i = 0; i < players.length; i += 2) {
      if (players[i+1]) { // Garante que h√° um oponente
          const jogoRef = doc(jogosCol); // Cria uma refer√™ncia para um novo documento de jogo
          batch.set(jogoRef, {
              modalidade: modalidade,
              fase: numero,
              jogador1: players[i].nome,
              jogador2: players[i+1].nome,
              placar1: 0,
              placar2: 0,
              finalizado: false
          });
      }
  }

  await batch.commit(); // Envia todos os jogos de uma vez
  await addDoc(fasesCol, {modalidade, numero, players: players.map(p => p.nome)}); // Salva a fase
  
  alert(`Fase ${numero} para ${modalidade} criada com sucesso e jogos gerados!`);
  carregarFasesAdmin();
  carregarJogosAdmin(); // Atualiza a lista de jogos
});

// ‚úÖ ADICIONADO: Event listener para o select de fases
document.getElementById('faseModalidade').addEventListener('change', carregarFasesAdmin);

/* ---------- ADMIN: PLACARES ---------- */
// ‚úÖ CORRIGIDO: L√≥gica da fun√ß√£o est√° OK, o problema era a falta do gatilho 'change'
async function carregarJogosAdmin(){
  const modalidade = document.getElementById('placarModalidade').value;
  const lista = document.getElementById('listaJogos');
  lista.innerHTML='';
  
  if(!modalidade) {
    lista.innerHTML = '<p class="text-gray-500">Selecione uma modalidade para ver os jogos.</p>';
    return;
  }

  lista.innerHTML = '<p>Carregando jogos...</p>';
  const q = query(jogosCol, where('modalidade','==', modalidade));
  const snap = await getDocs(q);
  
  if(snap.empty){ 
    lista.innerHTML='<p class="text-gray-500">Nenhum jogo cadastrado para esta modalidade.</p>'; 
    return; 
  }

  lista.innerHTML = ''; // Limpa o "carregando"
  const jogos = snap.docs.map(doc => ({id: doc.id, ...doc.data()}));
  
  jogos.forEach(j=>{
    lista.insertAdjacentHTML('beforeend', `<div class="p-3 border rounded flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2">
      <div class="font-medium">${j.jogador1} <span class="text-gray-500">vs</span> ${j.jogador2} <br> <span class="font-bold text-xl">${j.placar1||0} x ${j.placar2||0}</span></div>
      <div class="flex gap-2 flex-wrap">
        <button class="bg-blue-500 text-white px-2 py-1 text-sm rounded" data-id="${j.id}" data-p="1" data-op="inc">+1 ${j.jogador1}</button>
        <button class="bg-gray-400 text-white px-2 py-1 text-sm rounded" data-id="${j.id}" data-p="1" data-op="dec">-1</button>
        <button class="bg-blue-500 text-white px-2 py-1 text-sm rounded" data-id="${j.id}" data-p="2" data-op="inc">+1 ${j.jogador2}</button>
        <button class="bg-gray-400 text-white px-2 py-1 text-sm rounded" data-id="${j.id}" data-p="2" data-op="dec">-1</button>
      </div>
    </div>`);
  });
  
  lista.querySelectorAll('button').forEach(btn=>{
    btn.onclick = async ()=>{
      const id = btn.dataset.id;
      const player = btn.dataset.p;
      const operation = btn.dataset.op;
      const docRef = doc(db,'jogos',id);
      const docSnap = await getDoc(docRef);

      if(!docSnap.exists()) return;
      const data = docSnap.data();
      const placarAtual = data['placar'+player] || 0;
      
      const update = {};
      if (operation === 'inc') {
          update['placar'+player] = placarAtual + 1;
      } else if (operation === 'dec' && placarAtual > 0) {
          update['placar'+player] = placarAtual - 1;
      }
      
      await updateDoc(docRef, update);
      carregarJogosAdmin(); // Recarrega a lista para mostrar a atualiza√ß√£o
    }
  });
}

// ‚úÖ ADICIONADO: Event listener para o select de placares
document.getElementById('placarModalidade').addEventListener('change', carregarJogosAdmin);

/* ---------- ADMIN: EXPORTAR E RESET ---------- */
document.getElementById('exportBtn').addEventListener('click', async ()=>{
  const snap = await getDocs(inscritosCol);
  let csv = 'Nome,Setor,Telefone,Modalidades\n';
  snap.forEach(d=>{
    const p = d.data();
    csv += `"${p.nome}","${p.setor}","${p.telefone}","${(p.modalidades||[]).join(' | ')}"\n`;
  });
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'inscritos_campeonato.csv';
  a.click();
  URL.revokeObjectURL(a.href);
});

document.getElementById('resetBtn').addEventListener('click', async ()=>{
  if(!confirm('‚ö†Ô∏è ATEN√á√ÉO! ‚ö†Ô∏è\n\nIsso apagar√° TODOS os inscritos, modalidades, fases e jogos.\n\nEsta a√ß√£o n√£o pode ser desfeita. Deseja continuar?')) return;
  
  const colls=['inscritos','modalidades','fases','jogos'];
  try {
    for(const c of colls){
      const snap=await getDocs(collection(db,c));
      for(const d of snap.docs) await deleteDoc(doc(db,c,d.id));
    }
    // Deleta tamb√©m o documento de config
    await deleteDoc(configDocRef);
    alert('Reset completo do campeonato realizado com sucesso.');
    // Recarrega tudo para refletir o estado vazio
    carregarConfigGeral();
    carregarModalidades();
    carregarListaPublica();
    carregarFasesAdmin();
  } catch(e) {
    console.error("Erro no reset:", e);
    alert("Ocorreu um erro durante o reset.");
  }
});


// --- INICIALIZA√á√ÉO ---
carregarConfigGeral();
carregarModalidades();

</script>
</body>
</html>
