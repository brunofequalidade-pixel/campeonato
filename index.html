<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sistema de Campeonato com Chat e Notificações</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen p-4">
  <div class="max-w-6xl mx-auto">
    <h1 class="text-3xl font-bold text-center mb-6">Sistema de Campeonato 🏆</h1>

    <div class="flex justify-center gap-2 mb-6">
      <button id="chatBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg">💬 Chat</button>
    </div>

    <section id="chatSection" class="bg-white p-6 rounded-lg shadow">
      <h2 class="text-xl font-bold mb-4">💬 Chat dos Participantes</h2>
      <div id="mensagensContainer" class="border rounded-lg p-4 h-96 overflow-y-auto bg-gray-50 space-y-3"></div>
      <form id="enviarMensagemForm" class="mt-4">
        <textarea id="mensagemTexto" placeholder="Digite sua mensagem..." class="w-full p-3 border rounded-lg resize-none" rows="3"></textarea>
        <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 mt-2 rounded-lg">Enviar</button>
      </form>
    </section>
  </div>

  <audio id="somNotificacao" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" preload="auto"></audio>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBo8G3ZcWk4EepN0cHdVBtXc7tGOfcw-yg",
      authDomain: "inscricaosinuca.firebaseapp.com",
      projectId: "inscricaosinuca",
      storageBucket: "inscricaosinuca.firebasestorage.app",
      messagingSenderId: "338241576305",
      appId: "1:338241576305:web:288b6124384c6be4f76ad0"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const mensagensCol = collection(db, "mensagens");

    const mensagensContainer = document.getElementById('mensagensContainer');
    const chatBtn = document.getElementById('chatBtn');
    const somNotificacao = document.getElementById('somNotificacao');

    let mensagensNaoLidas = 0;
    let chatAberto = true;

    chatBtn.addEventListener('click', () => {
      mensagensNaoLidas = 0;
      atualizarNotificacaoChat();
      chatAberto = true;
    });

    function atualizarNotificacaoChat() {
      if (mensagensNaoLidas > 0) {
        chatBtn.textContent = `💬 Chat (${mensagensNaoLidas})`;
      } else {
        chatBtn.textContent = '💬 Chat';
      }
    }

    function mostrarNotificacao(titulo, corpo) {
      if (Notification.permission === "granted") {
        new Notification(titulo, { body: corpo });
      } else if (Notification.permission !== "denied") {
        Notification.requestPermission().then(permissao => {
          if (permissao === "granted") {
            new Notification(titulo, { body: corpo });
          }
        });
      }
    }

    const q = query(mensagensCol, orderBy('timestamp', 'desc'), limit(50));
    onSnapshot(q, (snapshot) => {
      const mensagens = snapshot.docChanges().filter(c => c.type === 'added');
      mensagens.forEach(change => {
        const msg = change.doc.data();
        mensagensContainer.insertAdjacentHTML('beforeend', `<div class="p-2 border rounded bg-white"><strong>${msg.nome || 'Anônimo'}:</strong> ${msg.texto}</div>`);
        mensagensContainer.scrollTop = mensagensContainer.scrollHeight;

        if (!chatAberto) {
          mensagensNaoLidas++;
          atualizarNotificacaoChat();
          somNotificacao.play();
          mostrarNotificacao('Nova mensagem no chat', `${msg.nome || 'Anônimo'}: ${msg.texto}`);
        }
      });
    });

    document.getElementById('enviarMensagemForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const texto = document.getElementById('mensagemTexto').value.trim();
      if (!texto) return;
      await addDoc(mensagensCol, {
        nome: 'Usuário Teste',
        texto,
        timestamp: new Date().toISOString()
      });
      document.getElementById('mensagemTexto').value = '';
    });

    window.addEventListener('blur', () => chatAberto = false);
    window.addEventListener('focus', () => {
      chatAberto = true;
      mensagensNaoLidas = 0;
      atualizarNotificacaoChat();
    });
  </script>
</body>
</html>
