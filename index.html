<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Sistema de Campeonato (Firestore) - Duplas Manuais (Corrigido)</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen p-4">
    <div class="max-w-6xl mx-auto">
        <h1 class="text-3xl font-bold text-center mb-6">Sistema de Campeonato üèÜ (Duplas Manuais)</h1>

        <div class="flex flex-wrap justify-center gap-2 mb-6">
            <button id="inscricaoBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">üìù Inscri√ß√µes</button>
            <button id="publicoBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg">üë• Lista P√∫blica</button>
            <button id="acompanharBtn" class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-lg">üìä Acompanhar</button>
            <button id="adminBtn" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg">‚öôÔ∏è Admin</button>
        </div>

        <!-- Se√ß√µes m√≠nimas para evitar erros ao trocar de se√ß√£o -->
        <section id="inscricaoSection" class="bg-white p-6 rounded-lg shadow mb-6 hidden">
            <h2 class="text-xl font-bold mb-4">Inscri√ß√µes (placeholder)</h2>
            <p class="text-gray-600">Formul√°rio de inscri√ß√£o n√£o est√° totalmente implementado nesta vers√£o de corre√ß√£o. Use Admin para criar duplas e confrontos.</p>
        </section>

        <section id="publicoSection" class="bg-white p-6 rounded-lg shadow mb-6 hidden">
            <h2 class="text-xl font-bold mb-4">Participantes Inscritos</h2>
            <div id="participantesList" class="space-y-3"></div>
        </section>

        <section id="acompanharSection" class="bg-white p-6 rounded-lg shadow mb-6 hidden">
            <h2 class="text-xl font-bold mb-4">Acompanhar Jogos</h2>
            <div id="jogosAcompanhar" class="space-y-4"></div>
        </section>

        <!-- Painel Admin -->
        <section id="adminSection" class="bg-white p-6 rounded-lg shadow mb-6 hidden">
            <h2 class="text-xl font-bold mb-4">√Årea Administrativa</h2>
            
            <div class="mb-6">
                <h3 class="font-semibold mb-2">Escolher Modalidade</h3>
                <select id="faseModalidade" class="p-2 border rounded mb-4 w-full md:w-auto"></select>
                <button id="carregarJogadoresBtn" class="bg-blue-600 text-white px-4 py-2 rounded">Carregar Jogadores</button>
            </div>

            <div id="jogadoresDisponiveis" class="mb-6">
                <h3 class="font-semibold mb-2">Jogadores Dispon√≠veis</h3>
                <div id="listaJogadores" class="flex flex-wrap gap-2"></div>
            </div>

            <div id="duplasCriadasDiv" class="mb-6">
                <h3 class="font-semibold mb-2">Duplas Criadas</h3>
                <div id="listaDuplas" class="space-y-2"></div>
                <button id="gerarConfrontosBtn" class="mt-4 bg-green-600 text-white px-4 py-2 rounded">Gerar Confrontos</button>
            </div>
        </section>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
        import { getFirestore, collection, doc, addDoc, getDocs, query, where } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-firestore.js";

        // CONFIG FIREBASE (mantive seu config)
        const firebaseConfig = {
            apiKey: "AIzaSyBo8G3ZcWk4EepN0cHdVBtXc7tGOfcw-yg",
            authDomain: "inscricaosinuca.firebaseapp.com",
            projectId: "inscricaosinuca",
            storageBucket: "inscricaosinuca.firebasestorage.app",
            messagingSenderId: "338241576305",
            appId: "1:338241576305:web:288b6124384c6be4f76ad0"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const inscritosCol = collection(db, "inscritos");
        const duplasCol = collection(db, "duplas");
        const jogosCol = collection(db, "jogos");

        // --- Fun√ß√£o segura para alternar se√ß√µes ---
        function showSection(name) {
            document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
            const el = document.getElementById(name + 'Section');
            if (!el) {
                console.warn('Se√ß√£o n√£o encontrada:', name + 'Section');
                return;
            }
            el.classList.remove('hidden');
        }

        // --- Listeners dos bot√µes do topo ---
        document.getElementById('inscricaoBtn').addEventListener('click', () => showSection('inscricao'));
        document.getElementById('publicoBtn').addEventListener('click', carregarListaPublica);
        document.getElementById('acompanharBtn').addEventListener('click', carregarAcompanhar);

        document.getElementById('adminBtn').addEventListener('click', async () => {
            const senha = prompt("Senha do administrador:");
            if (senha === 'caio') {
                showSection('admin');
                carregarModalidades();
            } else if (senha) {
                alert('Senha incorreta');
            }
        });

        // --- Carregar modalidades (para select) ---
        async function carregarModalidades() {
            try {
                const snap = await getDocs(collection(db, "modalidades"));
                const arr = snap.docs.map(d => d.data());
                const select = document.getElementById('faseModalidade');
                select.innerHTML = '<option value="">Selecione</option>';
                arr.forEach(m => select.insertAdjacentHTML('beforeend', `<option value="${m.nome}">${m.nome}</option>`));
            } catch (e) {
                console.error('Erro ao carregar modalidades:', e);
            }
        }

        // --- Lista p√∫blica ---
        async function carregarListaPublica() {
            showSection('publico');
            const div = document.getElementById('participantesList');
            div.innerHTML = '<p class="text-gray-500">Carregando...</p>';
            try {
                const snap = await getDocs(query(inscritosCol));
                if (snap.empty) {
                    div.innerHTML = '<p class="text-gray-500">Nenhum participante inscrito ainda.</p>';
                    return;
                }
                div.innerHTML = '';
                snap.docs.map(d => d.data()).sort((a,b)=>a.nome.localeCompare(b.nome,'pt-BR')).forEach(p => {
                    div.insertAdjacentHTML('beforeend', `<div class="p-3 border rounded-lg bg-white"><h3 class="font-semibold">${p.nome}</h3><p class="text-gray-600 text-sm">${p.setor}</p><p class="text-sm text-blue-600 mt-1">Modalidades: ${p.modalidades.join(', ')}</p></div>`);
                });
            } catch (e) {
                console.error('Erro ao carregar participantes:', e);
                div.innerHTML = '<p class="text-red-600">Erro ao carregar participantes. Veja o console.</p>';
            }
        }

        // --- Acompanhar jogos ---
        async function carregarAcompanhar() {
            showSection('acompanhar');
            const jogosDiv = document.getElementById('jogosAcompanhar');
            jogosDiv.innerHTML = '<p class="text-gray-500">Carregando jogos...</p>';
            try {
                const snap = await getDocs(jogosCol);
                if (snap.empty) {
                    jogosDiv.innerHTML = '<p class="text-gray-500">Ainda n√£o h√° jogos definidos.</p>';
                    return;
                }
                jogosDiv.innerHTML = '';
                snap.docs.map(d => d.data()).forEach(j => {
                    jogosDiv.insertAdjacentHTML('beforeend', `<div class="p-3 border rounded-lg bg-white mb-2">${j.dupla1} <strong>${j.placar1||0}</strong> x <strong>${j.placar2||0}</strong> ${j.dupla2}</div>`);
                });
            } catch (e) {
                console.error('Erro ao carregar jogos:', e);
                jogosDiv.innerHTML = '<p class="text-red-600">Erro ao carregar jogos. Veja o console.</p>';
            }
        }

        // --- Admin: carregar jogadores da modalidade selecionada ---
        document.getElementById('carregarJogadoresBtn').addEventListener('click', async () => {
            const modalidade = document.getElementById('faseModalidade').value;
            if (!modalidade) return alert('Selecione uma modalidade');
            const lista = document.getElementById('listaJogadores');
            lista.innerHTML = '<div class="p-2 text-gray-500">Carregando jogadores...</div>';
            try {
                const snap = await getDocs(query(inscritosCol, where('modalidades','array-contains', modalidade)));
                lista.innerHTML = '';
                if (snap.empty) {
                    lista.innerHTML = '<div class="p-2 text-gray-500">Nenhum inscrito para esta modalidade.</div>';
                    return;
                }
                snap.docs.forEach(d => {
                    const p = d.data();
                    const div = document.createElement('div');
                    div.className = 'p-2 border rounded cursor-pointer bg-white hover:bg-gray-200';
                    div.textContent = p.nome;
                    div.dataset.nome = p.nome;
                    div.onclick = () => selecionarJogadorElemento(div, modalidade);
                    lista.appendChild(div);
                });
            } catch (e) {
                console.error('Erro ao carregar jogadores:', e);
                lista.innerHTML = '<div class="p-2 text-red-600">Erro ao carregar. Veja o console.</div>';
            }
        });

        // Estado local
        let jogadoresSelecionados = [];
        let duplas = [];

        function selecionarJogadorElemento(div, modalidade) {
            const nome = div.dataset.nome;
            // evitar selecionar o mesmo jogador duas vezes
            if (jogadoresSelecionados.includes(nome)) {
                // desmarca
                jogadoresSelecionados = jogadoresSelecionados.filter(n => n !== nome);
                div.classList.remove('bg-green-100', 'border-green-400');
                return;
            }
            // marca
            jogadoresSelecionados.push(nome);
            div.classList.add('bg-green-100', 'border-green-400');

            if (jogadoresSelecionados.length === 2) {
                const dupla = { modalidade, fase: 1, nomes: [...jogadoresSelecionados] };
                duplas.push(dupla);
                // limpa sele√ß√£o visual
                document.querySelectorAll('#listaJogadores div').forEach(el => el.classList.remove('bg-green-100','border-green-400'));
                jogadoresSelecionados = [];
                atualizarListaDuplas();
            }
        }

        function atualizarListaDuplas() {
            const lista = document.getElementById('listaDuplas');
            lista.innerHTML = '';
            duplas.forEach((d, i) => {
                lista.insertAdjacentHTML('beforeend', `<div class="p-2 border rounded bg-gray-50">Dupla ${i+1}: ${d.nomes.join(' + ')}</div>`);
            });
        }

        // --- Gerar confrontos a partir das duplas criadas ---
        document.getElementById('gerarConfrontosBtn').addEventListener('click', async () => {
            if (duplas.length < 2) return alert('Crie pelo menos 2 duplas para gerar confrontos.');
            try {
                for (let i = 0; i < duplas.length; i += 2) {
                    if (i + 1 >= duplas.length) break;
                    const d1 = duplas[i];
                    const d2 = duplas[i + 1];
                    await addDoc(jogosCol, {
                        modalidade: d1.modalidade,
                        fase: d1.fase,
                        dupla1: d1.nomes.join(' + '),
                        dupla2: d2.nomes.join(' + '),
                        placar1: 0,
                        placar2: 0,
                        finalizado: false
                    });
                }
                alert('Confrontos criados com sucesso!');
                duplas = [];
                atualizarListaDuplas();
            } catch (e) {
                console.error('Erro ao criar confrontos:', e);
                alert('Erro ao criar confrontos. Veja o console para mais detalhes.');
            }
        });

        // --- Ajuda para debugar erros de import quando abrir localmente ---
        window.addEventListener('error', e => {
            console.error('Erro global capturado:', e.error || e.message || e);
        });

        // Inicia carregando modalidades (se houver)
        carregarModalidades();

        // Sugest√£o √∫til caso nada funcione:
        // Se voc√™ abriu o arquivo diretamente (file://...), alguns navegadores bloqueiam imports ES modules.
        // Rode um servidor local e abra via http://localhost:8000/arquivo.html
        // Exemplo r√°pido (Python):
        //   python -m http.server 8000
        // Depois acesse: http://localhost:8000/

    </script>
</body>
</html>
