<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Campeonato - Inscri√ß√µes & Confrontos</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen p-6">
  <div class="max-w-4xl mx-auto">
    <header class="flex items-center justify-between mb-6">
      <h1 class="text-2xl font-bold">Campeonato üéÆ ‚Äî Inscri√ß√µes & Acompanhamento</h1>
      <div class="flex gap-2">
        <button id="toggleButton" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">Nova Inscri√ß√£o</button>
        <button id="followBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">Acompanhar Campeonato</button>
        <button id="adminButton" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded">√Årea do ADM</button>
      </div>
    </header>

    <!-- Inscri√ß√£o -->
    <section id="formSection" class="hidden bg-white p-6 rounded shadow mb-6">
      <form id="registrationForm" class="space-y-4">
        <div>
          <label class="block text-sm font-medium">Matr√≠cula</label>
          <input id="matricula" class="w-full p-2 border rounded" required />
        </div>
        <div>
          <label class="block text-sm font-medium">Nome completo</label>
          <input id="nome" class="w-full p-2 border rounded" required />
        </div>
        <div>
          <label class="block text-sm font-medium">Setor</label>
          <input id="setor" class="w-full p-2 border rounded" required />
        </div>
        <div>
          <label class="block text-sm font-medium">Telefone (apenas ADM ver√°)</label>
          <input id="telefone" class="w-full p-2 border rounded" placeholder="(99) 99999-9999" required />
        </div>

        <div>
          <p class="font-semibold mb-1">Escolha suas modalidades</p>
          <div id="modalidadesList" class="grid grid-cols-2 gap-2"></div>
          <p id="modalidadeInfo" class="text-xs text-gray-500 mt-1"></p>
        </div>

        <div class="flex gap-2">
          <button type="submit" id="submitBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">Enviar Inscri√ß√£o</button>
          <button type="button" id="cancelBtn" class="bg-gray-300 hover:bg-gray-400 px-4 py-2 rounded">Cancelar</button>
        </div>
      </form>
    </section>

    <!-- Lista p√∫blica de inscritos -->
    <section id="listSection" class="bg-white p-6 rounded shadow mb-6">
      <h2 class="text-lg font-semibold mb-3">Participantes inscritos</h2>
      <div id="loadingMessage" class="text-sm text-gray-500 mb-2">Carregando participantes...</div>
      <div id="participantList" class="space-y-3"></div>
    </section>

    <!-- Acompanhamento (confrontos) p√∫blico -->
    <section id="followSection" class="hidden bg-white p-6 rounded shadow mb-6">
      <h2 class="text-lg font-semibold mb-3">Acompanhar Campeonato ‚Äî Confrontos</h2>
      <div id="confrontosList" class="space-y-3"></div>
    </section>

    <!-- Painel Admin -->
    <section id="adminSection" class="hidden bg-white p-6 rounded shadow mb-6">
      <h2 class="text-lg font-semibold mb-3">Painel do Administrador</h2>

      <!-- Modalidades -->
      <div class="mb-4">
        <h3 class="font-medium">Modalidades</h3>
        <div id="adminModalidadesList" class="space-y-2 mb-2"></div>
        <div class="flex gap-2">
          <input id="novaModalidade" class="flex-1 p-2 border rounded" placeholder="Nova modalidade" />
          <button id="addModalidade" class="bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded">Adicionar</button>
        </div>
      </div>

      <!-- Config -->
      <div class="mb-4">
        <h3 class="font-medium">Configura√ß√µes</h3>
        <div class="flex items-center gap-2">
          <label>M√°ximo de modalidades por participante:</label>
          <input id="limiteModalidades" type="number" min="1" class="w-20 p-2 border rounded" />
          <button id="salvarLimite" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded">Salvar</button>
        </div>
      </div>

      <!-- Confrontos ADM -->
      <div class="mb-4">
        <h3 class="font-medium">Gerenciar Confrontos</h3>
        <div class="grid grid-cols-2 gap-2 mb-2">
          <select id="selectJogadorA" class="p-2 border rounded w-full"><option value="">Jogador A</option></select>
          <select id="selectJogadorB" class="p-2 border rounded w-full"><option value="">Jogador B</option></select>
        </div>
        <div class="flex gap-2 mb-2">
          <input id="dataConfronto" type="date" class="p-2 border rounded" />
          <input id="placarConfronto" placeholder="Placar (ex: 3x2)" class="p-2 border rounded w-full" />
        </div>
        <div class="flex gap-2 mb-4">
          <button id="addConfronto" class="bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-2 rounded">Salvar Confronto</button>
          <button id="refreshAdmin" class="bg-gray-200 hover:bg-gray-300 px-3 py-2 rounded">Atualizar listas</button>
        </div>
      </div>

      <!-- Lista completa de inscritos (ADM v√™ matr√≠cula e telefone) -->
      <div class="mb-4">
        <h3 class="font-medium">Inscritos (com Matr√≠cula e Telefone)</h3>
        <div id="adminList" class="space-y-2 mb-2"></div>
        <button id="exportCSV" class="bg-yellow-600 hover:bg-yellow-700 text-white px-3 py-2 rounded">üì• Exportar CSV</button>
      </div>

      <!-- Lista de confrontos ADM -->
      <div>
        <h3 class="font-medium">Confrontos Cadastrados</h3>
        <div id="adminConfrontos" class="space-y-2 mt-2"></div>
      </div>
    </section>
  </div>

  <script type="module">
    // Firebase imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
    import {
      getFirestore, collection, addDoc, doc, setDoc, getDoc, getDocs,
      query, orderBy, onSnapshot, where, deleteDoc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";

    // ===== CONFIGURE AQUI SUA CHAVE FIREBASE (j√° preenchida) =====
    const firebaseConfig = {
      apiKey: "AIzaSyBo8G3ZcWk4EepN0cHdVBtXc7tGOfcw-yg",
      authDomain: "inscricaosinuca.firebaseapp.com",
      projectId: "inscricaosinuca",
      storageBucket: "inscricaosinuca.firebasestorage.app",
      messagingSenderId: "338241576305",
      appId: "1:338241576305:web:288b6124384c6be4f76ad0",
      measurementId: "G-PEDG30FS2R"
    };
    // =============================================================

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // DOM
    const toggleButton = document.getElementById('toggleButton');
    const followBtn = document.getElementById('followBtn');
    const adminButton = document.getElementById('adminButton');

    const formSection = document.getElementById('formSection');
    const registrationForm = document.getElementById('registrationForm');
    const cancelBtn = document.getElementById('cancelBtn');
    const modalidadesList = document.getElementById('modalidadesList');
    const modalidadeInfo = document.getElementById('modalidadeInfo');

    const listSection = document.getElementById('listSection');
    const participantList = document.getElementById('participantList');
    const loadingMessage = document.getElementById('loadingMessage');

    const followSection = document.getElementById('followSection');
    const confrontosList = document.getElementById('confrontosList');

    const adminSection = document.getElementById('adminSection');
    const adminModalidadesList = document.getElementById('adminModalidadesList');
    const novaModalidade = document.getElementById('novaModalidade');
    const addModalidade = document.getElementById('addModalidade');
    const limiteModalidades = document.getElementById('limiteModalidades');
    const salvarLimite = document.getElementById('salvarLimite');

    const adminList = document.getElementById('adminList');
    const exportCSV = document.getElementById('exportCSV');

    const selectJogadorA = document.getElementById('selectJogadorA');
    const selectJogadorB = document.getElementById('selectJogadorB');
    const dataConfronto = document.getElementById('dataConfronto');
    const placarConfronto = document.getElementById('placarConfronto');
    const addConfrontoBtn = document.getElementById('addConfronto');
    const adminConfrontos = document.getElementById('adminConfrontos');
    const refreshAdmin = document.getElementById('refreshAdmin');

    // state
    let limiteEscolha = 2;
    let inscritosCache = []; // manter cache para uso ADM e selects
    let modalidadesCache = [];

    // toggle inscri√ß√£o
    toggleButton.addEventListener('click', () => {
      formSection.classList.toggle('hidden', false);
      listSection.classList.toggle('hidden', true);
      followSection.classList.add('hidden');
      adminSection.classList.add('hidden');
      toggleButton.textContent = 'Nova Inscri√ß√£o';
    });

    cancelBtn.addEventListener('click', () => {
      registrationForm.reset();
      formSection.classList.add('hidden');
      listSection.classList.remove('hidden');
    });

    // acompanhar campeonato (p√∫blico)
    followBtn.addEventListener('click', () => {
      followSection.classList.toggle('hidden', false);
      formSection.classList.add('hidden');
      listSection.classList.add('hidden');
      adminSection.classList.add('hidden');
    });

    // admin login
    adminButton.addEventListener('click', async () => {
      const senha = prompt('Digite a senha do administrador:');
      if (senha === 'dpsp123') {
        adminSection.classList.toggle('hidden', false);
        formSection.classList.add('hidden');
        listSection.classList.add('hidden');
        followSection.classList.add('hidden');
        await carregarModalidades();
        await carregarLimite();
        carregarInscritosParaADM();
        carregarConfrontosADM();
      } else if (senha !== null) {
        alert('Senha incorreta.');
      }
    });

    // ======= MODALIDADES =======
    async function carregarModalidades() {
      modalidadesList.innerHTML = '';
      adminModalidadesList.innerHTML = '';
      modalidadesCache = [];

      const snap = await getDocs(collection(db, 'modalidades'));
      snap.forEach(d => {
        const nome = d.id; // usamos id do doc como nome (compat com seu setup)
        modalidadesCache.push(nome);

        // checkbox para inscri√ß√£o
        const label = document.createElement('label');
        label.className = 'flex items-center gap-2';
        label.innerHTML = `<input type="checkbox" value="${nome}"> <span>${nome}</span>`;
        modalidadesList.appendChild(label);

        // admin list item
        const div = document.createElement('div');
        div.className = 'flex justify-between items-center border p-2 rounded';
        div.innerHTML = `<span>${nome}</span><button class="text-red-600">üóëÔ∏è</button>`;
        div.querySelector('button').addEventListener('click', async () => {
          if (!confirm('Excluir modalidade "' + nome + '"?')) return;
          await deleteDoc(doc(db, 'modalidades', nome));
          await carregarModalidades();
        });
        adminModalidadesList.appendChild(div);
      });

      // setup listener to limit selection on the checkboxes
      const checkboxes = modalidadesList.querySelectorAll('input[type="checkbox"]');
      checkboxes.forEach(cb => {
        cb.addEventListener('change', () => {
          const checked = [...checkboxes].filter(c => c.checked);
          if (checked.length > limiteEscolha) {
            cb.checked = false;
            alert('Voc√™ s√≥ pode escolher at√© ' + limiteEscolha + ' modalidade(s).');
          }
        });
      });

      atualizarInfoModalidade();
    }

    addModalidade.addEventListener('click', async () => {
      const nome = novaModalidade.value.trim();
      if (!nome) return;
      // cria doc com id = nome (compatibilidade com vers√µes anteriores)
      await setDoc(doc(db, 'modalidades', nome), { criado_em: new Date().toISOString() });
      novaModalidade.value = '';
      await carregarModalidades();
    });

    // ======= LIMITE =======
    async function carregarLimite() {
      const snap = await getDocs(collection(db, 'config'));
      // tentativa simples: checar doc 'limite' se existir
      const limiteDoc = await getDoc(doc(db, 'config', 'limite'));
      if (limiteDoc.exists()) {
        limiteEscolha = limiteDoc.data().valor || 2;
        limiteModalidades.value = limiteEscolha;
      } else {
        limiteEscolha = 2;
        limiteModalidades.value = '';
      }
      atualizarInfoModalidade();
    }

    salvarLimite.addEventListener('click', async () => {
      const v = parseInt(limiteModalidades.value) || 1;
      limiteEscolha = v;
      await setDoc(doc(db, 'config', 'limite'), { valor: v });
      alert('Limite salvo: ' + v);
      atualizarInfoModalidade();
    });

    function atualizarInfoModalidade() {
      modalidadeInfo.textContent = 'Voc√™ pode escolher at√© ' + limiteEscolha + ' modalidade(s).';
    }

    // ======= INSCRI√á√ÉO =======
    registrationForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const matricula = document.getElementById('matricula').value.trim();
      const nome = document.getElementById('nome').value.trim();
      const setor = document.getElementById('setor').value.trim();
      const telefone = document.getElementById('telefone').value?.trim() || '';

      const escolhidas = Array.from(modalidadesList.querySelectorAll('input:checked')).map(i => i.value);

      if (!matricula || !nome || !setor) {
        alert('Preencha todos os campos obrigat√≥rios!');
        return;
      }
      if (escolhidas.length === 0 || escolhidas.length > limiteEscolha) {
        alert('Escolha entre 1 e ' + limiteEscolha + ' modalidade(s).');
        return;
      }

      // verifica duplicidade por campo matricula (compat√≠vel com registros antigos)
      const qMat = query(collection(db, 'inscritos'), where('matricula', '==', matricula));
      const snapshot = await getDocs(qMat);
      if (!snapshot.empty) {
        alert('Essa matr√≠cula j√° est√° cadastrada!');
        return;
      }

      try {
        // usa addDoc (n√£o sobrescreve docs existentes). grava criado_em como serverTimestamp
        await addDoc(collection(db, 'inscritos'), {
          matricula,
          nome,
          setor,
          telefone,
          modalidades: escolhidas,
          criado_em: serverTimestamp()
        });
        alert('Inscri√ß√£o realizada com sucesso!');
        registrationForm.reset();
        await carregarModalidades();
        formSection.classList.add('hidden');
        listSection.classList.remove('hidden');
      } catch (err) {
        console.error('Erro ao salvar inscri√ß√£o', err);
        alert('Erro ao salvar inscri√ß√£o. Veja console.');
      }
    });

    // ======= LISTA P√öBLICA DE INSCRITOS =======
    const qInscritos = query(collection(db, 'inscritos'), orderBy('criado_em', 'desc'));
    onSnapshot(qInscritos, (snap) => {
      loadingMessage.classList.add('hidden');
      participantList.innerHTML = '';
      inscritosCache = [];
      if (snap.empty) {
        participantList.innerHTML = '<p class="text-sm text-gray-500">Nenhum participante ainda.</p>';
        return;
      }
      snap.forEach(docSnap => {
        const data = docSnap.data();
        inscritosCache.push({ id: docSnap.id, ...data });
        const wrapper = document.createElement('div');
        wrapper.className = 'p-3 border rounded flex justify-between items-center';
        wrapper.innerHTML = `
          <div>
            <div class="font-medium">${escapeHtml(data.nome)}</div>
            <div class="text-sm text-gray-500">${escapeHtml(data.setor)}</div>
            <div class="text-xs text-blue-600">Modalidades: ${Array.isArray(data.modalidades) ? escapeHtml(data.modalidades.join(', ')) : ''}</div>
          </div>
        `;
        participantList.appendChild(wrapper);
      });
      // atualizar selects ADM a cada altera√ß√£o
      preencherSelectsComInscritos();
    });

    // ======= ADMIN: lista completa + export CSV + delete =======
    function carregarInscritosParaADM() {
      adminList.innerHTML = '';
      inscritosCache.forEach(e => {
        const div = document.createElement('div');
        div.className = 'p-2 border rounded flex justify-between items-center';
        div.innerHTML = `
          <div>
            <div class="font-medium">${escapeHtml(e.nome)}</div>
            <div class="text-sm">Matr√≠cula: ${escapeHtml(e.matricula || '')}</div>
            <div class="text-sm">Setor: ${escapeHtml(e.setor || '')}</div>
            <div class="text-sm">Telefone: ${escapeHtml(e.telefone || '')}</div>
            <div class="text-xs text-blue-600">Modalidades: ${Array.isArray(e.modalidades) ? escapeHtml(e.modalidades.join(' / ')) : ''}</div>
          </div>
          <div class="flex flex-col items-end gap-2">
            <button class="bg-red-600 hover:bg-red-700 text-white px-2 py-1 rounded" data-id="${e.id}">Excluir</button>
          </div>
        `;
        div.querySelector('button').addEventListener('click', async () => {
          const senha = prompt('Digite a senha para excluir:');
          if (senha === 'dpsp123') {
            await deleteDoc(doc(db, 'inscritos', e.id));
          } else if (senha !== null) {
            alert('Senha incorreta.');
          }
        });
        adminList.appendChild(div);
      });
    }

    exportCSV.addEventListener('click', () => {
      if (!inscritosCache.length) { alert('Nenhum inscrito para exportar'); return; }
      let csv = 'Matr√≠cula,Nome,Setor,Telefone,Modalidades,Data_Criacao\n';
      inscritosCache.forEach(e => {
        const created = e.criado_em && e.criado_em.toDate ? e.criado_em.toDate().toLocaleString('pt-BR') : (e.criado_em || '');
        csv += `"${(e.matricula||'')}" ,"${(e.nome||'')}" ,"${(e.setor||'')}" ,"${(e.telefone||'')}" ,"${(Array.isArray(e.modalidades)? e.modalidades.join(' | '): '')}" ,"${created}"\n`;
      });
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'inscritos.csv';
      a.click();
    });

    // ======= CONFRONTOS =======
    // grava confronto com refer√™ncias: idJogadorA, idJogadorB, nomeA, nomeB, data, placar, status
    addConfrontoBtn.addEventListener('click', async () => {
      const idA = selectJogadorA.value;
      const idB = selectJogadorB.value;
      const dataStr = dataConfronto.value;
      const placar = placarConfronto.value.trim();

      if (!idA || !idB) { alert('Escolha os dois jogadores'); return; }
      if (idA === idB) { alert('Escolha jogadores diferentes'); return; }

      // pegar nomes a partir do cache
      const jogadorA = inscritosCache.find(x => x.id === idA);
      const jogadorB = inscritosCache.find(x => x.id === idB);
      if (!jogadorA || !jogadorB) { alert('Jogador n√£o encontrado'); return; }

      try {
        await addDoc(collection(db, 'confrontos'), {
          idA, idB,
          nomeA: jogadorA.nome, nomeB: jogadorB.nome,
          data: dataStr || null,
          placar: placar || null,
          status: placar ? 'Finalizado' : 'Pendente',
          criado_em: serverTimestamp()
        });
        alert('Confronto salvo!');
        dataConfronto.value = '';
        placarConfronto.value = '';
        carregarConfrontosADM();
      } catch (err) {
        console.error(err);
        alert('Erro ao salvar confronto');
      }
    });

    // lista p√∫blica de confrontos
    const qConfrontos = query(collection(db, 'confrontos'), orderBy('criado_em', 'desc'));
    onSnapshot(qConfrontos, (snap) => {
      confrontosList.innerHTML = '';
      if (snap.empty) {
        confrontosList.innerHTML = '<p class="text-sm text-gray-500">Nenhum confronto cadastrado.</p>';
        return;
      }
      snap.forEach(docSnap => {
        const c = docSnap.data();
        const dateText = c.data ? c.data : 'Data indefinida';
        const statusText = c.status || 'Pendente';
        const placarText = c.placar ? ` ‚Äî Placar: ${c.placar}` : '';
        const div = document.createElement('div');
        div.className = 'p-3 border rounded';
        div.innerHTML = `<div class="font-medium">${escapeHtml(c.nomeA)} x ${escapeHtml(c.nomeB)}</div>
                         <div class="text-sm text-gray-600">${escapeHtml(dateText)} ‚Äî ${escapeHtml(statusText)}${placarText}</div>`;
        confrontosList.appendChild(div);
      });
    });

    // admin: listar confrontos e permitir edi√ß√£o simples (apagar / editar placar)
    async function carregarConfrontosADM() {
      adminConfrontos.innerHTML = '';
      const snap = await getDocs(query(collection(db, 'confrontos'), orderBy('criado_em', 'desc')));
      if (snap.empty) {
        adminConfrontos.innerHTML = '<p class="text-sm text-gray-500">Nenhum confronto cadastrado.</p>';
        return;
      }
      snap.forEach(docSnap => {
        const id = docSnap.id;
        const c = docSnap.data();
        const div = document.createElement('div');
        div.className = 'p-2 border rounded flex flex-col gap-2';
        div.innerHTML = `
          <div class="flex justify-between items-center">
            <div>
              <div class="font-medium">${escapeHtml(c.nomeA)} x ${escapeHtml(c.nomeB)}</div>
              <div class="text-sm text-gray-600">${escapeHtml(c.data || 'Data indefinida')}</div>
            </div>
            <div class="flex gap-2">
              <input data-id="${id}" class="placarInput p-1 border rounded" placeholder="placar (ex: 3x2)" value="${c.placar || ''}" />
              <button data-id="${id}" class="savePlacBtn bg-green-600 text-white px-2 py-1 rounded">Salvar</button>
              <button data-id="${id}" class="delConfBtn bg-red-600 text-white px-2 py-1 rounded">Excluir</button>
            </div>
          </div>
        `;
        // salvar placar
        div.querySelector('.savePlacBtn').addEventListener('click', async (ev) => {
          const idLocal = ev.currentTarget.dataset.id;
          const input = div.querySelector('.placarInput');
          const newPlacar = input.value.trim();
          try {
            await setDoc(doc(db, 'confrontos', idLocal), {
              ...c,
              placar: newPlacar || null,
              status: newPlacar ? 'Finalizado' : 'Pendente',
              criado_em: c.criado_em || serverTimestamp()
            });
            alert('Placar atualizado');
            carregarConfrontosADM();
          } catch (err) {
            console.error(err);
            alert('Erro ao atualizar placar');
          }
        });
        // excluir confronto
        div.querySelector('.delConfBtn').addEventListener('click', async (ev) => {
          const idLocal = ev.currentTarget.dataset.id;
          if (!confirm('Excluir confronto?')) return;
          try {
            await deleteDoc(doc(db, 'confrontos', idLocal));
            carregarConfrontosADM();
          } catch (err) {
            console.error(err);
            alert('Erro ao excluir confronto');
          }
        });

        adminConfrontos.appendChild(div);
      });
    }

    // preenche selects de jogador no ADM (com inscritosCache)
    function preencherSelectsComInscritos() {
      // limpar e preencher selects
      [selectJogadorA, selectJogadorB].forEach(s => {
        s.innerHTML = '<option value="">Escolha</option>';
      });
      inscritosCache.forEach(p => {
        const opt = `<option value="${p.id}">${escapeHtml(p.nome)} (${escapeHtml(p.setor || '')})</option>`;
        selectJogadorA.insertAdjacentHTML('beforeend', opt);
        selectJogadorB.insertAdjacentHTML('beforeend', opt);
      });
    }

    // atualizar ADM inscritos e selects
    function carregarInscritosParaADM() {
      carregarInscritosParaADM_once();
    }
    function carregarInscritosParaADM_once() {
      // usa cache j√° populada por onSnapshot
      carregarInscritosDOM();
      preencherSelectsComInscritos();
    }
    function carregarInscritosDOM() {
      adminList.innerHTML = '';
      inscritosCache.forEach(e => {
        const div = document.createElement('div');
        div.className = 'p-2 border rounded flex justify-between items-center';
        div.innerHTML = `
          <div>
            <div class="font-medium">${escapeHtml(e.nome)}</div>
            <div class="text-sm">Matr√≠cula: ${escapeHtml(e.matricula || '')}</div>
            <div class="text-sm">Setor: ${escapeHtml(e.setor || '')}</div>
            <div class="text-sm">Telefone: ${escapeHtml(e.telefone || '')}</div>
            <div class="text-xs text-blue-600">Modalidades: ${Array.isArray(e.modalidades) ? escapeHtml(e.modalidades.join(' / ')) : ''}</div>
          </div>
          <div class="flex flex-col items-end gap-2">
            <button class="bg-red-600 hover:bg-red-700 text-white px-2 py-1 rounded" data-id="${e.id}">Excluir</button>
          </div>
        `;
        div.querySelector('button').addEventListener('click', async () => {
          const senha = prompt('Digite a senha para excluir:');
          if (senha === 'dpsp123') {
            await deleteDoc(doc(db, 'inscritos', e.id));
          } else if (senha !== null) {
            alert('Senha incorreta.');
          }
        });
        adminList.appendChild(div);
      });
    }

    // carregar confrontos ADM (invocado manualmente)
    async function carregarConfrontosADM() {
      await carregarConfrontosADM_once();
    }
    async function carregarConfrontosADM_once() {
      adminConfrontos.innerHTML = '';
      const snap = await getDocs(query(collection(db, 'confrontos'), orderBy('criado_em', 'desc')));
      if (snap.empty) {
        adminConfrontos.innerHTML = '<p class="text-sm text-gray-500">Nenhum confronto cadastrado.</p>';
        return;
      }
      snap.forEach(docSnap => {
        const id = docSnap.id;
        const c = docSnap.data();
        const div = document.createElement('div');
        div.className = 'p-2 border rounded flex justify-between items-center gap-4';
        div.innerHTML = `
          <div>
            <div class="font-medium">${escapeHtml(c.nomeA)} x ${escapeHtml(c.nomeB)}</div>
            <div class="text-sm text-gray-600">${escapeHtml(c.data || 'Data indefinida')}</div>
            <div class="text-sm text-gray-700">Placar: ${escapeHtml(c.placar || ' - ')}</div>
            <div class="text-xs text-gray-500">Status: ${escapeHtml(c.status || 'Pendente')}</div>
          </div>
          <div class="flex flex-col gap-2">
            <button data-id="${id}" class="editConf bg-yellow-500 text-white px-2 py-1 rounded">Editar</button>
            <button data-id="${id}" class="delConf bg-red-600 text-white px-2 py-1 rounded">Excluir</button>
          </div>
        `;
        div.querySelector('.delConf').addEventListener('click', async (ev) => {
          const idLocal = ev.currentTarget.dataset.id;
          if (!confirm('Excluir confronto?')) return;
          await deleteDoc(doc(db, 'confrontos', idLocal));
          carregarConfrontosADM_once();
        });
        div.querySelector('.editConf').addEventListener('click', async (ev) => {
          const idLocal = ev.currentTarget.dataset.id;
          // simples: abre prompt para editar placar e data
          const novoPlacar = prompt('Novo placar (ex: 3x2):', c.placar || '');
          const novaData = prompt('Nova data (YYYY-MM-DD):', c.data || '');
          if (novoPlacar === null && novaData === null) return;
          // mescla e grava
          await setDoc(doc(db, 'confrontos', idLocal), {
            ...c,
            placar: novoPlacar || null,
            data: novaData || c.data || null,
            status: novoPlacar ? 'Finalizado' : (c.status || 'Pendente'),
            criado_em: c.criado_em || serverTimestamp()
          });
          carregarConfrontosADM_once();
        });
        adminConfrontos.appendChild(div);
      });
    }

    // refresh admin lists
    refreshAdmin.addEventListener('click', async () => {
      await carregarModalidades();
      carregarInscritosParaADM();
      await carregarConfrontosADM();
    });

    // helper: escape HTML (pequena prote√ß√£o XSS)
    function escapeHtml(str) {
      if (!str && str !== 0) return '';
      return String(str)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#039;');
    }

    // utility: initial load
    (async function init() {
      await carregarModalidades();
      await carregarLimite();

      // carregar inscritos & confrontos via onSnapshot (listeners already set above for inscritos & confrontos)
      // preencher selects se j√° houver inscritos
      // carregarConfrontosADM pode ser chamado quando ADM abrir painel
    })();

    // quando os inscritos mudam, atualizar ADM displays automaticamente
    // j√° feito por onSnapshot de inscritos (chama preencherSelectsComInscritos e atualiza cache)
    // por√©m precisamos expor uma chamada para preencher selects -> j√° criada: preencherSelectsComInscritos()

  </script>
</body>
</html>
