<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Campeonato - Final Corrigido</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen p-4">
  <div class="max-w-5xl mx-auto bg-white rounded-2xl shadow-lg p-6">
    <h1 class="text-2xl font-bold text-center mb-4">Campeonato - Sistema Completo üèÜ</h1>

    <div class="flex gap-2 justify-center mb-4">
      <button id="toggleButton" class="bg-green-600 text-white px-4 py-2 rounded-lg">Nova Inscri√ß√£o</button>
      <button id="adminButton" class="bg-purple-600 text-white px-4 py-2 rounded-lg">√Årea do ADM</button>
      <button id="publicButton" class="bg-sky-600 text-white px-4 py-2 rounded-lg">Painel P√∫blico</button>
    </div>

    <!-- Formul√°rio -->
    <section id="formSection" class="hidden">
      <form id="registrationForm" class="space-y-4">
        <div class="grid grid-cols-3 gap-2">
          <input type="text" id="matricula" placeholder="Matr√≠cula" class="col-span-1 p-2 border rounded-lg" required>
          <input type="text" id="nome" placeholder="Nome completo" class="col-span-1 p-2 border rounded-lg" required>
          <input type="text" id="setor" placeholder="Setor" class="col-span-1 p-2 border rounded-lg" required>
        </div>
        <input type="tel" id="telefone" placeholder="Telefone (somente ADM ver√°)" class="w-full p-2 border rounded-lg" required>
        <div>
          <p class="font-semibold mb-2">Escolha suas modalidades:</p>
          <div id="modalidadesList" class="grid grid-cols-2 gap-2"></div>
          <p id="modalidadeInfo" class="text-xs text-gray-500 mt-1"></p>
        </div>
        <button type="submit" class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg">Enviar Inscri√ß√£o</button>
      </form>
    </section>

    <!-- Lista p√∫blica simples -->
    <section id="listSection">
      <h2 class="text-xl font-semibold mb-2">Participantes inscritos</h2>
      <div id="loadingMessage" class="text-gray-500 text-sm">Carregando participantes...</div>
      <div id="participantList" class="space-y-2"></div>
    </section>

    <!-- Admin -->
    <section id="adminSection" class="hidden">
      <h2 class="text-xl font-bold mb-2">√Årea do Administrador</h2>
      <div class="grid grid-cols-3 gap-4">
        <div class="col-span-1 bg-gray-50 p-3 rounded-lg">
          <h3 class="font-semibold mb-2">Gerenciar Modalidades</h3>
          <div id="adminModalidadesList" class="space-y-1 mb-2"></div>
          <div class="flex gap-2">
            <input type="text" id="novaModalidade" placeholder="Nova modalidade" class="flex-1 p-2 border rounded-lg">
            <button id="addModalidade" class="bg-green-600 text-white px-3 py-2 rounded-lg">Adicionar</button>
          </div>

          <h3 class="font-semibold mt-4 mb-2">Configurar Limite</h3>
          <div class="flex gap-2">
            <input type="number" id="limiteModalidades" min="1" class="p-2 border rounded-lg w-20" />
            <button id="salvarLimite" class="bg-blue-600 text-white px-3 py-2 rounded-lg">Salvar</button>
          </div>
        </div>

        <div class="col-span-2 bg-gray-50 p-3 rounded-lg">
          <h3 class="font-semibold mb-2">Gerenciar Campeonato</h3>
          <div class="mt-3 flex gap-2">
            <button id="createPhaseBtn" class="bg-sky-600 text-white px-4 py-2 rounded-lg">‚ûï Criar Fase</button>
            <select id="selectModalidadeForPhase" class="p-2 border rounded-lg">
              <option value="">Escolha modalidade</option>
            </select>
            <button id="generateMatchesBtn" class="bg-red-600 text-white px-4 py-2 rounded-lg">üé≤ Gerar Sorteio</button>
          </div>

          <h3 class="mt-4 font-semibold">Fases e Confrontos</h3>
          <div id="phasesList" class="space-y-3 mt-2"></div>
        </div>
      </div>
    </section>

    <!-- Painel p√∫blico detalhado -->
    <section id="publicSection" class="hidden">
      <h2 class="text-xl font-semibold mb-2">Painel P√∫blico - Acompanha ao vivo</h2>
      <div id="publicPhases" class="space-y-4"></div>
    </section>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
    import {
      getFirestore, collection, addDoc, getDocs, query, orderBy, deleteDoc, doc, setDoc,
      getDoc, where, Timestamp
    } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";

    // ---------- FIREBASE CONFIG ----------
    const firebaseConfig = {
      apiKey: "AIzaSyBo8G3ZcWk4EepN0cHdVBtXc7tGOfcw-yg",
      authDomain: "inscricaosinuca.firebaseapp.com",
      projectId: "inscricaosinuca",
      storageBucket: "inscricaosinuca.firebasestorage.app",
      messagingSenderId: "338241576305",
      appId: "1:338241576305:web:288b6124384c6be4f76ad0",
      measurementId: "G-PEDG30FS2R"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const selectModalidadeForPhase = document.getElementById("selectModalidadeForPhase");
    const createPhaseBtn = document.getElementById("createPhaseBtn");
    const generateMatchesBtn = document.getElementById("generateMatchesBtn");

    // Criar fase
    createPhaseBtn.addEventListener("click", async () => {
      const modalidade = selectModalidadeForPhase.value;
      if (!modalidade) {
        alert("Escolha a modalidade para criar a fase.");
        return;
      }
      const qf = query(collection(db, "fases"), where("modalidade", "==", modalidade));
      const snap = await getDocs(qf);
      let maxNum = 0;
      snap.forEach(s => { if (s.data().numero > maxNum) maxNum = s.data().numero; });
      const nextNum = maxNum + 1;
      await addDoc(collection(db, "fases"), { modalidade, numero: nextNum, criado_em: Timestamp.now() });
      alert(`Fase ${nextNum} criada para ${modalidade}`);
    });

    // ‚úÖ Corrigido: Gerar confrontos para a fase correta
    generateMatchesBtn.addEventListener("click", async () => {
      const modalidade = selectModalidadeForPhase.value;
      if (!modalidade) {
        alert("Escolha a modalidade para gerar o sorteio.");
        return;
      }

      // Pega √∫ltima fase
      const qf = query(collection(db, "fases"), where("modalidade", "==", modalidade), orderBy("numero", "desc"));
      const snap = await getDocs(qf);
      if (snap.empty) {
        alert("Crie uma fase antes de gerar confrontos.");
        return;
      }
      const faseDoc = snap.docs[0];
      const faseId = faseDoc.id;
      const faseNumero = faseDoc.data().numero;

      let participantes = [];

      if (faseNumero === 1) {
        // Primeira fase -> todos inscritos
        const qIns = query(collection(db, "inscritos"), where("modalidades", "array-contains", modalidade));
        const snapIns = await getDocs(qIns);
        participantes = snapIns.docs.map(d => ({ id: d.id, nome: d.data().nome }));
      } else {
        // Demais fases -> vencedores da anterior
        const anterior = snap.docs[1];
        if (!anterior) {
          alert("N√£o foi encontrada a fase anterior.");
          return;
        }
        const qCon = query(collection(db, "confrontos"), where("faseId", "==", anterior.id));
        const snapCon = await getDocs(qCon);
        participantes = [];
        snapCon.forEach(c => {
          const data = c.data();
          if (data.vencedor) participantes.push(data.vencedor);
        });
      }

      if (participantes.length < 2) {
        alert("Participantes insuficientes para gerar confrontos.");
        return;
      }

      // embaralhar
      for (let i = participantes.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [participantes[i], participantes[j]] = [participantes[j], participantes[i]];
      }

      // criar confrontos
      for (let i = 0; i < participantes.length; i += 2) {
        const p1 = participantes[i];
        const p2 = participantes[i + 1] ?? null;
        await addDoc(collection(db, "confrontos"), {
          faseId,
          modalidade,
          jogador1: p1,
          jogador2: p2,
          pontos1: 0,
          pontos2: 0,
          vencedor: null,
          finalizado: false,
          criado_em: Timestamp.now()
        });
      }

      alert(`Confrontos da fase ${faseNumero} criados com sucesso!`);
    });
  </script>
</body>
</html>
