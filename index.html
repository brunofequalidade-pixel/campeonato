<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sistema de Campeonato (Firestore)</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen p-4">
  <div class="max-w-6xl mx-auto">
    <h1 class="text-3xl font-bold text-center mb-6">Sistema de Campeonato üèÜ</h1>

    <div class="flex flex-wrap justify-center gap-2 mb-6">
      <button id="inscricaoBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">üìù Inscri√ß√µes</button>
      <button id="publicoBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg">üë• Lista P√∫blica</button>
      <button id="adminBtn" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg">‚öôÔ∏è Admin</button>
      <button id="acompanharBtn" class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-lg">üìä Acompanhar</button>
    </div>

    <!-- Inscri√ß√£o -->
    <section id="inscricaoSection" class="bg-white p-6 rounded-lg shadow mb-6 hidden">
      <h2 class="text-xl font-bold mb-4">Nova Inscri√ß√£o</h2>
      <form id="inscricaoForm" class="space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <input type="text" id="matricula" placeholder="Matr√≠cula" class="p-2 border rounded-lg" required>
          <input type="text" id="nome" placeholder="Nome completo" class="p-2 border rounded-lg" required>
          <input type="text" id="setor" placeholder="Setor" class="p-2 border rounded-lg" required>
          <input type="tel" id="telefone" placeholder="Telefone" class="p-2 border rounded-lg" required>
        </div>
        <div>
          <p class="font-semibold mb-2">Escolha suas modalidades:</p>
          <div id="modalidadesList" class="grid grid-cols-2 gap-2"></div>
          <p id="modalidadeInfo" class="text-sm text-gray-500 mt-2"></p>
        </div>
        <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg">Enviar Inscri√ß√£o</button>
      </form>
    </section>

    <!-- Lista p√∫blica -->
    <section id="publicoSection" class="bg-white p-6 rounded-lg shadow mb-6 hidden">
      <h2 class="text-xl font-bold mb-4">Participantes Inscritos</h2>
      <div id="participantesList" class="space-y-3"></div>
    </section>

    <!-- Acompanhar -->
    <section id="acompanharSection" class="bg-white p-6 rounded-lg shadow mb-6 hidden">
      <h2 class="text-xl font-bold mb-4">Acompanhar Jogos</h2>
      <div id="jogosAcompanhar" class="space-y-4"></div>
    </section>

    <!-- Admin -->
    <section id="adminSection" class="bg-white p-6 rounded-lg shadow mb-6 hidden">
      <h2 class="text-xl font-bold mb-4">√Årea Administrativa</h2>

      <div class="flex flex-wrap gap-2 mb-4">
        <button id="configTab" class="bg-gray-600 text-white px-3 py-1 rounded">Config</button>
        <button id="fasesTab" class="bg-gray-400 text-white px-3 py-1 rounded">Fases</button>
        <button id="placaresTab" class="bg-gray-400 text-white px-3 py-1 rounded">Placares</button>
        <button id="resetTab" class="bg-gray-400 text-white px-3 py-1 rounded">Reset</button>
      </div>

      <!-- CONFIG -->
      <div id="configDiv" class="space-y-4">
        <div>
          <h3 class="font-semibold mb-2">Modalidades</h3>
          <div id="adminModalidadesList" class="space-y-2 mb-3"></div>
          <div class="flex gap-2">
            <input type="text" id="novaModalidade" placeholder="Nova modalidade" class="flex-1 p-2 border rounded">
            <button id="addModalidade" class="bg-green-600 text-white px-3 py-2 rounded">Add</button>
          </div>
        </div>

        <div>
          <h3 class="font-semibold mb-2">Limite por Participante</h3>
          <div class="flex gap-2">
            <input type="number" id="limiteInput" min="1" class="p-2 border rounded w-20">
            <button id="salvarLimite" class="bg-blue-600 text-white px-3 py-2 rounded">Salvar</button>
          </div>
        </div>

        <div>
          <button id="exportBtn" class="bg-indigo-600 text-white px-4 py-2 rounded mr-2">Exportar CSV</button>
        </div>

        <div class="overflow-x-auto">
          <table class="w-full border text-sm">
            <thead class="bg-gray-200">
              <tr>
                <th class="border p-2">Nome</th>
                <th class="border p-2">Setor</th>
                <th class="border p-2">Telefone</th>
                <th class="border p-2">Modalidades</th>
                <th class="border p-2">A√ß√µes</th>
              </tr>
            </thead>
            <tbody id="tabelaInscritos"></tbody>
          </table>
        </div>
      </div>

      <!-- FASES -->
      <div id="fasesDiv" class="hidden space-y-4">
        <div class="flex gap-2">
          <select id="modalidadeSelect" class="flex-1 p-2 border rounded">
            <option value="">Todas as Modalidades</option>
          </select>
          <button id="criarFaseBtn" class="bg-green-600 text-white px-4 py-2 rounded">Criar Fase e Jogos</button>
        </div>
        <div id="faseAtual" class="mt-4"></div>
      </div>

      <!-- PLACARES -->
      <div id="placaresDiv" class="hidden space-y-4">
        <select id="modalidadePlacar" class="w-full p-2 border rounded mb-4">
          <option value="">Selecione modalidade para ver jogos</option>
        </select>
        <div id="jogosPendentes"></div>
      </div>

      <!-- RESET -->
      <div id="resetDiv" class="hidden">
        <div class="bg-red-50 p-4 rounded border border-red-200">
          <h3 class="font-semibold text-red-800 mb-2">‚ö†Ô∏è Reset Campeonato</h3>
          <p class="text-red-700 mb-4">Apaga todas as fases e placares. Mant√©m participantes.</p>
          <button id="resetBtn" class="bg-red-600 text-white px-4 py-2 rounded">Reset Completo</button>
        </div>
      </div>
    </section>
  </div>

  <!-- Firebase SDKs + app logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore, collection, addDoc, getDocs, doc, setDoc,
      updateDoc, deleteDoc, query, where, orderBy, limit as qlimit
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // =========================
    // CONFIG FIREBASE (sua chave)
    // =========================
    const firebaseConfig = {
      apiKey: "AIzaSyBo8G3ZcWk4EepN0cHdVBtXc7tGOfcw-yg",
      authDomain: "inscricaosinuca.firebaseapp.com",
      projectId: "inscricaosinuca",
      storageBucket: "inscricaosinuca.firebasestorage.app",
      messagingSenderId: "338241576305",
      appId: "1:338241576305:web:288b6124384c6be4f76ad0",
      measurementId: "G-PEDG30FS2R"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // =========================
    // UTIL / estado local
    // =========================
    let modalidades = []; // {id, name}
    let limite = 2;

    // =========================
    // UI navega√ß√£o e tabs
    // =========================
    function showSection(section) {
      document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
      document.getElementById(section + 'Section').classList.remove('hidden');
    }

    document.getElementById('inscricaoBtn').onclick = () => { showSection('inscricao'); carregarModalidadesInscricao(); };
    document.getElementById('publicoBtn').onclick = () => { showSection('publico'); carregarListaPublica(); };
    document.getElementById('acompanharBtn').onclick = () => { showSection('acompanhar'); carregarAcompanhamento(); };
    document.getElementById('adminBtn').onclick = () => {
      const senha = prompt("Senha do administrador:");
      if (senha === "dpsp123") {
        showSection('admin');
        carregarTudoAdmin();
        showAdminTab('config');
      } else if (senha) {
        alert("Senha incorreta!");
      }
    };

    function showAdminTab(tab) {
      ['configTab','fasesTab','placaresTab','resetTab'].forEach(t => {
        document.getElementById(t).className = "bg-gray-400 text-white px-3 py-1 rounded";
      });
      ['configDiv','fasesDiv','placaresDiv','resetDiv'].forEach(d => {
        document.getElementById(d).classList.add('hidden');
      });
      document.getElementById(tab + 'Tab').className = "bg-gray-600 text-white px-3 py-1 rounded";
      document.getElementById(tab + 'Div').classList.remove('hidden');

      if (tab === 'fases') carregarModalidadesSelect();
      if (tab === 'placares') carregarPlacarSelect();
    }

    document.getElementById('configTab').onclick = () => showAdminTab('config');
    document.getElementById('fasesTab').onclick = () => showAdminTab('fases');
    document.getElementById('placaresTab').onclick = () => showAdminTab('placares');
    document.getElementById('resetTab').onclick = () => showAdminTab('reset');

    // =========================
    // CARREGAR CONFIG / MODALIDADES
    // =========================
    async function carregarConfig() {
      try {
        const cfgDoc = doc(db, "config", "main");
        const snap = await getDocs(collection(db, "config")); // fallback if doc missing
        // try direct get by doc (we'll use getDocs fallback above)
        const main = (await (await fetchConfigMain()).catch(()=>({}))) || {};
        if (main.limite) limite = main.limite;
        document.getElementById('limiteInput').value = limite;
      } catch (err) {
        console.error("carregarConfig erro:", err);
      }
    }

    // helper: attempt to read doc config/main
    async function fetchConfigMain(){
      try {
        // Using getDocs fallback earlier ‚Äì we'll try direct get via getDocs on collection and find 'main'
        const q = query(collection(db, "config"));
        const snap = await getDocs(q);
        let found = null;
        snap.forEach(d => {
          if (d.id === "main") found = { id: d.id, ...d.data() };
        });
        if (found) return found;
        // if not found, create main with default limite
        await setDoc(doc(db, "config", "main"), { limite: 2 });
        return { limite: 2 };
      } catch (err) {
        console.error(err);
        return { limite: 2 };
      }
    }

    async function carregarModalidades() {
      try {
        const snap = await getDocs(collection(db, "modalidades"));
        modalidades = [];
        snap.forEach(d => modalidades.push({ id: d.id, name: d.data().name }));
        carregarModalidadesInscricao();
        carregarModalidadesAdmin();
      } catch (err) {
        console.error("carregarModalidades", err);
      }
    }

    function carregarModalidadesInscricao() {
      const lista = document.getElementById('modalidadesList');
      lista.innerHTML = '';
      modalidades.forEach(m => {
        const label = document.createElement('label');
        label.className = 'flex items-center gap-2 p-2 border rounded cursor-pointer';
        label.innerHTML = `<input type="checkbox" value="${m.name}"> ${m.name}`;
        lista.appendChild(label);
      });
      document.getElementById('modalidadeInfo').textContent = `Escolha at√© ${limite} modalidade(s)`;
    }

    function carregarModalidadesAdmin() {
      const adminLista = document.getElementById('adminModalidadesList');
      adminLista.innerHTML = '';
      modalidades.forEach(m => {
        const div = document.createElement('div');
        div.className = 'flex justify-between items-center p-2 border rounded';
        div.innerHTML = `<span>${m.name}</span><div><button data-id="${m.id}" class="removerModalidadeBtn text-red-600 px-2">üóëÔ∏è</button></div>`;
        adminLista.appendChild(div);
      });
      // bind remove buttons
      document.querySelectorAll('.removerModalidadeBtn').forEach(btn => {
        btn.onclick = async (e) => {
          const id = e.target.dataset.id;
          if (confirm('Remover modalidade?')) {
            try {
              await deleteDoc(doc(db, "modalidades", id));
              await carregarModalidades();
            } catch (err) { alert('Erro ao remover modalidade'); console.error(err); }
          }
        };
      });
    }

    // carregar selects usados em admin fases/placares
    function carregarModalidadesSelect() {
      const select = document.getElementById('modalidadeSelect');
      select.innerHTML = '<option value="">Todas as Modalidades</option>';
      modalidades.forEach(m => select.innerHTML += `<option value="${m.name}">${m.name}</option>`);
    }
    function carregarPlacarSelect() {
      const select = document.getElementById('modalidadePlacar');
      select.innerHTML = '<option value="">Selecione modalidade</option>';
      modalidades.forEach(m => select.innerHTML += `<option value="${m.name}">${m.name}</option>`);
    }

    // =========================
    // CRUD Modalidades & Config
    // =========================
    document.getElementById('addModalidade').onclick = async () => {
      const nome = document.getElementById('novaModalidade').value.trim();
      if (!nome) return alert('Nome inv√°lido');
      try {
        // evitar duplicata
        if (modalidades.find(m => m.name.toLowerCase() === nome.toLowerCase())) {
          return alert('Modalidade j√° existe');
        }
        await addDoc(collection(db, "modalidades"), { name: nome });
        document.getElementById('novaModalidade').value = '';
        await carregarModalidades();
        alert('Modalidade adicionada!');
      } catch (err) {
        console.error(err);
        alert('Erro ao adicionar modalidade');
      }
    };

    document.getElementById('salvarLimite').onclick = async () => {
      const novo = parseInt(document.getElementById('limiteInput').value);
      if (!novo || novo < 1) return alert('Limite inv√°lido');
      try {
        limite = novo;
        await setDoc(doc(db, "config", "main"), { limite }, { merge: true });
        document.getElementById('modalidadeInfo').textContent = `Escolha at√© ${limite} modalidade(s)`;
        alert('Limite salvo!');
      } catch (err) {
        console.error(err);
        alert('Erro ao salvar limite');
      }
    };

    // =========================
    // INSCRI√á√ÉO -> salva em collection "inscritos"
    // =========================
    document.getElementById('inscricaoForm').onsubmit = async (e) => {
      e.preventDefault();
      const matricula = document.getElementById('matricula').value.trim();
      const nome = document.getElementById('nome').value.trim();
      const setor = document.getElementById('setor').value.trim();
      const telefone = document.getElementById('telefone').value.trim();
      const escolhidas = Array.from(document.querySelectorAll('#modalidadesList input:checked')).map(c => c.value);

      if (!matricula || !nome || !setor || !telefone) return alert('Preencha todos os campos!');
      if (escolhidas.length === 0 || escolhidas.length > limite) return alert(`Escolha entre 1 e ${limite} modalidades!`);

      try {
        // impedir matr√≠cula duplicada (verifica√ß√£o simples: verificar todos inscritos)
        const all = await getDocs(collection(db, "inscritos"));
        let existe = false;
        all.forEach(d => { if (d.data().matricula === matricula) existe = true; });
        if (existe) return alert('Matr√≠cula j√° inscrita!');

        await addDoc(collection(db, "inscritos"), {
          matricula, nome, setor, telefone, modalidades: escolhidas, criado: new Date().toISOString()
        });
        alert('Inscri√ß√£o realizada!');
        document.getElementById('inscricaoForm').reset();
        carregarModalidadesInscricao();
      } catch (err) {
        console.error(err);
        alert('Erro ao inscrever');
      }
    };

    // =========================
    // LISTA P√öBLICA
    // =========================
    async function carregarListaPublica() {
      try {
        const lista = document.getElementById('participantesList');
        lista.innerHTML = '';
        const snap = await getDocs(collection(db, "inscritos"));
        if (snap.empty) {
          lista.innerHTML = '<p class="text-gray-500">Nenhum participante ainda.</p>';
          return;
        }
        snap.forEach(docu => {
          const p = docu.data();
          const div = document.createElement('div');
          div.className = 'p-3 border rounded-lg';
          div.innerHTML = `
            <h3 class="font-semibold">${p.nome}</h3>
            <p class="text-gray-600">${p.setor}</p>
            <p class="text-sm text-blue-600">Modalidades: ${p.modalidades.join(', ')}</p>
          `;
          lista.appendChild(div);
        });
      } catch (err) {
        console.error(err);
      }
    }

    // =========================
    // ADMIN -> listar inscritos (com telefone) e deletar
    // =========================
    async function carregarInscritosAdmin() {
      const tabela = document.getElementById('tabelaInscritos');
      tabela.innerHTML = '';
      try {
        const snap = await getDocs(collection(db, "inscritos"));
        if (snap.empty) {
          tabela.innerHTML = '<tr><td colspan="5" class="p-2 text-gray-500">Nenhum inscrito</td></tr>';
          return;
        }
        snap.forEach(d => {
          const p = d.data();
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td class="border p-2">${p.nome}</td>
            <td class="border p-2">${p.setor}</td>
            <td class="border p-2">${p.telefone || ''}</td>
            <td class="border p-2">${(p.modalidades||[]).join(', ')}</td>
            <td class="border p-2"><button data-id="${d.id}" class="removerInscritoBtn text-red-600 px-2">üóëÔ∏è</button></td>
          `;
          tabela.appendChild(tr);
        });
        // bind delete
        document.querySelectorAll('.removerInscritoBtn').forEach(btn => {
          btn.onclick = async (e) => {
            const id = e.target.dataset.id;
            if (confirm('Remover participante?')) {
              try {
                await deleteDoc(doc(db, "inscritos", id));
                await carregarInscritosAdmin();
              } catch (err) { console.error(err); alert('Erro ao remover participante'); }
            }
          };
        });
      } catch (err) { console.error(err); }
    }

    // =========================
    // FASES & JOGOS (cole√ß√£o "fases")
    // cada documento: { modalidade, numero, confrontos: [ { id, jogador1, jogador2, placar1, placar2, finalizado } ] }
    // =========================
    document.getElementById('criarFaseBtn').onclick = async () => {
      const modalidade = document.getElementById('modalidadeSelect').value;
      if (!modalidade) return alert('Selecione uma modalidade!');
      try {
        await criarFase(modalidade);
      } catch (err) {
        console.error(err); alert('Erro ao criar fase');
      }
    };

    async function criarFase(modalidade) {
      // pegar participantes que escolheram a modalidade
      const inscritosSnap = await getDocs(collection(db, "inscritos"));
      const participantes = [];
      inscritosSnap.forEach(d => {
        const data = d.data();
        if (data.modalidades && data.modalidades.includes(modalidade)) {
          participantes.push({ id: d.id, matricula: data.matricula, nome: data.nome, setor: data.setor, telefone: data.telefone });
        }
      });
      if (participantes.length < 2) return alert('M√≠nimo 2 participantes!');
      // determinar numero da fase
      const fasesSnap = await getDocs(collection(db, "fases"));
      let maxNum = 0;
      fasesSnap.forEach(d => {
        const data = d.data();
        if (data.modalidade === modalidade && data.numero && data.numero > maxNum) maxNum = data.numero;
      });
      let numeroFase = maxNum + 1;

      // se j√° existe fase anterior e precisamos reaproveitar vencedores -> aqui simples: sempre cria nova fase com os participantes atuais
      // embaralhar
      for (let i = participantes.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [participantes[i], participantes[j]] = [participantes[j], participantes[i]];
      }
      // se √≠mpar, repetir √∫ltimo (ou sortear) -> vamos fazer sorteio de um dos perdedores do hist√≥rico: simplicidade -> duplicar √∫ltimo
      if (participantes.length % 2 === 1) {
        // duplica o √∫ltimo para completar par
        participantes.push(participantes[0]); // simplificado
      }

      const confrontos = [];
      for (let i = 0; i < participantes.length; i += 2) {
        const p1 = participantes[i];
        const p2 = participantes[i+1];
        if (!p2) continue;
        confrontos.push({
          id: `${modalidade}_${numeroFase}_${Date.now()}_${i}`,
          jogador1: p1,
          jogador2: p2,
          placar1: 0,
          placar2: 0,
          finalizado: false
        });
      }

      // salva a fase no Firestore
      await addDoc(collection(db, "fases"), {
        modalidade,
        numero: numeroFase,
        confrontos,
        criado: new Date().toISOString()
      });

      alert(`Fase ${numeroFase} criada com ${confrontos.length} confrontos!`);
      mostrarFaseAtual(modalidade);
    }

    // mostrar fase atual para uma modalidade
    async function mostrarFaseAtual(modalidade) {
      const div = document.getElementById('faseAtual');
      div.innerHTML = '';
      // pegar fases dessa modalidade e ordenar por numero desc
      const snap = await getDocs(collection(db, "fases"));
      let fases = [];
      snap.forEach(d => {
        const data = d.data();
        if (data.modalidade === modalidade) fases.push({ id: d.id, ...data });
      });
      if (fases.length === 0) {
        div.innerHTML = '<p class="text-gray-500">Nenhuma fase criada para esta modalidade.</p>';
        return;
      }
      fases.sort((a,b)=> b.numero - a.numero);
      const fase = fases[0];
      let html = `<h3 class="font-bold mb-3">Fase ${fase.numero} - ${fase.modalidade}</h3>`;
      fase.confrontos.forEach(c => {
        html += `<div class="flex justify-between items-center p-3 border rounded mb-2 ${c.finalizado ? 'bg-green-50' : 'bg-yellow-50'}">
            <span>${c.jogador1.nome} vs ${c.jogador2.nome}</span>
            <span class="${c.finalizado ? 'text-green-600' : 'text-orange-600'}">
              ${c.finalizado ? `${c.placar1} x ${c.placar2}` : 'Pendente'}
            </span>
          </div>`;
      });
      div.innerHTML = html;
    }

    document.getElementById('modalidadeSelect').onchange = (e) => {
      if (e.target.value) mostrarFaseAtual(e.target.value);
      else document.getElementById('faseAtual').innerHTML = '';
    };

    // mostrar jogos pendentes para salvar placar
    document.getElementById('modalidadePlacar').onchange = (e) => {
      mostrarJogosPendentes(e.target.value);
    };

    async function mostrarJogosPendentes(modalidade) {
      const div = document.getElementById('jogosPendentes');
      div.innerHTML = '';
      if (!modalidade) { div.innerHTML = '<p class="text-gray-500">Selecione modalidade</p>'; return; }
      // buscar ultima fase
      const snap = await getDocs(collection(db, "fases"));
      let fases = [];
      snap.forEach(d => {
        const data = d.data();
        if (data.modalidade === modalidade) fases.push({ id: d.id, ...data });
      });
      if (fases.length === 0) { div.innerHTML = '<p class="text-gray-500">Nenhuma fase encontrada.</p>'; return; }
      fases.sort((a,b)=> b.numero - a.numero);
      const fase = fases[0];
      const pendentes = fase.confrontos.filter(j => !j.finalizado);
      if (pendentes.length === 0) { div.innerHTML = '<p class="text-green-600">Todos os jogos da fase atual foram finalizados!</p>'; return; }
      pendentes.forEach(jogo => {
        const jogoDiv = document.createElement('div');
        jogoDiv.className = 'p-4 border rounded bg-gray-50 mb-3';
        jogoDiv.innerHTML = `
          <h4 class="font-semibold mb-3">${jogo.jogador1.nome} vs ${jogo.jogador2.nome}</h4>
          <div class="grid grid-cols-2 gap-4 mb-3">
            <div>
              <label class="block text-sm font-medium">${jogo.jogador1.nome}</label>
              <input type="number" min="0" max="2" value="${jogo.placar1}" class="w-full p-2 border rounded" data-jogador="1" data-jogo="${jogo.id}">
            </div>
            <div>
              <label class="block text-sm font-medium">${jogo.jogador2.nome}</label>
              <input type="number" min="0" max="2" value="${jogo.placar2}" class="w-full p-2 border rounded" data-jogador="2" data-jogo="${jogo.id}">
            </div>
          </div>
          <button class="w-full salvarPlacarBtn bg-green-600 text-white py-2 rounded hover:bg-green-700" data-modalidade="${modalidade}" data-faseid="${fase.id}" data-jogoid="${jogo.id}">Salvar Placar</button>
        `;
        div.appendChild(jogoDiv);
      });
      // bind salvar placar buttons
      document.querySelectorAll('.salvarPlacarBtn').forEach(btn => {
        btn.onclick = async (e) => {
          const faseId = e.target.dataset.faseid;
          const jogoId = e.target.dataset.jogoid;
          const modal = e.target.dataset.modalidade;
          // pegar inputs correspondentes
          const placar1Input = document.querySelector(`input[data-jogo="${jogoId}"][data-jogador="1"]`);
          const placar2Input = document.querySelector(`input[data-jogo="${jogoId}"][data-jogador="2"]`);
          const placar1 = parseInt(placar1Input.value);
          const placar2 = parseInt(placar2Input.value);
          if (isNaN(placar1) || isNaN(placar2)) return alert('Placar inv√°lido');
          if (placar1 === placar2) return alert('Deve haver um vencedor!');
          if (placar1 < 0 || placar1 > 2 || placar2 < 0 || placar2 > 2) return alert('Placar deve ser entre 0 e 2!');
          if (placar1 < 2 && placar2 < 2) return alert('Algu√©m deve fazer 2 pontos para vencer!');

          try {
            // ler fase
            const faseDocRef = doc(db, "fases", faseId);
            const snap = await getDocs(collection(db, "fases")); // workaround: we already have faseId
            // fetch doc by id: since we don't have getDoc import, we'll get all and find (we can just re-get)
            const faseSnap = await getDocs(collection(db, "fases"));
            let faseData = null; let docId = null;
            faseSnap.forEach(d => {
              if (d.id === faseId) { docId = d.id; faseData = d.data(); }
            });
            if (!faseData) return alert('Fase n√£o encontrada');
            // atualizar confronto
            const novos = faseData.confrontos.map(c => {
              if (c.id === jogoId) {
                return { ...c, placar1, placar2, finalizado: true };
              }
              return c;
            });
            await updateDoc(doc(db, "fases", faseId), { confrontos: novos });
            alert('Placar salvo!');
            mostrarJogosPendentes(modal);
            mostrarFaseAtual(modal);
            // verificar se todos finalizado
            const todosFinalizado = novos.every(j => j.finalizado);
            if (todosFinalizado) alert('Todos os jogos da fase foram finalizados! Crie a pr√≥xima fase.');
          } catch (err) {
            console.error(err); alert('Erro ao salvar placar');
          }
        };
      });
    }

    // =========================
    // ACOMPANHAR (mostra todas modalidades e fases)
    // =========================
    async function carregarAcompanhamento() {
      const div = document.getElementById('jogosAcompanhar');
      div.innerHTML = '';
      try {
        const fasesSnap = await getDocs(collection(db, "fases"));
        if (fasesSnap.empty) { div.innerHTML = '<p class="text-gray-500">Nenhum jogo ainda. Crie uma fase na √°rea de Admin.</p>'; return; }
        // agrupar por modalidade
        const agrup = {};
        fasesSnap.forEach(d => {
          const data = d.data();
          if (!agrup[data.modalidade]) agrup[data.modalidade] = [];
          agrup[data.modalidade].push({ id: d.id, ...data });
        });
        Object.keys(agrup).forEach(modalidade => {
          const modalidadeDiv = document.createElement('div');
          modalidadeDiv.className = 'p-4 border rounded-lg bg-white mb-4';
          let html = `<h3 class="font-bold text-lg mb-2">üèÜ ${modalidade}</h3>`;
          const fases = agrup[modalidade].sort((a,b)=> b.numero - a.numero);
          fases.forEach(fase => {
            html += `<h4 class="font-semibold text-base mt-4 mb-2">Fase ${fase.numero}</h4>`;
            fase.confrontos.forEach(jogo => {
              if (jogo.finalizado) {
                html += `<div class="flex items-center justify-between p-2 rounded bg-green-50 text-sm mb-1">
                           <span>${jogo.jogador1.nome} vs ${jogo.jogador2.nome}</span>
                           <span class="text-green-700 font-semibold">${jogo.placar1} x ${jogo.placar2}</span>
                         </div>`;
              } else {
                html += `<div class="flex items-center justify-between p-2 rounded bg-yellow-50 text-sm mb-1">
                          <span>${jogo.jogador1.nome} vs ${jogo.jogador2.nome}</span>
                          <span class="text-orange-600 text-sm">Aguardando resultado</span>
                         </div>`;
              }
            });
          });
          modalidadeDiv.innerHTML = html;
          div.appendChild(modalidadeDiv);
        });
      } catch (err) {
        console.error(err);
      }
    }

    // =========================
    // RESET: apaga todas as fases (mant√©m inscritos)
    // =========================
    document.getElementById('resetBtn').onclick = async () => {
      if (!confirm('‚ö†Ô∏è ATEN√á√ÉO: Isto apagar√° todas as fases e confrontos e placares! Deseja continuar?')) return;
      try {
        // apagar todos documentos na cole√ß√£o "fases"
        const snap = await getDocs(collection(db, "fases"));
        const promises = [];
        snap.forEach(d => promises.push(deleteDoc(doc(db, "fases", d.id))));
        await Promise.all(promises);
        // opcional: apagar cole√ß√£o "jogos" se existir (n√£o usada aqui)
        alert('‚úÖ Campeonato resetado com sucesso!');
        // limpar UI
        document.getElementById('faseAtual').innerHTML = '';
        document.getElementById('jogosPendentes').innerHTML = '';
        document.getElementById('jogosAcompanhar').innerHTML = '';
      } catch (err) {
        console.error(err);
        alert('Erro ao resetar campeonato');
      }
    };

    // =========================
    // EXPORT CSV (inscritos)
    // =========================
    document.getElementById('exportBtn').onclick = async () => {
      try {
        const snap = await getDocs(collection(db, "inscritos"));
        if (snap.empty) return alert('Nenhum inscrito!');
        let csv = 'Nome,Setor,Telefone,Modalidades\n';
        snap.forEach(d => {
          const p = d.data();
          csv += `"${p.nome}","${p.setor}","${p.telefone || ''}","${(p.modalidades||[]).join(' | ')}"\n`;
        });
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'inscritos.csv';
        a.click();
      } catch (err) {
        console.error(err);
        alert('Erro ao exportar');
      }
    };

    // =========================
    // ROTINA PARA CARREGAR TUDO NO ADMIN / INICIAL
    // =========================
    async function carregarTudoAdmin() {
      await carregarConfig();
      await carregarModalidades();
      await carregarInscritosAdmin();
      carregarModalidadesSelect();
      carregarPlacarSelect();
    }

    // fun√ß√£o auxiliar para carregar inicialmente
    async function inicializar() {
      await fetchConfigMain(); // garante config/main existe
      await carregarModalidades();
      showSection('inscricao');
    }

    // carregar UI inicial
    window.onload = () => {
      inicializar();
    };

    // Pequeno polimento: quando abrir a aba admin, recarregar inscritos e modalidades
    document.getElementById('adminBtn').addEventListener('click', () => {
      // handled earlier
    });

  </script>
</body>
</html>
