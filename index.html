<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bolão Mega da Virada 2025</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        /* Estilos personalizados para os destaques */
        .sena-bg { background-color: #dcfce7; border: 2px solid #16a34a; } /* Verde Forte */
        .quina-bg { background-color: #fef9c3; border: 2px solid #ca8a04; } /* Amarelo */
        .quadra-bg { background-color: #dbeafe; border: 2px solid #2563eb; } /* Azul */
        .hit-number { background-color: #16a34a; color: white; font-weight: bold; } /* Número acertado */
    </style>
</head>
<body class="bg-gray-100 min-h-screen text-gray-800 pb-20">

    <nav class="bg-green-700 text-white p-4 shadow-lg sticky top-0 z-50">
        <div class="container mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
            <h1 class="text-2xl font-bold flex items-center gap-2">
                <i class="fas fa-clover"></i> Bolão da Virada
            </h1>
            
            <div class="relative w-full md:w-1/2">
                <input type="text" id="searchInput" placeholder="Pesquisar dezenas (ex: 05 12 33)..." 
                    class="w-full p-2 pl-10 rounded text-gray-800 focus:outline-none focus:ring-2 focus:ring-green-400">
                <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
            </div>

            <button onclick="toggleAdminPanel()" class="text-xs bg-green-800 hover:bg-green-600 px-3 py-1 rounded">
                Admin
            </button>
        </div>
    </nav>

    <div class="container mx-auto mt-6 px-4">
        <div class="bg-white p-4 rounded-lg shadow-md grid grid-cols-3 gap-2 text-center">
            <div class="p-2 bg-green-100 rounded border border-green-500">
                <div class="text-xs text-green-800 font-bold uppercase">Sena (6)</div>
                <div id="countSena" class="text-2xl font-bold text-green-700">0</div>
            </div>
            <div class="p-2 bg-yellow-100 rounded border border-yellow-500">
                <div class="text-xs text-yellow-800 font-bold uppercase">Quina (5)</div>
                <div id="countQuina" class="text-2xl font-bold text-yellow-700">0</div>
            </div>
            <div class="p-2 bg-blue-100 rounded border border-blue-500">
                <div class="text-xs text-blue-800 font-bold uppercase">Quadra (4)</div>
                <div id="countQuadra" class="text-2xl font-bold text-blue-700">0</div>
            </div>
        </div>
    </div>

    <div id="adminPanel" class="hidden container mx-auto mt-6 px-4">
        <div class="bg-gray-200 p-6 rounded-lg shadow-inner border border-gray-300">
            <h2 class="text-lg font-bold mb-4 flex items-center gap-2"><i class="fas fa-cog"></i> Painel do Organizador</h2>
            
            <div class="mb-6">
                <label class="block text-sm font-bold mb-2">Resultado do Sorteio (separado por espaço):</label>
                <div class="flex gap-2">
                    <input type="text" id="drawInput" placeholder="Ex: 04 15 22 35 48 59" class="flex-1 p-2 rounded border">
                    <button onclick="saveDrawResult()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                        Salvar Resultado
                    </button>
                </div>
            </div>

            <hr class="border-gray-400 my-4">

            <div>
                <label class="block text-sm font-bold mb-2">Importar Planilha (.xlsx):</label>
                <input type="file" id="fileInput" accept=".xlsx" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-50 file:text-green-700 hover:file:bg-green-100"/>
                <p class="text-xs text-gray-500 mt-1">Col A: Nome | Col B: Cartela 1 | Col C: Cartela 2</p>
            </div>
        </div>
    </div>

    <div class="container mx-auto mt-6 px-4">
        <div id="loading" class="text-center py-10 text-gray-500">
            <i class="fas fa-spinner fa-spin fa-2x"></i>
            <p class="mt-2">Carregando bolão...</p>
        </div>
        
        <div id="betsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, doc, setDoc, onSnapshot, writeBatch, deleteDoc } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- Configuração do Firebase ---
        const firebaseConfig = {
            apiKey: "AIzaSyBo8G3ZcWk4EepN0cHdVBtXc7tGOfcw-yg",
            authDomain: "inscricaosinuca.firebaseapp.com",
            projectId: "inscricaosinuca",
            storageBucket: "inscricaosinuca.firebasestorage.app",
            messagingSenderId: "338241576305",
            appId: "1:338241576305:web:288b6124384c6be4f76ad0",
            measurementId: "G-PEDG30FS2R"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Variáveis de Estado
        let allParticipants = [];
        let currentDraw = [];

        // --- Funções de UI ---
        window.toggleAdminPanel = () => {
            const panel = document.getElementById('adminPanel');
            panel.classList.toggle('hidden');
        };

        // --- Funções Auxiliares ---
        function parseNumbers(input) {
            if (!input) return [];
            // Remove caracteres não numéricos exceto espaço e vírgula
            const clean = input.toString().replace(/[^0-9\s,]/g, '');
            // Divide, converte para número, filtra válidos e ordena
            const nums = clean.split(/[\s,]+/)
                .map(n => parseInt(n, 10))
                .filter(n => !isNaN(n) && n > 0 && n <= 60)
                .sort((a, b) => a - b);
            
            // Remove duplicatas
            return [...new Set(nums)];
        }

        function formatNumber(n) {
            return n.toString().padStart(2, '0');
        }

        // --- Lógica do Excel ---
        document.getElementById('fileInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            if(!confirm("Isso apagará os dados atuais e importará a nova planilha. Confirmar?")) {
                e.target.value = ''; // Reset
                return;
            }

            const reader = new FileReader();
            reader.onload = async (evt) => {
                const data = new Uint8Array(evt.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const rows = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

                // Limpar banco atual (simples: deletar coleção 'participants')
                // Nota: Em produção, usar delete collection é mais complexo, aqui faremos um loop simples
                const snap = await getDocs(collection(db, "participants"));
                const batchDel = writeBatch(db);
                snap.forEach(doc => batchDel.delete(doc.ref));
                await batchDel.commit();

                // Processar e Inserir Novos
                const batchAdd = writeBatch(db);
                let count = 0;

                // Começa do index 0 ou 1 dependendo se tem cabeçalho. Assumindo sem cabeçalho ou tratando erro.
                rows.forEach((row) => {
                    if (!row[0]) return; // Nome vazio

                    const nome = row[0];
                    const cartela1 = parseNumbers(row[1]);
                    const cartela2 = parseNumbers(row[2]);

                    if (cartela1.length === 6) {
                        const ref = doc(collection(db, "participants"));
                        batchAdd.set(ref, {
                            name: nome,
                            bets: [cartela1, cartela2].filter(c => c.length === 6) // Salva apenas cartelas validas
                        });
                        count++;
                    }
                });

                await batchAdd.commit();
                alert(`${count} participantes importados com sucesso!`);
                e.target.value = '';
            };
            reader.readAsArrayBuffer(file);
        });

        // --- Lógica do Resultado (Admin) ---
        window.saveDrawResult = async () => {
            const input = document.getElementById('drawInput').value;
            const nums = parseNumbers(input);
            
            if (nums.length !== 6) {
                alert("Por favor, insira exatamente 6 dezenas válidas.");
                return;
            }

            await setDoc(doc(db, "settings", "drawResult"), { numbers: nums });
            alert("Resultado atualizado!");
        };

        // --- Listeners do Firestore (Tempo Real) ---
        
        // 1. Ouvir o Resultado do Sorteio
        onSnapshot(doc(db, "settings", "drawResult"), (docSnap) => {
            if (docSnap.exists()) {
                currentDraw = docSnap.data().numbers || [];
                document.getElementById('drawInput').value = currentDraw.join(' ');
            } else {
                currentDraw = [];
            }
            renderApp(); // Re-renderiza quando o sorteio muda
        });

        // 2. Ouvir os Participantes
        onSnapshot(collection(db, "participants"), (querySnapshot) => {
            allParticipants = [];
            querySnapshot.forEach((doc) => {
                allParticipants.push(doc.data());
            });
            document.getElementById('loading').style.display = 'none';
            renderApp();
        });

        // --- Renderização e Filtro ---
        const searchInput = document.getElementById('searchInput');
        searchInput.addEventListener('input', renderApp);

        function renderApp() {
            const container = document.getElementById('betsList');
            container.innerHTML = '';

            const searchTerms = parseNumbers(searchInput.value);
            
            let stats = { sena: 0, quina: 0, quadra: 0 };

            // Filtragem
            const filtered = allParticipants.filter(p => {
                if (searchTerms.length === 0) return true;
                // Verifica se ALGUMA das cartelas do participante tem TODOS os numeros pesquisados
                return p.bets.some(bet => 
                    searchTerms.every(term => bet.includes(term))
                );
            });

            // Ordenação (quem está ganhando aparece primeiro)
            filtered.sort((a, b) => {
                const maxHitsA = Math.max(...a.bets.map(bet => getHits(bet).length));
                const maxHitsB = Math.max(...b.bets.map(bet => getHits(bet).length));
                return maxHitsB - maxHitsA; // Decrescente
            });

            filtered.forEach(p => {
                let pMaxHits = 0;

                const betsHtml = p.bets.map((bet, index) => {
                    const hits = getHits(bet);
                    const hitCount = hits.length;
                    
                    if (hitCount > pMaxHits) pMaxHits = hitCount;
                    
                    // Contabilizar estatísticas globais (apenas uma vez por cartela)
                    if (hitCount === 6) stats.sena++;
                    else if (hitCount === 5) stats.quina++;
                    else if (hitCount === 4) stats.quadra++;

                    // Estilo da cartela
                    let cardClass = "bg-gray-50 border border-gray-200";
                    let badge = "";
                    
                    if (hitCount === 6) { cardClass = "sena-bg"; badge = '<span class="text-xs bg-green-600 text-white px-2 py-0.5 rounded ml-2">SENA!</span>'; }
                    else if (hitCount === 5) { cardClass = "quina-bg"; badge = '<span class="text-xs bg-yellow-600 text-white px-2 py-0.5 rounded ml-2">QUINA</span>'; }
                    else if (hitCount === 4) { cardClass = "quadra-bg"; badge = '<span class="text-xs bg-blue-600 text-white px-2 py-0.5 rounded ml-2">QUADRA</span>'; }

                    // Renderizar números
                    const numbersHtml = bet.map(num => {
                        const isHit = currentDraw.includes(num);
                        const isSearched = searchTerms.includes(num);
                        
                        let numClass = "w-8 h-8 flex items-center justify-center rounded-full text-sm font-medium ";
                        if (isHit) numClass += "hit-number ";
                        else if (isSearched) numClass += "bg-green-200 text-green-800 border border-green-400 "; // Destaque da busca
                        else numClass += "bg-white text-gray-600 border border-gray-300 ";

                        return `<div class="${numClass}">${formatNumber(num)}</div>`;
                    }).join('');

                    return `
                        <div class="p-3 rounded-md mb-2 ${cardClass}">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-xs font-bold text-gray-500 uppercase">Cartela ${index + 1}</span>
                                <div class="flex items-center">
                                    <span class="text-xs font-bold text-gray-600 mr-1">${hitCount} acertos</span>
                                    ${badge}
                                </div>
                            </div>
                            <div class="flex flex-wrap gap-2 justify-center">${numbersHtml}</div>
                        </div>
                    `;
                }).join('');

                const card = document.createElement('div');
                card.className = "bg-white rounded-lg shadow p-4 hover:shadow-lg transition-shadow duration-200";
                card.innerHTML = `
                    <h3 class="font-bold text-lg mb-3 text-gray-800 border-b pb-2 flex justify-between">
                        ${p.name}
                        ${pMaxHits >= 4 ? '<i class="fas fa-trophy text-yellow-500"></i>' : ''}
                    </h3>
                    ${betsHtml}
                `;
                container.appendChild(card);
            });

            // Atualizar Placar
            document.getElementById('countSena').textContent = stats.sena;
            document.getElementById('countQuina').textContent = stats.quina;
            document.getElementById('countQuadra').textContent = stats.quadra;
        }

        function getHits(betArray) {
            return betArray.filter(num => currentDraw.includes(num));
        }

    </script>
</body>
</html>
